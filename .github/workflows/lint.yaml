name: Lint Changed Files

on:
  workflow_call:
    inputs:
      changed-files-data:
        required: true
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TEST_RUNNER_PYTHON_VERSION: 3.10.12

jobs:
  filter-files:
    runs-on: ubuntu-latest
    outputs:
      changed-python-files: ${{ steps.filter-files.outputs.changed-python-files }}
      changed-js-files: ${{ steps.filter-files.outputs.changed-js-files }}
      changed-yaml-files: ${{ steps.filter-files.outputs.changed-yaml-files }}
    steps:
      - name: Filter changed files
        id: filter-files
        run: |
          CHANGED_FILES_JSON='${{ inputs.changed-files-data }}'

          # Use jq to extract file paths based on extension and debug each step
          CHANGED_PY_FILES=$(echo "$CHANGED_FILES_JSON" | jq -r '.[] | select(.extension == "py") | .file')
          CHANGED_JS_FILES=$(echo "$CHANGED_FILES_JSON" | jq -r '.[] | select(.extension == "js" or .extension == "jsx") | .file')
          CHANGED_YAML_FILES=$(echo "$CHANGED_FILES_JSON" | jq -r '.[] | select(.extension == "yaml" or .extension == "yml") | .file')

          # debput outputs
          echo "changed-python-files: $CHANGED_PY_FILES"
          echo "changed-js-files: $CHANGED_JS_FILES"
          echo "changed-yaml-files: $CHANGED_YAML_FILES"

          # set these json blobs as outputs
          echo "changed-python-files=$CHANGED_PY_FILES" >> $GITHUB_OUTPUT
          echo "changed-js-files=$CHANGED_JS_FILES" >> $GITHUB_OUTPUT
          echo "changed-yaml-files=$CHANGED_YAML_FILES" >> $GITHUB_OUTPUT

  python-lint:
    needs: filter-files
    if: ${{ needs.filter-files.outputs.changed-python-files != '' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: ${{ env.TEST_RUNNER_PYTHON_VERSION }}
      - name: Install dependencies
        run: |
          pip install -U pip
          pip install black flake8
      - name: Lint changed Python files
        run: |
          python_files="${{ needs.filter-files.outputs.changed-python-files }}"
          for file in $python_files; do
            black --check $file
            flake8 $file
          done

  javascript-lint:
    needs: filter-files
    if: ${{ needs.filter-files.outputs.changed-js-files != '' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: "18"
      - name: Install dependencies
        run: |
          npm ci
      - name: Lint changed JavaScript files
        run: |
          js_files="${{ needs.filter-files.outputs.changed-js-files }}"
          for file in $js_files; do
            npm run lint -- $file
          done

  yaml-lint:
    needs: filter-files
    if: ${{ needs.filter-files.outputs.changed-yaml-files != '' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Install YAML Linter
        run: sudo apt-get install yamllint
      - name: Lint changed YAML files
        run: |
          yaml_files="${{ needs.filter-files.outputs.changed-yaml-files }}"
          for file in $yaml_files; do
            yamllint $file
          done
