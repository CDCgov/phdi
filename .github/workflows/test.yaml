name: Test
on:
  workflow_dispatch:
  pull_request:
    branches:
      - "**"
  push:
    branches:
      - main

env:
  TEST_RUNNER_PYTHON_VERSION: 3.9

jobs:
  unit-test-phdi-building-blocks-lib:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup python ${{env.TEST_RUNNER_PYTHON_VERSION}}
        uses: actions/setup-python@v2
        with:
          python-version: ${{env.TEST_RUNNER_PYTHON_VERSION}}
          cache: pip
      - name: Install poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "${HOME}/.poetry/bin" >> $GITHUB_PATH
      - name: Install dependencies
        run: poetry install
      - name: Run pytest with code coverage output
        run: poetry run pytest --cov-report xml --cov=phdi tests/
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          flags: unit-tests


  code-check-python:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup python ${{env.TEST_RUNNER_PYTHON_VERSION}}
        uses: actions/setup-python@v2
        with:
          python-version: ${{env.TEST_RUNNER_PYTHON_VERSION}}
          cache: pip
      - name: Install dependencies
        run: |
          pip install -U pip
          pip install black flake8
      - name: Check format (black)
        run: |
          black --check --verbose .
      - name: Check style (flake8)
        run: |
          flake8

  ensure-clean-notebooks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Check notebook cleanliness
        uses: ResearchSoftwareActions/EnsureCleanNotebooksAction@1.1
  
  build-sphinx-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Generate Sphinx docs
        run: |
          sphinx-apidoc -o _source phdi
      - name: Generate HTML versions of Sphinx docs
        run: |
          poetry run make html
      - name: Get version of project
        run: |
          $pypi_version="$(toml get --toml-path pyproject.toml tool.poetry.version)"
      - name: Rework for semantic version
        run: |
          $semantic_version="v$($pypi_version.Substring(0,5))-$($pypi_version.Substring(6,3))"
      - name: Rename html folder to semantic version
        run: |
          Rename-Item -Path ".\docs\html" -NewName $semantic_version