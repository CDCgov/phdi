
<!DOCTYPE html>

<html lang="English">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>phdi.utils &#8212; Public Health Data Infrastructure (PHDI) 0.1.0-dev documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for phdi.utils</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">urllib3</span> <span class="kn">import</span> <span class="n">Retry</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">requests.adapters</span> <span class="kn">import</span> <span class="n">HTTPAdapter</span>
<span class="kn">import</span> <span class="nn">logging</span>


<div class="viewcode-block" id="find_resource_by_type"><a class="viewcode-back" href="../../docs/sphinx/_source/phdi.html#phdi.utils.find_resource_by_type">[docs]</a><span class="k">def</span> <span class="nf">find_resource_by_type</span><span class="p">(</span><span class="n">bundle</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">resource_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Collect all resources of a specific type in a bundle of FHIR data and</span>
<span class="sd">    return references to them in a list.</span>

<span class="sd">    :param bundle: The FHIR bundle to find patients in</span>
<span class="sd">    :param resource_type: The type of FHIR resource to find</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">resource</span>
        <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">bundle</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entry&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resource&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resourceType&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">resource_type</span>
    <span class="p">]</span></div>


<div class="viewcode-block" id="get_one_line_address"><a class="viewcode-back" href="../../docs/sphinx/_source/phdi.html#phdi.utils.get_one_line_address">[docs]</a><span class="k">def</span> <span class="nf">get_one_line_address</span><span class="p">(</span><span class="n">address</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract a one-line string representation of an address from a</span>
<span class="sd">    JSON dictionary holding address information.</span>

<span class="sd">    :param address: The address bundle</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">raw_one_line</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">address</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="n">raw_one_line</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">address</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;city&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">address</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;postalCode&quot;</span> <span class="ow">in</span> <span class="n">address</span> <span class="ow">and</span> <span class="n">address</span><span class="p">[</span><span class="s2">&quot;postalCode&quot;</span><span class="p">]:</span>
        <span class="n">raw_one_line</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">address</span><span class="p">[</span><span class="s1">&#39;postalCode&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">raw_one_line</span></div>


<div class="viewcode-block" id="get_field"><a class="viewcode-back" href="../../docs/sphinx/_source/phdi.html#phdi.utils.get_field">[docs]</a><span class="k">def</span> <span class="nf">get_field</span><span class="p">(</span><span class="n">resource</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">use</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default_field</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For a given field (such as name or address), find the first-occuring</span>
<span class="sd">    instance of the field in a given patient JSON dict, such that the</span>
<span class="sd">    instance is associated with a particular &quot;use&quot; case of the field (use</span>
<span class="sd">    case here refers to the FHIR-based usage of classifying how a</span>
<span class="sd">    value is used in reporting). For example, find the first name for a</span>
<span class="sd">    patient that has a &quot;use&quot; of &quot;official&quot; (meaning the name is used</span>
<span class="sd">    for official reports). If no instance of a field with the requested</span>
<span class="sd">    use case can be found, instead return a specified default field.</span>

<span class="sd">    :param resource: Resource from a FHIR bundle</span>
<span class="sd">    :param field: The field to extract</span>
<span class="sd">    :param use: The use the field must have to qualify</span>
<span class="sd">    :param default_field: The index of the field type to treat as</span>
<span class="sd">        the default return type if no field with the requested use case is</span>
<span class="sd">        found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO Determine if we need to implement .get() to ensure KeyErrors are not thrown</span>
    <span class="c1"># or if we want the KeyError functionality and thus just need to document that</span>
    <span class="c1"># behavior.</span>

    <span class="c1"># The next function returns the &quot;next&quot; (in our case first) item from an</span>
    <span class="c1"># iterator that meets a given condition; if non exist, we index the</span>
    <span class="c1"># field for a default value</span>
    <span class="k">return</span> <span class="nb">next</span><span class="p">(</span>
        <span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">resource</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">use</span><span class="p">),</span>
        <span class="n">resource</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">default_field</span><span class="p">],</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="standardize_text"><a class="viewcode-back" href="../../docs/sphinx/_source/phdi.html#phdi.utils.standardize_text">[docs]</a><span class="k">def</span> <span class="nf">standardize_text</span><span class="p">(</span><span class="n">raw_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform standardization on a provided text string, given a set of transformations.</span>

<span class="sd">    :param raw_text: The raw text string to standardize</span>
<span class="sd">    :param ``**kwargs``: A series of transformations that should be applied to the text</span>
<span class="sd">        string. Only recognized transformations will be utilized; all other specified</span>
<span class="sd">        transformations will be ignore. The recognized transformations are as follows:</span>
<span class="sd">        - trim (Bool): Indicates if leading and trailing whitespace should be removed.</span>
<span class="sd">        - case (Literal[&quot;upper&quot;, &quot;lower&quot;, &quot;title&quot;]): Defines what casing should be</span>
<span class="sd">        applied to the string.</span>
<span class="sd">        - remove_numbers (Bool): Indicates if numbers should removed from the string.</span>
<span class="sd">        - remove_punctuation (Bool): Indicates if characters that are not letters,</span>
<span class="sd">        numbers, nor spaces should be removed.</span>
<span class="sd">        - remove_characters (List[str]): Provides a list of characters that should be</span>
<span class="sd">        removed from the string.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># A certain order of operations needs to be imposed in order to make the output</span>
    <span class="c1"># deterministic, and as close to the user&#39;s intent as possible. While it may see</span>
    <span class="c1"># at first glance that this code could be cleaned up with a creative for loop,</span>
    <span class="c1"># the current understanding is that the fact that Python doesn&#39;t maintain the order</span>
    <span class="c1"># of keys in dictionaries, there&#39;s no easy to way to ensure that transformations are</span>
    <span class="c1"># processed in the appropriate way. An example of where this becomes an issue is</span>
    <span class="c1"># when the user makes the following call:</span>
    <span class="c1">#     standardize_text(&quot; 123 hi 456 &quot;, trim=True, remove_numbers=True)</span>
    <span class="c1"># Because dictionaries and kwargs are unordered in Python prior to version 3.6, the</span>
    <span class="c1"># outcome could either be &quot;hi&quot; or &quot; hi &quot;, depending on if numbers are removed prior</span>
    <span class="c1"># to stripping the string or not. As of Python 3.6, the order of **kwargs is</span>
    <span class="c1"># preserved, but we can&#39;t assume that the user will pass the parameters in the</span>
    <span class="c1"># proper order. All of this is to say that a series of if statements appears to be</span>
    <span class="c1"># the most straightforward means by which we can ensure that the transformations are</span>
    <span class="c1"># applied in the appropriate order.</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">raw_text</span>

    <span class="k">if</span> <span class="s2">&quot;remove_numbers&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ltr</span> <span class="k">for</span> <span class="n">ltr</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">ltr</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">()])</span>
    <span class="k">if</span> <span class="s2">&quot;remove_punctuation&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ltr</span> <span class="k">for</span> <span class="n">ltr</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">if</span> <span class="n">ltr</span><span class="o">.</span><span class="n">isalnum</span><span class="p">()</span> <span class="ow">or</span> <span class="n">ltr</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s2">&quot;remove_characters&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ltr</span> <span class="k">for</span> <span class="n">ltr</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">if</span> <span class="n">ltr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;remove_characters&quot;</span><span class="p">]])</span>
    <span class="k">if</span> <span class="s2">&quot;trim&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="s2">&quot;case&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;upper&quot;</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;lower&quot;</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">text</span></div>


<div class="viewcode-block" id="http_request_with_retry"><a class="viewcode-back" href="../../docs/sphinx/_source/phdi.html#phdi.utils.http_request_with_retry">[docs]</a><span class="k">def</span> <span class="nf">http_request_with_retry</span><span class="p">(</span>
    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">retry_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">request_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">allowed_methods</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">headers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Carryout an HTTP Request using a specific retry strategy. Essentially</span>
<span class="sd">    a wrapper function around the retry strategy implementation of a</span>
<span class="sd">    mounted HTTP request.</span>
<span class="sd">    :param url: The url at which to make the HTTP request</span>
<span class="sd">    :param retry_count: The number of times to re-try the request, if the</span>
<span class="sd">    first attempt fails</span>
<span class="sd">    :param request_type: The type of request to be made. Currently supports</span>
<span class="sd">    GET and POST.</span>
<span class="sd">    :param allowed_methods: The list of allowed HTTP request methods (i.e.</span>
<span class="sd">    POST, PUT, etc.) for the specific URL and query</span>
<span class="sd">    :param headers: JSON-type dictionary of headers to make the request with,</span>
<span class="sd">    including Authorization and content-type</span>
<span class="sd">    :param data: JSON data in the case that the request requires data to be</span>
<span class="sd">    posted. Defaults to none.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Configure the settings of the &#39;requests&#39; session we&#39;ll make</span>
    <span class="c1"># the API call with</span>
    <span class="n">retry_strategy</span> <span class="o">=</span> <span class="n">Retry</span><span class="p">(</span>
        <span class="n">total</span><span class="o">=</span><span class="n">retry_count</span><span class="p">,</span>
        <span class="n">status_forcelist</span><span class="o">=</span><span class="p">[</span><span class="mi">429</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">503</span><span class="p">,</span> <span class="mi">504</span><span class="p">],</span>
        <span class="n">allowed_methods</span><span class="o">=</span><span class="n">allowed_methods</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">adapter</span> <span class="o">=</span> <span class="n">HTTPAdapter</span><span class="p">(</span><span class="n">max_retries</span><span class="o">=</span><span class="n">retry_strategy</span><span class="p">)</span>
    <span class="n">http</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="n">http</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s2">&quot;https://&quot;</span><span class="p">,</span> <span class="n">adapter</span><span class="p">)</span>

    <span class="c1"># Now, actually try to complete the API request</span>
    <span class="k">if</span> <span class="n">request_type</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;POST request to &quot;</span> <span class="o">+</span> <span class="n">url</span> <span class="o">+</span> <span class="s2">&quot; failed for data: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span>
    <span class="k">elif</span> <span class="n">request_type</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;GET request to &quot;</span> <span class="o">+</span> <span class="n">url</span> <span class="o">+</span> <span class="s2">&quot; failed.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Public Health Data Infrastructure (PHDI)</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, PHDI Team and Contributors.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.5.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>