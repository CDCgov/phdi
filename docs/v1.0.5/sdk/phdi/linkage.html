<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 13.1.0"/>
    <title>phdi.linkage API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../phdi.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;phdi</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="variable" href="#DIBBS_BASIC">DIBBS_BASIC</a>
            </li>
            <li>
                    <a class="variable" href="#DIBBS_ENHANCED">DIBBS_ENHANCED</a>
            </li>
            <li>
                    <a class="function" href="#generate_hash_str">generate_hash_str</a>
            </li>
            <li>
                    <a class="function" href="#block_data">block_data</a>
            </li>
            <li>
                    <a class="function" href="#match_within_block">match_within_block</a>
            </li>
            <li>
                    <a class="function" href="#feature_match_exact">feature_match_exact</a>
            </li>
            <li>
                    <a class="function" href="#feature_match_fuzzy_string">feature_match_fuzzy_string</a>
            </li>
            <li>
                    <a class="function" href="#eval_perfect_match">eval_perfect_match</a>
            </li>
            <li>
                    <a class="function" href="#compile_match_lists">compile_match_lists</a>
            </li>
            <li>
                    <a class="function" href="#feature_match_four_char">feature_match_four_char</a>
            </li>
            <li>
                    <a class="function" href="#perform_linkage_pass">perform_linkage_pass</a>
            </li>
            <li>
                    <a class="function" href="#score_linkage_vs_truth">score_linkage_vs_truth</a>
            </li>
            <li>
                    <a class="function" href="#block_data_from_db">block_data_from_db</a>
            </li>
            <li>
                    <a class="function" href="#_generate_block_query">_generate_block_query</a>
            </li>
            <li>
                    <a class="function" href="#calculate_m_probs">calculate_m_probs</a>
            </li>
            <li>
                    <a class="function" href="#calculate_u_probs">calculate_u_probs</a>
            </li>
            <li>
                    <a class="function" href="#load_json_probs">load_json_probs</a>
            </li>
            <li>
                    <a class="function" href="#calculate_log_odds">calculate_log_odds</a>
            </li>
            <li>
                    <a class="function" href="#feature_match_log_odds_exact">feature_match_log_odds_exact</a>
            </li>
            <li>
                    <a class="function" href="#feature_match_log_odds_fuzzy_compare">feature_match_log_odds_fuzzy_compare</a>
            </li>
            <li>
                    <a class="function" href="#profile_log_odds">profile_log_odds</a>
            </li>
            <li>
                    <a class="function" href="#eval_log_odds_cutoff">eval_log_odds_cutoff</a>
            </li>
            <li>
                    <a class="class" href="#BaseMPIConnectorClient">BaseMPIConnectorClient</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#BaseMPIConnectorClient.block_data">block_data</a>
                        </li>
                        <li>
                                <a class="function" href="#BaseMPIConnectorClient.get_connection">get_connection</a>
                        </li>
                        <li>
                                <a class="function" href="#BaseMPIConnectorClient.insert_match_patient">insert_match_patient</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#extract_blocking_values_from_record">extract_blocking_values_from_record</a>
            </li>
            <li>
                    <a class="function" href="#write_linkage_config">write_linkage_config</a>
            </li>
            <li>
                    <a class="function" href="#read_linkage_config">read_linkage_config</a>
            </li>
            <li>
                    <a class="class" href="#DIBBsConnectorClient">DIBBsConnectorClient</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#DIBBsConnectorClient.__init__">DIBBsConnectorClient</a>
                        </li>
                        <li>
                                <a class="function" href="#DIBBsConnectorClient.get_connection">get_connection</a>
                        </li>
                        <li>
                                <a class="function" href="#DIBBsConnectorClient.block_data">block_data</a>
                        </li>
                        <li>
                                <a class="function" href="#DIBBsConnectorClient.insert_match_patient">insert_match_patient</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#link_record_against_mpi">link_record_against_mpi</a>
            </li>
            <li>
                    <a class="function" href="#add_person_resource">add_person_resource</a>
            </li>
            <li>
                    <a class="variable" href="#_compare_address_elements">_compare_address_elements</a>
            </li>
            <li>
                    <a class="variable" href="#_compare_name_elements">_compare_name_elements</a>
            </li>
            <li>
                    <a class="function" href="#convert_to_patient_fhir_resources">convert_to_patient_fhir_resources</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../phdi.html">phdi</a><wbr>.linkage    </h1>

                
                        <input id="mod-linkage-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-linkage-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos"> 1</span></a><span class="kn">from</span> <span class="nn">phdi.linkage.algorithms</span> <span class="kn">import</span> <span class="n">DIBBS_BASIC</span><span class="p">,</span> <span class="n">DIBBS_ENHANCED</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos"> 2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos"> 3</span></a><span class="kn">from</span> <span class="nn">phdi.linkage.link</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos"> 4</span></a>    <span class="n">generate_hash_str</span><span class="p">,</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos"> 5</span></a>    <span class="n">block_data</span><span class="p">,</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos"> 6</span></a>    <span class="n">match_within_block</span><span class="p">,</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos"> 7</span></a>    <span class="n">feature_match_exact</span><span class="p">,</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos"> 8</span></a>    <span class="n">feature_match_fuzzy_string</span><span class="p">,</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos"> 9</span></a>    <span class="n">eval_perfect_match</span><span class="p">,</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">10</span></a>    <span class="n">compile_match_lists</span><span class="p">,</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">11</span></a>    <span class="n">feature_match_four_char</span><span class="p">,</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">12</span></a>    <span class="n">perform_linkage_pass</span><span class="p">,</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">13</span></a>    <span class="n">score_linkage_vs_truth</span><span class="p">,</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">14</span></a>    <span class="n">block_data_from_db</span><span class="p">,</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">15</span></a>    <span class="n">_generate_block_query</span><span class="p">,</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">16</span></a>    <span class="n">calculate_m_probs</span><span class="p">,</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">17</span></a>    <span class="n">calculate_u_probs</span><span class="p">,</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">18</span></a>    <span class="n">load_json_probs</span><span class="p">,</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">19</span></a>    <span class="n">calculate_log_odds</span><span class="p">,</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">20</span></a>    <span class="n">feature_match_log_odds_exact</span><span class="p">,</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">21</span></a>    <span class="n">feature_match_log_odds_fuzzy_compare</span><span class="p">,</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">22</span></a>    <span class="n">profile_log_odds</span><span class="p">,</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">23</span></a>    <span class="n">eval_log_odds_cutoff</span><span class="p">,</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">24</span></a>    <span class="n">extract_blocking_values_from_record</span><span class="p">,</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">25</span></a>    <span class="n">write_linkage_config</span><span class="p">,</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">26</span></a>    <span class="n">read_linkage_config</span><span class="p">,</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">27</span></a>    <span class="n">link_record_against_mpi</span><span class="p">,</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">28</span></a>    <span class="n">add_person_resource</span><span class="p">,</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">29</span></a><span class="p">)</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">30</span></a>
</span><span id="L-31"><a href="#L-31"><span class="linenos">31</span></a><span class="kn">from</span> <span class="nn">phdi.linkage.core</span> <span class="kn">import</span> <span class="n">BaseMPIConnectorClient</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">32</span></a><span class="kn">from</span> <span class="nn">phdi.linkage.postgres</span> <span class="kn">import</span> <span class="n">DIBBsConnectorClient</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">33</span></a><span class="kn">from</span> <span class="nn">phdi.linkage.seed</span> <span class="kn">import</span> <span class="n">convert_to_patient_fhir_resources</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">34</span></a>
</span><span id="L-35"><a href="#L-35"><span class="linenos">35</span></a>
</span><span id="L-36"><a href="#L-36"><span class="linenos">36</span></a><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">37</span></a>    <span class="s2">&quot;DIBBS_BASIC&quot;</span><span class="p">,</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">38</span></a>    <span class="s2">&quot;DIBBS_ENHANCED&quot;</span><span class="p">,</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">39</span></a>    <span class="s2">&quot;generate_hash_str&quot;</span><span class="p">,</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">40</span></a>    <span class="s2">&quot;block_data&quot;</span><span class="p">,</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">41</span></a>    <span class="s2">&quot;match_within_block&quot;</span><span class="p">,</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">42</span></a>    <span class="s2">&quot;feature_match_exact&quot;</span><span class="p">,</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">43</span></a>    <span class="s2">&quot;feature_match_fuzzy_string&quot;</span><span class="p">,</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">44</span></a>    <span class="s2">&quot;eval_perfect_match&quot;</span><span class="p">,</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">45</span></a>    <span class="s2">&quot;compile_match_lists&quot;</span><span class="p">,</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">46</span></a>    <span class="s2">&quot;feature_match_four_char&quot;</span><span class="p">,</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">47</span></a>    <span class="s2">&quot;perform_linkage_pass&quot;</span><span class="p">,</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">48</span></a>    <span class="s2">&quot;score_linkage_vs_truth&quot;</span><span class="p">,</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">49</span></a>    <span class="s2">&quot;block_data_from_db&quot;</span><span class="p">,</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">50</span></a>    <span class="s2">&quot;_generate_block_query&quot;</span><span class="p">,</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">51</span></a>    <span class="s2">&quot;calculate_m_probs&quot;</span><span class="p">,</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">52</span></a>    <span class="s2">&quot;calculate_u_probs&quot;</span><span class="p">,</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">53</span></a>    <span class="s2">&quot;load_json_probs&quot;</span><span class="p">,</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">54</span></a>    <span class="s2">&quot;calculate_log_odds&quot;</span><span class="p">,</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">55</span></a>    <span class="s2">&quot;feature_match_log_odds_exact&quot;</span><span class="p">,</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">56</span></a>    <span class="s2">&quot;feature_match_log_odds_fuzzy_compare&quot;</span><span class="p">,</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">57</span></a>    <span class="s2">&quot;profile_log_odds&quot;</span><span class="p">,</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">58</span></a>    <span class="s2">&quot;eval_log_odds_cutoff&quot;</span><span class="p">,</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">59</span></a>    <span class="s2">&quot;BaseMPIConnectorClient&quot;</span><span class="p">,</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">60</span></a>    <span class="s2">&quot;extract_blocking_values_from_record&quot;</span><span class="p">,</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">61</span></a>    <span class="s2">&quot;write_linkage_config&quot;</span><span class="p">,</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">62</span></a>    <span class="s2">&quot;read_linkage_config&quot;</span><span class="p">,</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">63</span></a>    <span class="s2">&quot;DIBBsConnectorClient&quot;</span><span class="p">,</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">64</span></a>    <span class="s2">&quot;link_record_against_mpi&quot;</span><span class="p">,</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">65</span></a>    <span class="s2">&quot;add_person_resource&quot;</span><span class="p">,</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">66</span></a>    <span class="s2">&quot;_compare_address_elements&quot;</span><span class="p">,</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">67</span></a>    <span class="s2">&quot;_compare_name_elements&quot;</span><span class="p">,</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">68</span></a>    <span class="s2">&quot;convert_to_patient_fhir_resources&quot;</span><span class="p">,</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">69</span></a><span class="p">]</span>
</span></pre></div>


            </section>
                <section id="DIBBS_BASIC">
                    <div class="attr variable">
            <span class="name">DIBBS_BASIC</span>        =
<input id="DIBBS_BASIC-view-value" class="view-value-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
            <label class="view-value-button pdoc-button" for="DIBBS_BASIC-view-value"></label><span class="default_value">[{&#39;funcs&#39;: {1: &#39;feature_match_fuzzy_string&#39;, 3: &#39;feature_match_fuzzy_string&#39;, 4: &#39;feature_match_fuzzy_string&#39;}, &#39;blocks&#39;: [{&#39;value&#39;: &#39;mrn&#39;, &#39;transformation&#39;: &#39;last4&#39;}, {&#39;value&#39;: &#39;address&#39;, &#39;transformation&#39;: &#39;first4&#39;}], &#39;matching_rule&#39;: &#39;eval_perfect_match&#39;, &#39;cluster_ratio&#39;: 0.9}, {&#39;funcs&#39;: {0: &#39;feature_match_fuzzy_string&#39;, 2: &#39;feature_match_fuzzy_string&#39;}, &#39;blocks&#39;: [{&#39;value&#39;: &#39;first_name&#39;, &#39;transformation&#39;: &#39;first4&#39;}, {&#39;value&#39;: &#39;last_name&#39;, &#39;transformation&#39;: &#39;first4&#39;}], &#39;matching_rule&#39;: &#39;eval_perfect_match&#39;, &#39;cluster_ratio&#39;: 0.9}]</span>

        
    </div>
    <a class="headerlink" href="#DIBBS_BASIC"></a>
    
    

                </section>
                <section id="DIBBS_ENHANCED">
                    <div class="attr variable">
            <span class="name">DIBBS_ENHANCED</span>        =
<input id="DIBBS_ENHANCED-view-value" class="view-value-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
            <label class="view-value-button pdoc-button" for="DIBBS_ENHANCED-view-value"></label><span class="default_value">[{&#39;funcs&#39;: {1: &#39;feature_match_log_odds_fuzzy_compare&#39;, 3: &#39;feature_match_log_odds_fuzzy_compare&#39;, 4: &#39;feature_match_log_odds_fuzzy_compare&#39;}, &#39;blocks&#39;: [{&#39;value&#39;: &#39;mrn&#39;, &#39;transformation&#39;: &#39;last4&#39;}, {&#39;value&#39;: &#39;address&#39;, &#39;transformation&#39;: &#39;first4&#39;}], &#39;matching_rule&#39;: &#39;eval_log_odds_cutoff&#39;, &#39;cluster_ratio&#39;: 0.9, &#39;kwargs&#39;: {&#39;similarity_measure&#39;: &#39;JaroWinkler&#39;, &#39;threshold&#39;: 0.7, &#39;true_match_threshold&#39;: 16.5}}, {&#39;funcs&#39;: {0: &#39;feature_match_log_odds_fuzzy_compare&#39;, 2: &#39;feature_match_log_odds_fuzzy_compare&#39;}, &#39;blocks&#39;: [{&#39;value&#39;: &#39;first_name&#39;, &#39;transformation&#39;: &#39;first4&#39;}, {&#39;value&#39;: &#39;last_name&#39;, &#39;transformation&#39;: &#39;first4&#39;}], &#39;matching_rule&#39;: &#39;eval_log_odds_cutoff&#39;, &#39;cluster_ratio&#39;: 0.9, &#39;kwargs&#39;: {&#39;similarity_measure&#39;: &#39;JaroWinkler&#39;, &#39;threshold&#39;: 0.7, &#39;true_match_threshold&#39;: 7.0}}]</span>

        
    </div>
    <a class="headerlink" href="#DIBBS_ENHANCED"></a>
    
    

                </section>
                <section id="generate_hash_str">
                            <input id="generate_hash_str-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_hash_str</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">linking_identifier</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">salt_str</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="generate_hash_str-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#generate_hash_str"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="generate_hash_str-529"><a href="#generate_hash_str-529"><span class="linenos">529</span></a><span class="k">def</span> <span class="nf">generate_hash_str</span><span class="p">(</span><span class="n">linking_identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">salt_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="generate_hash_str-530"><a href="#generate_hash_str-530"><span class="linenos">530</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="generate_hash_str-531"><a href="#generate_hash_str-531"><span class="linenos">531</span></a><span class="sd">    Generates a hash for a given string of concatenated patient information. The hash</span>
</span><span id="generate_hash_str-532"><a href="#generate_hash_str-532"><span class="linenos">532</span></a><span class="sd">    serves as a &quot;unique&quot; identifier for the patient.</span>
</span><span id="generate_hash_str-533"><a href="#generate_hash_str-533"><span class="linenos">533</span></a>
</span><span id="generate_hash_str-534"><a href="#generate_hash_str-534"><span class="linenos">534</span></a><span class="sd">    :param linking_identifier: The value to be hashed.  For example, the concatenation</span>
</span><span id="generate_hash_str-535"><a href="#generate_hash_str-535"><span class="linenos">535</span></a><span class="sd">      of a patient&#39;s name, address, and date of birth, delimited by dashes.</span>
</span><span id="generate_hash_str-536"><a href="#generate_hash_str-536"><span class="linenos">536</span></a><span class="sd">    :param salt_str: The salt to use with the hash. This is intended to prevent</span>
</span><span id="generate_hash_str-537"><a href="#generate_hash_str-537"><span class="linenos">537</span></a><span class="sd">      reverse engineering of the PII used to create the hash.</span>
</span><span id="generate_hash_str-538"><a href="#generate_hash_str-538"><span class="linenos">538</span></a><span class="sd">    :return: The hash of the linking_identifier string.</span>
</span><span id="generate_hash_str-539"><a href="#generate_hash_str-539"><span class="linenos">539</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="generate_hash_str-540"><a href="#generate_hash_str-540"><span class="linenos">540</span></a>    <span class="n">hash_obj</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">()</span>
</span><span id="generate_hash_str-541"><a href="#generate_hash_str-541"><span class="linenos">541</span></a>    <span class="n">to_encode</span> <span class="o">=</span> <span class="p">(</span><span class="n">linking_identifier</span> <span class="o">+</span> <span class="n">salt_str</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
</span><span id="generate_hash_str-542"><a href="#generate_hash_str-542"><span class="linenos">542</span></a>    <span class="n">hash_obj</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">to_encode</span><span class="p">)</span>
</span><span id="generate_hash_str-543"><a href="#generate_hash_str-543"><span class="linenos">543</span></a>    <span class="k">return</span> <span class="n">hash_obj</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Generates a hash for a given string of concatenated patient information. The hash
serves as a "unique" identifier for the patient.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>linking_identifier</strong>:  The value to be hashed.  For example, the concatenation
of a patient's name, address, and date of birth, delimited by dashes.</li>
<li><strong>salt_str</strong>:  The salt to use with the hash. This is intended to prevent
reverse engineering of the PII used to create the hash.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>The hash of the linking_identifier string.</p>
</blockquote>
</div>


                </section>
                <section id="block_data">
                            <input id="block_data-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">block_data</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">data</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>, </span><span class="param"><span class="n">blocks</span><span class="p">:</span> <span class="n">List</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="block_data-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#block_data"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="block_data-32"><a href="#block_data-32"><span class="linenos">32</span></a><span class="k">def</span> <span class="nf">block_data</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">blocks</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="block_data-33"><a href="#block_data-33"><span class="linenos">33</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="block_data-34"><a href="#block_data-34"><span class="linenos">34</span></a><span class="sd">    Generates dictionary of blocked data where each key is a block</span>
</span><span id="block_data-35"><a href="#block_data-35"><span class="linenos">35</span></a><span class="sd">    and each value is a distinct list of lists containing the data</span>
</span><span id="block_data-36"><a href="#block_data-36"><span class="linenos">36</span></a><span class="sd">    for a given block.</span>
</span><span id="block_data-37"><a href="#block_data-37"><span class="linenos">37</span></a>
</span><span id="block_data-38"><a href="#block_data-38"><span class="linenos">38</span></a><span class="sd">    :param data: A pandas dataframe of records to be linked.</span>
</span><span id="block_data-39"><a href="#block_data-39"><span class="linenos">39</span></a><span class="sd">    :param blocks: List of columns to be used in blocks.</span>
</span><span id="block_data-40"><a href="#block_data-40"><span class="linenos">40</span></a><span class="sd">    :return: A dictionary of with the keys as the blocks and the</span>
</span><span id="block_data-41"><a href="#block_data-41"><span class="linenos">41</span></a><span class="sd">      values as the data within each block, stored as a list of</span>
</span><span id="block_data-42"><a href="#block_data-42"><span class="linenos">42</span></a><span class="sd">      lists.</span>
</span><span id="block_data-43"><a href="#block_data-43"><span class="linenos">43</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="block_data-44"><a href="#block_data-44"><span class="linenos">44</span></a>    <span class="n">blocked_data_tuples</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">blocks</span><span class="p">))</span>
</span><span id="block_data-45"><a href="#block_data-45"><span class="linenos">45</span></a>
</span><span id="block_data-46"><a href="#block_data-46"><span class="linenos">46</span></a>    <span class="c1"># Convert data to list of lists within dict</span>
</span><span id="block_data-47"><a href="#block_data-47"><span class="linenos">47</span></a>    <span class="n">blocked_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="block_data-48"><a href="#block_data-48"><span class="linenos">48</span></a>    <span class="k">for</span> <span class="n">block</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">blocked_data_tuples</span><span class="p">:</span>
</span><span id="block_data-49"><a href="#block_data-49"><span class="linenos">49</span></a>        <span class="n">blocked_data</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="block_data-50"><a href="#block_data-50"><span class="linenos">50</span></a>
</span><span id="block_data-51"><a href="#block_data-51"><span class="linenos">51</span></a>    <span class="k">return</span> <span class="n">blocked_data</span>
</span></pre></div>


            <div class="docstring"><p>Generates dictionary of blocked data where each key is a block
and each value is a distinct list of lists containing the data
for a given block.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>data</strong>:  A pandas dataframe of records to be linked.</li>
<li><strong>blocks</strong>:  List of columns to be used in blocks.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>A dictionary of with the keys as the blocks and the
    values as the data within each block, stored as a list of
    lists.</p>
</blockquote>
</div>


                </section>
                <section id="match_within_block">
                            <input id="match_within_block-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">match_within_block</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">block</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">]</span>,</span><span class="param">	<span class="n">feature_funcs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">]</span>,</span><span class="param">	<span class="n">match_eval</span><span class="p">:</span> <span class="n">Callable</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="match_within_block-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#match_within_block"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="match_within_block-680"><a href="#match_within_block-680"><span class="linenos">680</span></a><span class="k">def</span> <span class="nf">match_within_block</span><span class="p">(</span>
</span><span id="match_within_block-681"><a href="#match_within_block-681"><span class="linenos">681</span></a>    <span class="n">block</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">],</span>
</span><span id="match_within_block-682"><a href="#match_within_block-682"><span class="linenos">682</span></a>    <span class="n">feature_funcs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Callable</span><span class="p">],</span>
</span><span id="match_within_block-683"><a href="#match_within_block-683"><span class="linenos">683</span></a>    <span class="n">match_eval</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
</span><span id="match_within_block-684"><a href="#match_within_block-684"><span class="linenos">684</span></a>    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="match_within_block-685"><a href="#match_within_block-685"><span class="linenos">685</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]:</span>
</span><span id="match_within_block-686"><a href="#match_within_block-686"><span class="linenos">686</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="match_within_block-687"><a href="#match_within_block-687"><span class="linenos">687</span></a><span class="sd">    Performs matching on all candidate pairs of records within a given block</span>
</span><span id="match_within_block-688"><a href="#match_within_block-688"><span class="linenos">688</span></a><span class="sd">    of data. Actual partitioning of the data should be done outside this</span>
</span><span id="match_within_block-689"><a href="#match_within_block-689"><span class="linenos">689</span></a><span class="sd">    function, as it compares all possible pairs within the provided partition.</span>
</span><span id="match_within_block-690"><a href="#match_within_block-690"><span class="linenos">690</span></a><span class="sd">    Uses a given construction of feature comparison rules as well as a</span>
</span><span id="match_within_block-691"><a href="#match_within_block-691"><span class="linenos">691</span></a><span class="sd">    match evaluation rule to determine the final verdict on whether two</span>
</span><span id="match_within_block-692"><a href="#match_within_block-692"><span class="linenos">692</span></a><span class="sd">    records are indeed a match.</span>
</span><span id="match_within_block-693"><a href="#match_within_block-693"><span class="linenos">693</span></a>
</span><span id="match_within_block-694"><a href="#match_within_block-694"><span class="linenos">694</span></a><span class="sd">    A feature function is of the form &quot;feature_match_X&quot; for some condition</span>
</span><span id="match_within_block-695"><a href="#match_within_block-695"><span class="linenos">695</span></a><span class="sd">    X; it must accept two records (lists of data), an index i in which the</span>
</span><span id="match_within_block-696"><a href="#match_within_block-696"><span class="linenos">696</span></a><span class="sd">    feature to compare is stored, and the parameter **kwargs. It must return</span>
</span><span id="match_within_block-697"><a href="#match_within_block-697"><span class="linenos">697</span></a><span class="sd">    a boolean indicating whether the features &quot;match&quot; for whatever definition</span>
</span><span id="match_within_block-698"><a href="#match_within_block-698"><span class="linenos">698</span></a><span class="sd">    of match the function uses (i.e. this allows modular logic to apply to</span>
</span><span id="match_within_block-699"><a href="#match_within_block-699"><span class="linenos">699</span></a><span class="sd">    different features in the compared records). Note that not all features</span>
</span><span id="match_within_block-700"><a href="#match_within_block-700"><span class="linenos">700</span></a><span class="sd">    in a record need a comparison function defined.</span>
</span><span id="match_within_block-701"><a href="#match_within_block-701"><span class="linenos">701</span></a>
</span><span id="match_within_block-702"><a href="#match_within_block-702"><span class="linenos">702</span></a><span class="sd">    A match evaluation rule is a function of the form &quot;eval_X&quot; for some</span>
</span><span id="match_within_block-703"><a href="#match_within_block-703"><span class="linenos">703</span></a><span class="sd">    condition X. It accepts as input a list of booleans, one for each feature</span>
</span><span id="match_within_block-704"><a href="#match_within_block-704"><span class="linenos">704</span></a><span class="sd">    that was compared with feature funcs, and determines whether the</span>
</span><span id="match_within_block-705"><a href="#match_within_block-705"><span class="linenos">705</span></a><span class="sd">    comparisons constitute a match according to X.</span>
</span><span id="match_within_block-706"><a href="#match_within_block-706"><span class="linenos">706</span></a>
</span><span id="match_within_block-707"><a href="#match_within_block-707"><span class="linenos">707</span></a><span class="sd">    :param block: A list of records to check for matches. Each record in</span>
</span><span id="match_within_block-708"><a href="#match_within_block-708"><span class="linenos">708</span></a><span class="sd">      the list is itself a list of features. The first feature of the</span>
</span><span id="match_within_block-709"><a href="#match_within_block-709"><span class="linenos">709</span></a><span class="sd">      record must be an &quot;id&quot; for the record.</span>
</span><span id="match_within_block-710"><a href="#match_within_block-710"><span class="linenos">710</span></a><span class="sd">    :param feature_funcs: A dictionary mapping feature indices to functions</span>
</span><span id="match_within_block-711"><a href="#match_within_block-711"><span class="linenos">711</span></a><span class="sd">      used to evaluate those features for a match.</span>
</span><span id="match_within_block-712"><a href="#match_within_block-712"><span class="linenos">712</span></a><span class="sd">    :param match_eval: A function for determining whether a given set of</span>
</span><span id="match_within_block-713"><a href="#match_within_block-713"><span class="linenos">713</span></a><span class="sd">      feature comparisons constitutes a match for linkage.</span>
</span><span id="match_within_block-714"><a href="#match_within_block-714"><span class="linenos">714</span></a><span class="sd">    :return: A list of 2-tuples of the form (i,j), where i,j give the indices</span>
</span><span id="match_within_block-715"><a href="#match_within_block-715"><span class="linenos">715</span></a><span class="sd">      in the block of data of records deemed to match.</span>
</span><span id="match_within_block-716"><a href="#match_within_block-716"><span class="linenos">716</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="match_within_block-717"><a href="#match_within_block-717"><span class="linenos">717</span></a>    <span class="n">match_pairs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="match_within_block-718"><a href="#match_within_block-718"><span class="linenos">718</span></a>
</span><span id="match_within_block-719"><a href="#match_within_block-719"><span class="linenos">719</span></a>    <span class="c1"># Dynamic programming table: order doesn&#39;t matter, so only need to</span>
</span><span id="match_within_block-720"><a href="#match_within_block-720"><span class="linenos">720</span></a>    <span class="c1"># check each combo of i,j once</span>
</span><span id="match_within_block-721"><a href="#match_within_block-721"><span class="linenos">721</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">record_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">block</span><span class="p">):</span>
</span><span id="match_within_block-722"><a href="#match_within_block-722"><span class="linenos">722</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="p">)):</span>
</span><span id="match_within_block-723"><a href="#match_within_block-723"><span class="linenos">723</span></a>            <span class="n">record_j</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="match_within_block-724"><a href="#match_within_block-724"><span class="linenos">724</span></a>            <span class="n">feature_comps</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="match_within_block-725"><a href="#match_within_block-725"><span class="linenos">725</span></a>                <span class="n">feature_funcs</span><span class="p">[</span><span class="n">x</span><span class="p">](</span><span class="n">record_i</span><span class="p">,</span> <span class="n">record_j</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="match_within_block-726"><a href="#match_within_block-726"><span class="linenos">726</span></a>                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">record_i</span><span class="p">))</span>
</span><span id="match_within_block-727"><a href="#match_within_block-727"><span class="linenos">727</span></a>                <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">feature_funcs</span>
</span><span id="match_within_block-728"><a href="#match_within_block-728"><span class="linenos">728</span></a>            <span class="p">]</span>
</span><span id="match_within_block-729"><a href="#match_within_block-729"><span class="linenos">729</span></a>
</span><span id="match_within_block-730"><a href="#match_within_block-730"><span class="linenos">730</span></a>            <span class="c1"># If it&#39;s a match, store the result</span>
</span><span id="match_within_block-731"><a href="#match_within_block-731"><span class="linenos">731</span></a>            <span class="n">is_match</span> <span class="o">=</span> <span class="n">match_eval</span><span class="p">(</span><span class="n">feature_comps</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="match_within_block-732"><a href="#match_within_block-732"><span class="linenos">732</span></a>            <span class="k">if</span> <span class="n">is_match</span><span class="p">:</span>
</span><span id="match_within_block-733"><a href="#match_within_block-733"><span class="linenos">733</span></a>                <span class="n">match_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
</span><span id="match_within_block-734"><a href="#match_within_block-734"><span class="linenos">734</span></a>
</span><span id="match_within_block-735"><a href="#match_within_block-735"><span class="linenos">735</span></a>    <span class="k">return</span> <span class="n">match_pairs</span>
</span></pre></div>


            <div class="docstring"><p>Performs matching on all candidate pairs of records within a given block
of data. Actual partitioning of the data should be done outside this
function, as it compares all possible pairs within the provided partition.
Uses a given construction of feature comparison rules as well as a
match evaluation rule to determine the final verdict on whether two
records are indeed a match.</p>

<p>A feature function is of the form "feature_match_X" for some condition
X; it must accept two records (lists of data), an index i in which the
feature to compare is stored, and the parameter **kwargs. It must return
a boolean indicating whether the features "match" for whatever definition
of match the function uses (i.e. this allows modular logic to apply to
different features in the compared records). Note that not all features
in a record need a comparison function defined.</p>

<p>A match evaluation rule is a function of the form "eval_X" for some
condition X. It accepts as input a list of booleans, one for each feature
that was compared with feature funcs, and determines whether the
comparisons constitute a match according to X.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>block</strong>:  A list of records to check for matches. Each record in
the list is itself a list of features. The first feature of the
record must be an "id" for the record.</li>
<li><strong>feature_funcs</strong>:  A dictionary mapping feature indices to functions
used to evaluate those features for a match.</li>
<li><strong>match_eval</strong>:  A function for determining whether a given set of
feature comparisons constitutes a match for linkage.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>A list of 2-tuples of the form (i,j), where i,j give the indices
    in the block of data of records deemed to match.</p>
</blockquote>
</div>


                </section>
                <section id="feature_match_exact">
                            <input id="feature_match_exact-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">feature_match_exact</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">record_i</span><span class="p">:</span> <span class="n">List</span>, </span><span class="param"><span class="n">record_j</span><span class="p">:</span> <span class="n">List</span>, </span><span class="param"><span class="n">feature_x</span><span class="p">:</span> <span class="nb">int</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="feature_match_exact-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#feature_match_exact"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="feature_match_exact-403"><a href="#feature_match_exact-403"><span class="linenos">403</span></a><span class="k">def</span> <span class="nf">feature_match_exact</span><span class="p">(</span>
</span><span id="feature_match_exact-404"><a href="#feature_match_exact-404"><span class="linenos">404</span></a>    <span class="n">record_i</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">record_j</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">feature_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span>
</span><span id="feature_match_exact-405"><a href="#feature_match_exact-405"><span class="linenos">405</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="feature_match_exact-406"><a href="#feature_match_exact-406"><span class="linenos">406</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="feature_match_exact-407"><a href="#feature_match_exact-407"><span class="linenos">407</span></a><span class="sd">    Determines whether a single feature in a given pair of records</span>
</span><span id="feature_match_exact-408"><a href="#feature_match_exact-408"><span class="linenos">408</span></a><span class="sd">    constitutes an exact match (perfect equality).</span>
</span><span id="feature_match_exact-409"><a href="#feature_match_exact-409"><span class="linenos">409</span></a>
</span><span id="feature_match_exact-410"><a href="#feature_match_exact-410"><span class="linenos">410</span></a><span class="sd">    :param record_i: One of the records in the candidate pair to evaluate.</span>
</span><span id="feature_match_exact-411"><a href="#feature_match_exact-411"><span class="linenos">411</span></a><span class="sd">    :param record_j: The second record in the candidate pair.</span>
</span><span id="feature_match_exact-412"><a href="#feature_match_exact-412"><span class="linenos">412</span></a><span class="sd">    :param feature_x: A number representing the index of the feature to</span>
</span><span id="feature_match_exact-413"><a href="#feature_match_exact-413"><span class="linenos">413</span></a><span class="sd">      compare for equality.</span>
</span><span id="feature_match_exact-414"><a href="#feature_match_exact-414"><span class="linenos">414</span></a><span class="sd">    :return: A boolean indicating whether the features are an exact match.</span>
</span><span id="feature_match_exact-415"><a href="#feature_match_exact-415"><span class="linenos">415</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="feature_match_exact-416"><a href="#feature_match_exact-416"><span class="linenos">416</span></a>    <span class="k">return</span> <span class="n">record_i</span><span class="p">[</span><span class="n">feature_x</span><span class="p">]</span> <span class="o">==</span> <span class="n">record_j</span><span class="p">[</span><span class="n">feature_x</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Determines whether a single feature in a given pair of records
constitutes an exact match (perfect equality).</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>record_i</strong>:  One of the records in the candidate pair to evaluate.</li>
<li><strong>record_j</strong>:  The second record in the candidate pair.</li>
<li><strong>feature_x</strong>:  A number representing the index of the feature to
compare for equality.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>A boolean indicating whether the features are an exact match.</p>
</blockquote>
</div>


                </section>
                <section id="feature_match_fuzzy_string">
                            <input id="feature_match_fuzzy_string-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">feature_match_fuzzy_string</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">record_i</span><span class="p">:</span> <span class="n">List</span>, </span><span class="param"><span class="n">record_j</span><span class="p">:</span> <span class="n">List</span>, </span><span class="param"><span class="n">feature_x</span><span class="p">:</span> <span class="nb">int</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="feature_match_fuzzy_string-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#feature_match_fuzzy_string"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="feature_match_fuzzy_string-437"><a href="#feature_match_fuzzy_string-437"><span class="linenos">437</span></a><span class="k">def</span> <span class="nf">feature_match_fuzzy_string</span><span class="p">(</span>
</span><span id="feature_match_fuzzy_string-438"><a href="#feature_match_fuzzy_string-438"><span class="linenos">438</span></a>    <span class="n">record_i</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">record_j</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">feature_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span>
</span><span id="feature_match_fuzzy_string-439"><a href="#feature_match_fuzzy_string-439"><span class="linenos">439</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="feature_match_fuzzy_string-440"><a href="#feature_match_fuzzy_string-440"><span class="linenos">440</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="feature_match_fuzzy_string-441"><a href="#feature_match_fuzzy_string-441"><span class="linenos">441</span></a><span class="sd">    Determines whether two strings in a given pair of records are close</span>
</span><span id="feature_match_fuzzy_string-442"><a href="#feature_match_fuzzy_string-442"><span class="linenos">442</span></a><span class="sd">    enough to constitute a partial match. The exact nature of the match</span>
</span><span id="feature_match_fuzzy_string-443"><a href="#feature_match_fuzzy_string-443"><span class="linenos">443</span></a><span class="sd">    is determined by the specified string comparison function (see</span>
</span><span id="feature_match_fuzzy_string-444"><a href="#feature_match_fuzzy_string-444"><span class="linenos">444</span></a><span class="sd">    harmonization/utils/compare_strings for more details) as well as a</span>
</span><span id="feature_match_fuzzy_string-445"><a href="#feature_match_fuzzy_string-445"><span class="linenos">445</span></a><span class="sd">    scoring threshold the comparison must meet or exceed.</span>
</span><span id="feature_match_fuzzy_string-446"><a href="#feature_match_fuzzy_string-446"><span class="linenos">446</span></a>
</span><span id="feature_match_fuzzy_string-447"><a href="#feature_match_fuzzy_string-447"><span class="linenos">447</span></a><span class="sd">    :param record_i: One of the records in the candidate pair to evaluate.</span>
</span><span id="feature_match_fuzzy_string-448"><a href="#feature_match_fuzzy_string-448"><span class="linenos">448</span></a><span class="sd">    :param record_j: The second record in the candidate pair.</span>
</span><span id="feature_match_fuzzy_string-449"><a href="#feature_match_fuzzy_string-449"><span class="linenos">449</span></a><span class="sd">    :param feature_x: A number representing the index of the feature to</span>
</span><span id="feature_match_fuzzy_string-450"><a href="#feature_match_fuzzy_string-450"><span class="linenos">450</span></a><span class="sd">      compare for a partial match.</span>
</span><span id="feature_match_fuzzy_string-451"><a href="#feature_match_fuzzy_string-451"><span class="linenos">451</span></a><span class="sd">    :param **kwargs: Optionally, a dictionary including specifications for</span>
</span><span id="feature_match_fuzzy_string-452"><a href="#feature_match_fuzzy_string-452"><span class="linenos">452</span></a><span class="sd">      the string comparison metric to use, as well as the cutoff score</span>
</span><span id="feature_match_fuzzy_string-453"><a href="#feature_match_fuzzy_string-453"><span class="linenos">453</span></a><span class="sd">      beyond which to classify the strings as a partial match.</span>
</span><span id="feature_match_fuzzy_string-454"><a href="#feature_match_fuzzy_string-454"><span class="linenos">454</span></a><span class="sd">    :return: A boolean indicating whether the features are a fuzzy match.</span>
</span><span id="feature_match_fuzzy_string-455"><a href="#feature_match_fuzzy_string-455"><span class="linenos">455</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="feature_match_fuzzy_string-456"><a href="#feature_match_fuzzy_string-456"><span class="linenos">456</span></a>    <span class="c1"># Special case for two empty strings, since we don&#39;t want vacuous</span>
</span><span id="feature_match_fuzzy_string-457"><a href="#feature_match_fuzzy_string-457"><span class="linenos">457</span></a>    <span class="c1"># equality (or in-) to penalize the score</span>
</span><span id="feature_match_fuzzy_string-458"><a href="#feature_match_fuzzy_string-458"><span class="linenos">458</span></a>    <span class="k">if</span> <span class="n">record_i</span><span class="p">[</span><span class="n">feature_x</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">record_j</span><span class="p">[</span><span class="n">feature_x</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="feature_match_fuzzy_string-459"><a href="#feature_match_fuzzy_string-459"><span class="linenos">459</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="feature_match_fuzzy_string-460"><a href="#feature_match_fuzzy_string-460"><span class="linenos">460</span></a>    <span class="k">if</span> <span class="n">record_i</span><span class="p">[</span><span class="n">feature_x</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">record_j</span><span class="p">[</span><span class="n">feature_x</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="feature_match_fuzzy_string-461"><a href="#feature_match_fuzzy_string-461"><span class="linenos">461</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="feature_match_fuzzy_string-462"><a href="#feature_match_fuzzy_string-462"><span class="linenos">462</span></a>
</span><span id="feature_match_fuzzy_string-463"><a href="#feature_match_fuzzy_string-463"><span class="linenos">463</span></a>    <span class="n">similarity_measure</span> <span class="o">=</span> <span class="s2">&quot;JaroWinkler&quot;</span>
</span><span id="feature_match_fuzzy_string-464"><a href="#feature_match_fuzzy_string-464"><span class="linenos">464</span></a>    <span class="k">if</span> <span class="s2">&quot;similarity_measure&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="feature_match_fuzzy_string-465"><a href="#feature_match_fuzzy_string-465"><span class="linenos">465</span></a>        <span class="n">similarity_measure</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;similarity_measure&quot;</span><span class="p">]</span>
</span><span id="feature_match_fuzzy_string-466"><a href="#feature_match_fuzzy_string-466"><span class="linenos">466</span></a>    <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.7</span>
</span><span id="feature_match_fuzzy_string-467"><a href="#feature_match_fuzzy_string-467"><span class="linenos">467</span></a>    <span class="k">if</span> <span class="s2">&quot;threshold&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="feature_match_fuzzy_string-468"><a href="#feature_match_fuzzy_string-468"><span class="linenos">468</span></a>        <span class="n">threshold</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">]</span>
</span><span id="feature_match_fuzzy_string-469"><a href="#feature_match_fuzzy_string-469"><span class="linenos">469</span></a>    <span class="n">score</span> <span class="o">=</span> <span class="n">compare_strings</span><span class="p">(</span>
</span><span id="feature_match_fuzzy_string-470"><a href="#feature_match_fuzzy_string-470"><span class="linenos">470</span></a>        <span class="n">record_i</span><span class="p">[</span><span class="n">feature_x</span><span class="p">],</span> <span class="n">record_j</span><span class="p">[</span><span class="n">feature_x</span><span class="p">],</span> <span class="n">similarity_measure</span>
</span><span id="feature_match_fuzzy_string-471"><a href="#feature_match_fuzzy_string-471"><span class="linenos">471</span></a>    <span class="p">)</span>
</span><span id="feature_match_fuzzy_string-472"><a href="#feature_match_fuzzy_string-472"><span class="linenos">472</span></a>    <span class="k">return</span> <span class="n">score</span> <span class="o">&gt;=</span> <span class="n">threshold</span>
</span></pre></div>


            <div class="docstring"><p>Determines whether two strings in a given pair of records are close
enough to constitute a partial match. The exact nature of the match
is determined by the specified string comparison function (see
harmonization/utils/compare_strings for more details) as well as a
scoring threshold the comparison must meet or exceed.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>record_i</strong>:  One of the records in the candidate pair to evaluate.</li>
<li><strong>record_j</strong>:  The second record in the candidate pair.</li>
<li><strong>feature_x</strong>:  A number representing the index of the feature to
compare for a partial match.</li>
<li><strong>**kwargs</strong>:  Optionally, a dictionary including specifications for
the string comparison metric to use, as well as the cutoff score
beyond which to classify the strings as a partial match.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>A boolean indicating whether the features are a fuzzy match.</p>
</blockquote>
</div>


                </section>
                <section id="eval_perfect_match">
                            <input id="eval_perfect_match-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">eval_perfect_match</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">feature_comparisons</span><span class="p">:</span> <span class="n">List</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="eval_perfect_match-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#eval_perfect_match"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="eval_perfect_match-291"><a href="#eval_perfect_match-291"><span class="linenos">291</span></a><span class="k">def</span> <span class="nf">eval_perfect_match</span><span class="p">(</span><span class="n">feature_comparisons</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="eval_perfect_match-292"><a href="#eval_perfect_match-292"><span class="linenos">292</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="eval_perfect_match-293"><a href="#eval_perfect_match-293"><span class="linenos">293</span></a><span class="sd">    Determines whether a given set of feature comparisons represent a</span>
</span><span id="eval_perfect_match-294"><a href="#eval_perfect_match-294"><span class="linenos">294</span></a><span class="sd">    &#39;perfect&#39; match (i.e. whether all features that were compared match</span>
</span><span id="eval_perfect_match-295"><a href="#eval_perfect_match-295"><span class="linenos">295</span></a><span class="sd">    in whatever criteria was specified for them).</span>
</span><span id="eval_perfect_match-296"><a href="#eval_perfect_match-296"><span class="linenos">296</span></a>
</span><span id="eval_perfect_match-297"><a href="#eval_perfect_match-297"><span class="linenos">297</span></a><span class="sd">    :param feature_comparisons: A list of 1s and 0s, one for each feature</span>
</span><span id="eval_perfect_match-298"><a href="#eval_perfect_match-298"><span class="linenos">298</span></a><span class="sd">      that was compared during the match algorithm.</span>
</span><span id="eval_perfect_match-299"><a href="#eval_perfect_match-299"><span class="linenos">299</span></a><span class="sd">    :return: The evaluation of whether the given features all match.</span>
</span><span id="eval_perfect_match-300"><a href="#eval_perfect_match-300"><span class="linenos">300</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="eval_perfect_match-301"><a href="#eval_perfect_match-301"><span class="linenos">301</span></a>    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">feature_comparisons</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_comparisons</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Determines whether a given set of feature comparisons represent a
'perfect' match (i.e. whether all features that were compared match
in whatever criteria was specified for them).</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>feature_comparisons</strong>:  A list of 1s and 0s, one for each feature
that was compared during the match algorithm.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>The evaluation of whether the given features all match.</p>
</blockquote>
</div>


                </section>
                <section id="compile_match_lists">
                            <input id="compile_match_lists-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compile_match_lists</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">match_lists</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>, </span><span class="param"><span class="n">cluster_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="compile_match_lists-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#compile_match_lists"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="compile_match_lists-253"><a href="#compile_match_lists-253"><span class="linenos">253</span></a><span class="k">def</span> <span class="nf">compile_match_lists</span><span class="p">(</span><span class="n">match_lists</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">cluster_mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="compile_match_lists-254"><a href="#compile_match_lists-254"><span class="linenos">254</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="compile_match_lists-255"><a href="#compile_match_lists-255"><span class="linenos">255</span></a><span class="sd">    Turns a list of matches of either clusters or candidate pairs found</span>
</span><span id="compile_match_lists-256"><a href="#compile_match_lists-256"><span class="linenos">256</span></a><span class="sd">    during linkage into a single unified structure holding all found matches</span>
</span><span id="compile_match_lists-257"><a href="#compile_match_lists-257"><span class="linenos">257</span></a><span class="sd">    across all rules passes. E.g. if a single pass of a linkage algorithm</span>
</span><span id="compile_match_lists-258"><a href="#compile_match_lists-258"><span class="linenos">258</span></a><span class="sd">    uses three rules, hence generates three dictionaries of matches, this</span>
</span><span id="compile_match_lists-259"><a href="#compile_match_lists-259"><span class="linenos">259</span></a><span class="sd">    function will aggregate the results of those three separate dicts into</span>
</span><span id="compile_match_lists-260"><a href="#compile_match_lists-260"><span class="linenos">260</span></a><span class="sd">    a single unified and deduplicated dictionary. For consistency during</span>
</span><span id="compile_match_lists-261"><a href="#compile_match_lists-261"><span class="linenos">261</span></a><span class="sd">    statistical evaluation, the returned dictionary is always indexed by</span>
</span><span id="compile_match_lists-262"><a href="#compile_match_lists-262"><span class="linenos">262</span></a><span class="sd">    the lower ID of the records in a given pair.</span>
</span><span id="compile_match_lists-263"><a href="#compile_match_lists-263"><span class="linenos">263</span></a>
</span><span id="compile_match_lists-264"><a href="#compile_match_lists-264"><span class="linenos">264</span></a><span class="sd">    :param match_lists: A list of the dictionaries obtained during a run</span>
</span><span id="compile_match_lists-265"><a href="#compile_match_lists-265"><span class="linenos">265</span></a><span class="sd">      of the linkage algorithm, one dictionary per rule used in the run.</span>
</span><span id="compile_match_lists-266"><a href="#compile_match_lists-266"><span class="linenos">266</span></a><span class="sd">    :param cluster_mode: An optional boolean indicating whether the linkage</span>
</span><span id="compile_match_lists-267"><a href="#compile_match_lists-267"><span class="linenos">267</span></a><span class="sd">      algorithm was run in cluster mode. Default is False.</span>
</span><span id="compile_match_lists-268"><a href="#compile_match_lists-268"><span class="linenos">268</span></a><span class="sd">    :return: The aggregated dictionary of unified matches.</span>
</span><span id="compile_match_lists-269"><a href="#compile_match_lists-269"><span class="linenos">269</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="compile_match_lists-270"><a href="#compile_match_lists-270"><span class="linenos">270</span></a>    <span class="n">matches</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="compile_match_lists-271"><a href="#compile_match_lists-271"><span class="linenos">271</span></a>    <span class="k">for</span> <span class="n">matches_from_rule</span> <span class="ow">in</span> <span class="n">match_lists</span><span class="p">:</span>
</span><span id="compile_match_lists-272"><a href="#compile_match_lists-272"><span class="linenos">272</span></a>        <span class="k">for</span> <span class="n">matches_within_blocks</span> <span class="ow">in</span> <span class="n">matches_from_rule</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="compile_match_lists-273"><a href="#compile_match_lists-273"><span class="linenos">273</span></a>            <span class="k">for</span> <span class="n">candidate_set</span> <span class="ow">in</span> <span class="n">matches_within_blocks</span><span class="p">:</span>
</span><span id="compile_match_lists-274"><a href="#compile_match_lists-274"><span class="linenos">274</span></a>                <span class="c1"># Always index the aggregate by the lowest valued ID</span>
</span><span id="compile_match_lists-275"><a href="#compile_match_lists-275"><span class="linenos">275</span></a>                <span class="c1"># for statistical consistency and deduplication</span>
</span><span id="compile_match_lists-276"><a href="#compile_match_lists-276"><span class="linenos">276</span></a>                <span class="n">root_record</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">candidate_set</span><span class="p">)</span>
</span><span id="compile_match_lists-277"><a href="#compile_match_lists-277"><span class="linenos">277</span></a>                <span class="k">if</span> <span class="n">root_record</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
</span><span id="compile_match_lists-278"><a href="#compile_match_lists-278"><span class="linenos">278</span></a>                    <span class="n">matches</span><span class="p">[</span><span class="n">root_record</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="compile_match_lists-279"><a href="#compile_match_lists-279"><span class="linenos">279</span></a>
</span><span id="compile_match_lists-280"><a href="#compile_match_lists-280"><span class="linenos">280</span></a>                <span class="c1"># For clustering, need to add all other records in the cluster</span>
</span><span id="compile_match_lists-281"><a href="#compile_match_lists-281"><span class="linenos">281</span></a>                <span class="k">if</span> <span class="n">cluster_mode</span><span class="p">:</span>
</span><span id="compile_match_lists-282"><a href="#compile_match_lists-282"><span class="linenos">282</span></a>                    <span class="k">for</span> <span class="n">clustered_record</span> <span class="ow">in</span> <span class="n">candidate_set</span><span class="p">:</span>
</span><span id="compile_match_lists-283"><a href="#compile_match_lists-283"><span class="linenos">283</span></a>                        <span class="k">if</span> <span class="n">clustered_record</span> <span class="o">!=</span> <span class="n">root_record</span><span class="p">:</span>
</span><span id="compile_match_lists-284"><a href="#compile_match_lists-284"><span class="linenos">284</span></a>                            <span class="n">matches</span><span class="p">[</span><span class="n">root_record</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">clustered_record</span><span class="p">)</span>
</span><span id="compile_match_lists-285"><a href="#compile_match_lists-285"><span class="linenos">285</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="compile_match_lists-286"><a href="#compile_match_lists-286"><span class="linenos">286</span></a>                    <span class="n">matched_record</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">candidate_set</span><span class="p">)</span>
</span><span id="compile_match_lists-287"><a href="#compile_match_lists-287"><span class="linenos">287</span></a>                    <span class="n">matches</span><span class="p">[</span><span class="n">root_record</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">matched_record</span><span class="p">)</span>
</span><span id="compile_match_lists-288"><a href="#compile_match_lists-288"><span class="linenos">288</span></a>    <span class="k">return</span> <span class="n">matches</span>
</span></pre></div>


            <div class="docstring"><p>Turns a list of matches of either clusters or candidate pairs found
during linkage into a single unified structure holding all found matches
across all rules passes. E.g. if a single pass of a linkage algorithm
uses three rules, hence generates three dictionaries of matches, this
function will aggregate the results of those three separate dicts into
a single unified and deduplicated dictionary. For consistency during
statistical evaluation, the returned dictionary is always indexed by
the lower ID of the records in a given pair.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>match_lists</strong>:  A list of the dictionaries obtained during a run
of the linkage algorithm, one dictionary per rule used in the run.</li>
<li><strong>cluster_mode</strong>:  An optional boolean indicating whether the linkage
algorithm was run in cluster mode. Default is False.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>The aggregated dictionary of unified matches.</p>
</blockquote>
</div>


                </section>
                <section id="feature_match_four_char">
                            <input id="feature_match_four_char-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">feature_match_four_char</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">record_i</span><span class="p">:</span> <span class="n">List</span>, </span><span class="param"><span class="n">record_j</span><span class="p">:</span> <span class="n">List</span>, </span><span class="param"><span class="n">feature_x</span><span class="p">:</span> <span class="nb">int</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="feature_match_four_char-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#feature_match_four_char"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="feature_match_four_char-419"><a href="#feature_match_four_char-419"><span class="linenos">419</span></a><span class="k">def</span> <span class="nf">feature_match_four_char</span><span class="p">(</span>
</span><span id="feature_match_four_char-420"><a href="#feature_match_four_char-420"><span class="linenos">420</span></a>    <span class="n">record_i</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">record_j</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">feature_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span>
</span><span id="feature_match_four_char-421"><a href="#feature_match_four_char-421"><span class="linenos">421</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="feature_match_four_char-422"><a href="#feature_match_four_char-422"><span class="linenos">422</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="feature_match_four_char-423"><a href="#feature_match_four_char-423"><span class="linenos">423</span></a><span class="sd">    Determines whether a string feature in a pair of records exactly matches</span>
</span><span id="feature_match_four_char-424"><a href="#feature_match_four_char-424"><span class="linenos">424</span></a><span class="sd">    on the first four characters.</span>
</span><span id="feature_match_four_char-425"><a href="#feature_match_four_char-425"><span class="linenos">425</span></a>
</span><span id="feature_match_four_char-426"><a href="#feature_match_four_char-426"><span class="linenos">426</span></a><span class="sd">    :param record_i: One of the records in the candidate pair to evaluate.</span>
</span><span id="feature_match_four_char-427"><a href="#feature_match_four_char-427"><span class="linenos">427</span></a><span class="sd">    :param record_j: The second record in the candidate pair.</span>
</span><span id="feature_match_four_char-428"><a href="#feature_match_four_char-428"><span class="linenos">428</span></a><span class="sd">    :param feature_x: A number representing the index of the feature to</span>
</span><span id="feature_match_four_char-429"><a href="#feature_match_four_char-429"><span class="linenos">429</span></a><span class="sd">      compare.</span>
</span><span id="feature_match_four_char-430"><a href="#feature_match_four_char-430"><span class="linenos">430</span></a><span class="sd">    :return: A boolean indicating whether the features are a match.</span>
</span><span id="feature_match_four_char-431"><a href="#feature_match_four_char-431"><span class="linenos">431</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="feature_match_four_char-432"><a href="#feature_match_four_char-432"><span class="linenos">432</span></a>    <span class="n">first_four_i</span> <span class="o">=</span> <span class="n">record_i</span><span class="p">[</span><span class="n">feature_x</span><span class="p">][:</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">record_i</span><span class="p">[</span><span class="n">feature_x</span><span class="p">]))]</span>
</span><span id="feature_match_four_char-433"><a href="#feature_match_four_char-433"><span class="linenos">433</span></a>    <span class="n">first_four_j</span> <span class="o">=</span> <span class="n">record_j</span><span class="p">[</span><span class="n">feature_x</span><span class="p">][:</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">record_j</span><span class="p">[</span><span class="n">feature_x</span><span class="p">]))]</span>
</span><span id="feature_match_four_char-434"><a href="#feature_match_four_char-434"><span class="linenos">434</span></a>    <span class="k">return</span> <span class="n">first_four_i</span> <span class="o">==</span> <span class="n">first_four_j</span>
</span></pre></div>


            <div class="docstring"><p>Determines whether a string feature in a pair of records exactly matches
on the first four characters.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>record_i</strong>:  One of the records in the candidate pair to evaluate.</li>
<li><strong>record_j</strong>:  The second record in the candidate pair.</li>
<li><strong>feature_x</strong>:  A number representing the index of the feature to
compare.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>A boolean indicating whether the features are a match.</p>
</blockquote>
</div>


                </section>
                <section id="perform_linkage_pass">
                            <input id="perform_linkage_pass-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">perform_linkage_pass</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">data</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>,</span><span class="param">	<span class="n">blocks</span><span class="p">:</span> <span class="n">List</span>,</span><span class="param">	<span class="n">feature_funcs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">]</span>,</span><span class="param">	<span class="n">matching_rule</span><span class="p">:</span> <span class="n">Callable</span>,</span><span class="param">	<span class="n">cluster_ratio</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="perform_linkage_pass-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#perform_linkage_pass"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="perform_linkage_pass-742"><a href="#perform_linkage_pass-742"><span class="linenos">742</span></a><span class="k">def</span> <span class="nf">perform_linkage_pass</span><span class="p">(</span>
</span><span id="perform_linkage_pass-743"><a href="#perform_linkage_pass-743"><span class="linenos">743</span></a>    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
</span><span id="perform_linkage_pass-744"><a href="#perform_linkage_pass-744"><span class="linenos">744</span></a>    <span class="n">blocks</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
</span><span id="perform_linkage_pass-745"><a href="#perform_linkage_pass-745"><span class="linenos">745</span></a>    <span class="n">feature_funcs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Callable</span><span class="p">],</span>
</span><span id="perform_linkage_pass-746"><a href="#perform_linkage_pass-746"><span class="linenos">746</span></a>    <span class="n">matching_rule</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
</span><span id="perform_linkage_pass-747"><a href="#perform_linkage_pass-747"><span class="linenos">747</span></a>    <span class="n">cluster_ratio</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="perform_linkage_pass-748"><a href="#perform_linkage_pass-748"><span class="linenos">748</span></a>    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="perform_linkage_pass-749"><a href="#perform_linkage_pass-749"><span class="linenos">749</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="perform_linkage_pass-750"><a href="#perform_linkage_pass-750"><span class="linenos">750</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="perform_linkage_pass-751"><a href="#perform_linkage_pass-751"><span class="linenos">751</span></a><span class="sd">    Performs a partial run of a linkage algorithm using a single rule.</span>
</span><span id="perform_linkage_pass-752"><a href="#perform_linkage_pass-752"><span class="linenos">752</span></a><span class="sd">    Each rule in an algorithm is associated with its own pass through the</span>
</span><span id="perform_linkage_pass-753"><a href="#perform_linkage_pass-753"><span class="linenos">753</span></a><span class="sd">    data.</span>
</span><span id="perform_linkage_pass-754"><a href="#perform_linkage_pass-754"><span class="linenos">754</span></a>
</span><span id="perform_linkage_pass-755"><a href="#perform_linkage_pass-755"><span class="linenos">755</span></a><span class="sd">    :param data: Currently, a pandas dataframe of records to link. When we</span>
</span><span id="perform_linkage_pass-756"><a href="#perform_linkage_pass-756"><span class="linenos">756</span></a><span class="sd">      move out of testing, this should become a LoL.</span>
</span><span id="perform_linkage_pass-757"><a href="#perform_linkage_pass-757"><span class="linenos">757</span></a><span class="sd">    :param blocks: A list of column headers to use as blocking assignments</span>
</span><span id="perform_linkage_pass-758"><a href="#perform_linkage_pass-758"><span class="linenos">758</span></a><span class="sd">      by which to partition the data.</span>
</span><span id="perform_linkage_pass-759"><a href="#perform_linkage_pass-759"><span class="linenos">759</span></a><span class="sd">    :param feature_funcs: A dictionary mapping feature indices to functions</span>
</span><span id="perform_linkage_pass-760"><a href="#perform_linkage_pass-760"><span class="linenos">760</span></a><span class="sd">      used to evaluate those features for a match.</span>
</span><span id="perform_linkage_pass-761"><a href="#perform_linkage_pass-761"><span class="linenos">761</span></a><span class="sd">    :param matching_rule: A function for determining whether a given set of</span>
</span><span id="perform_linkage_pass-762"><a href="#perform_linkage_pass-762"><span class="linenos">762</span></a><span class="sd">      feature comparisons constitutes a match for linkage.</span>
</span><span id="perform_linkage_pass-763"><a href="#perform_linkage_pass-763"><span class="linenos">763</span></a><span class="sd">    :param cluster_ratio: An optional parameter indicating, if using the</span>
</span><span id="perform_linkage_pass-764"><a href="#perform_linkage_pass-764"><span class="linenos">764</span></a><span class="sd">      algorithm in cluster mode, the required membership percentage a record</span>
</span><span id="perform_linkage_pass-765"><a href="#perform_linkage_pass-765"><span class="linenos">765</span></a><span class="sd">      must score with an existing cluster in order to join.</span>
</span><span id="perform_linkage_pass-766"><a href="#perform_linkage_pass-766"><span class="linenos">766</span></a><span class="sd">    :return: A dictionary mapping each block found in the pass to the matches</span>
</span><span id="perform_linkage_pass-767"><a href="#perform_linkage_pass-767"><span class="linenos">767</span></a><span class="sd">      discovered within that block.</span>
</span><span id="perform_linkage_pass-768"><a href="#perform_linkage_pass-768"><span class="linenos">768</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="perform_linkage_pass-769"><a href="#perform_linkage_pass-769"><span class="linenos">769</span></a>    <span class="n">blocked_data</span> <span class="o">=</span> <span class="n">block_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">blocks</span><span class="p">)</span>
</span><span id="perform_linkage_pass-770"><a href="#perform_linkage_pass-770"><span class="linenos">770</span></a>    <span class="n">matches</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="perform_linkage_pass-771"><a href="#perform_linkage_pass-771"><span class="linenos">771</span></a>    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocked_data</span><span class="p">:</span>
</span><span id="perform_linkage_pass-772"><a href="#perform_linkage_pass-772"><span class="linenos">772</span></a>        <span class="k">if</span> <span class="n">cluster_ratio</span><span class="p">:</span>
</span><span id="perform_linkage_pass-773"><a href="#perform_linkage_pass-773"><span class="linenos">773</span></a>            <span class="n">matches_in_block</span> <span class="o">=</span> <span class="n">_match_within_block_cluster_ratio</span><span class="p">(</span>
</span><span id="perform_linkage_pass-774"><a href="#perform_linkage_pass-774"><span class="linenos">774</span></a>                <span class="n">blocked_data</span><span class="p">[</span><span class="n">block</span><span class="p">],</span>
</span><span id="perform_linkage_pass-775"><a href="#perform_linkage_pass-775"><span class="linenos">775</span></a>                <span class="n">cluster_ratio</span><span class="p">,</span>
</span><span id="perform_linkage_pass-776"><a href="#perform_linkage_pass-776"><span class="linenos">776</span></a>                <span class="n">feature_funcs</span><span class="p">,</span>
</span><span id="perform_linkage_pass-777"><a href="#perform_linkage_pass-777"><span class="linenos">777</span></a>                <span class="n">matching_rule</span><span class="p">,</span>
</span><span id="perform_linkage_pass-778"><a href="#perform_linkage_pass-778"><span class="linenos">778</span></a>                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="perform_linkage_pass-779"><a href="#perform_linkage_pass-779"><span class="linenos">779</span></a>            <span class="p">)</span>
</span><span id="perform_linkage_pass-780"><a href="#perform_linkage_pass-780"><span class="linenos">780</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="perform_linkage_pass-781"><a href="#perform_linkage_pass-781"><span class="linenos">781</span></a>            <span class="n">matches_in_block</span> <span class="o">=</span> <span class="n">match_within_block</span><span class="p">(</span>
</span><span id="perform_linkage_pass-782"><a href="#perform_linkage_pass-782"><span class="linenos">782</span></a>                <span class="n">blocked_data</span><span class="p">[</span><span class="n">block</span><span class="p">],</span> <span class="n">feature_funcs</span><span class="p">,</span> <span class="n">matching_rule</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span id="perform_linkage_pass-783"><a href="#perform_linkage_pass-783"><span class="linenos">783</span></a>            <span class="p">)</span>
</span><span id="perform_linkage_pass-784"><a href="#perform_linkage_pass-784"><span class="linenos">784</span></a>        <span class="n">matches_in_block</span> <span class="o">=</span> <span class="n">_map_matches_to_record_ids</span><span class="p">(</span>
</span><span id="perform_linkage_pass-785"><a href="#perform_linkage_pass-785"><span class="linenos">785</span></a>            <span class="n">matches_in_block</span><span class="p">,</span> <span class="n">blocked_data</span><span class="p">[</span><span class="n">block</span><span class="p">],</span> <span class="n">cluster_ratio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="perform_linkage_pass-786"><a href="#perform_linkage_pass-786"><span class="linenos">786</span></a>        <span class="p">)</span>
</span><span id="perform_linkage_pass-787"><a href="#perform_linkage_pass-787"><span class="linenos">787</span></a>        <span class="n">matches</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="n">matches_in_block</span>
</span><span id="perform_linkage_pass-788"><a href="#perform_linkage_pass-788"><span class="linenos">788</span></a>    <span class="k">return</span> <span class="n">matches</span>
</span></pre></div>


            <div class="docstring"><p>Performs a partial run of a linkage algorithm using a single rule.
Each rule in an algorithm is associated with its own pass through the
data.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>data</strong>:  Currently, a pandas dataframe of records to link. When we
move out of testing, this should become a LoL.</li>
<li><strong>blocks</strong>:  A list of column headers to use as blocking assignments
by which to partition the data.</li>
<li><strong>feature_funcs</strong>:  A dictionary mapping feature indices to functions
used to evaluate those features for a match.</li>
<li><strong>matching_rule</strong>:  A function for determining whether a given set of
feature comparisons constitutes a match for linkage.</li>
<li><strong>cluster_ratio</strong>:  An optional parameter indicating, if using the
algorithm in cluster mode, the required membership percentage a record
must score with an existing cluster in order to join.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>A dictionary mapping each block found in the pass to the matches
    discovered within that block.</p>
</blockquote>
</div>


                </section>
                <section id="score_linkage_vs_truth">
                            <input id="score_linkage_vs_truth-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">score_linkage_vs_truth</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">found_matches</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">set</span><span class="p">]</span>,</span><span class="param">	<span class="n">true_matches</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">set</span><span class="p">]</span>,</span><span class="param">	<span class="n">records_in_dataset</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">expand_clusters_pairwise</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="nb">tuple</span>:</span></span>

                <label class="view-source-button" for="score_linkage_vs_truth-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#score_linkage_vs_truth"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="score_linkage_vs_truth-925"><a href="#score_linkage_vs_truth-925"><span class="linenos"> 925</span></a><span class="k">def</span> <span class="nf">score_linkage_vs_truth</span><span class="p">(</span>
</span><span id="score_linkage_vs_truth-926"><a href="#score_linkage_vs_truth-926"><span class="linenos"> 926</span></a>    <span class="n">found_matches</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">set</span><span class="p">],</span>
</span><span id="score_linkage_vs_truth-927"><a href="#score_linkage_vs_truth-927"><span class="linenos"> 927</span></a>    <span class="n">true_matches</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">set</span><span class="p">],</span>
</span><span id="score_linkage_vs_truth-928"><a href="#score_linkage_vs_truth-928"><span class="linenos"> 928</span></a>    <span class="n">records_in_dataset</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="score_linkage_vs_truth-929"><a href="#score_linkage_vs_truth-929"><span class="linenos"> 929</span></a>    <span class="n">expand_clusters_pairwise</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="score_linkage_vs_truth-930"><a href="#score_linkage_vs_truth-930"><span class="linenos"> 930</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
</span><span id="score_linkage_vs_truth-931"><a href="#score_linkage_vs_truth-931"><span class="linenos"> 931</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="score_linkage_vs_truth-932"><a href="#score_linkage_vs_truth-932"><span class="linenos"> 932</span></a><span class="sd">    Compute the statistical qualities of a run of record linkage against</span>
</span><span id="score_linkage_vs_truth-933"><a href="#score_linkage_vs_truth-933"><span class="linenos"> 933</span></a><span class="sd">    known true results. This function assumes that matches have already</span>
</span><span id="score_linkage_vs_truth-934"><a href="#score_linkage_vs_truth-934"><span class="linenos"> 934</span></a><span class="sd">    been determined by the algorithm, and further assumes that true</span>
</span><span id="score_linkage_vs_truth-935"><a href="#score_linkage_vs_truth-935"><span class="linenos"> 935</span></a><span class="sd">    matches have already been identified in the data.</span>
</span><span id="score_linkage_vs_truth-936"><a href="#score_linkage_vs_truth-936"><span class="linenos"> 936</span></a>
</span><span id="score_linkage_vs_truth-937"><a href="#score_linkage_vs_truth-937"><span class="linenos"> 937</span></a><span class="sd">    :param found_matches: A dictionary mapping IDs of records to sets of</span>
</span><span id="score_linkage_vs_truth-938"><a href="#score_linkage_vs_truth-938"><span class="linenos"> 938</span></a><span class="sd">      other records which were determined to be a match.</span>
</span><span id="score_linkage_vs_truth-939"><a href="#score_linkage_vs_truth-939"><span class="linenos"> 939</span></a><span class="sd">    :param true_matches: A dictionary mapping IDs of records to sets of</span>
</span><span id="score_linkage_vs_truth-940"><a href="#score_linkage_vs_truth-940"><span class="linenos"> 940</span></a><span class="sd">      other records which are _known_ to be a true match.</span>
</span><span id="score_linkage_vs_truth-941"><a href="#score_linkage_vs_truth-941"><span class="linenos"> 941</span></a><span class="sd">    :param records_in_dataset: The number of records in the original data</span>
</span><span id="score_linkage_vs_truth-942"><a href="#score_linkage_vs_truth-942"><span class="linenos"> 942</span></a><span class="sd">      set to-link.</span>
</span><span id="score_linkage_vs_truth-943"><a href="#score_linkage_vs_truth-943"><span class="linenos"> 943</span></a><span class="sd">    :param expand_clusters_pairwise: Optionally, whether we need to take</span>
</span><span id="score_linkage_vs_truth-944"><a href="#score_linkage_vs_truth-944"><span class="linenos"> 944</span></a><span class="sd">      the cross-product of members within the sets of the match list. This</span>
</span><span id="score_linkage_vs_truth-945"><a href="#score_linkage_vs_truth-945"><span class="linenos"> 945</span></a><span class="sd">      parameter only needs to be used if the linkage algorithm was run in</span>
</span><span id="score_linkage_vs_truth-946"><a href="#score_linkage_vs_truth-946"><span class="linenos"> 946</span></a><span class="sd">      cluster mode. Default is False.</span>
</span><span id="score_linkage_vs_truth-947"><a href="#score_linkage_vs_truth-947"><span class="linenos"> 947</span></a><span class="sd">    :return: A tuple reporting the sensitivity/precision, specificity/recall,</span>
</span><span id="score_linkage_vs_truth-948"><a href="#score_linkage_vs_truth-948"><span class="linenos"> 948</span></a><span class="sd">      positive prediction value, and F1 score of the linkage algorithm.</span>
</span><span id="score_linkage_vs_truth-949"><a href="#score_linkage_vs_truth-949"><span class="linenos"> 949</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="score_linkage_vs_truth-950"><a href="#score_linkage_vs_truth-950"><span class="linenos"> 950</span></a>
</span><span id="score_linkage_vs_truth-951"><a href="#score_linkage_vs_truth-951"><span class="linenos"> 951</span></a>    <span class="c1"># If cluster mode was used, only the &quot;master&quot; patient&#39;s set will exist</span>
</span><span id="score_linkage_vs_truth-952"><a href="#score_linkage_vs_truth-952"><span class="linenos"> 952</span></a>    <span class="c1"># Need to expand other permutations for accurate statistics</span>
</span><span id="score_linkage_vs_truth-953"><a href="#score_linkage_vs_truth-953"><span class="linenos"> 953</span></a>    <span class="k">if</span> <span class="n">expand_clusters_pairwise</span><span class="p">:</span>
</span><span id="score_linkage_vs_truth-954"><a href="#score_linkage_vs_truth-954"><span class="linenos"> 954</span></a>        <span class="n">new_found_matches</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="score_linkage_vs_truth-955"><a href="#score_linkage_vs_truth-955"><span class="linenos"> 955</span></a>        <span class="k">for</span> <span class="n">root_rec</span> <span class="ow">in</span> <span class="n">found_matches</span><span class="p">:</span>
</span><span id="score_linkage_vs_truth-956"><a href="#score_linkage_vs_truth-956"><span class="linenos"> 956</span></a>            <span class="k">if</span> <span class="n">root_rec</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_found_matches</span><span class="p">:</span>
</span><span id="score_linkage_vs_truth-957"><a href="#score_linkage_vs_truth-957"><span class="linenos"> 957</span></a>                <span class="n">new_found_matches</span><span class="p">[</span><span class="n">root_rec</span><span class="p">]</span> <span class="o">=</span> <span class="n">found_matches</span><span class="p">[</span><span class="n">root_rec</span><span class="p">]</span>
</span><span id="score_linkage_vs_truth-958"><a href="#score_linkage_vs_truth-958"><span class="linenos"> 958</span></a>            <span class="k">for</span> <span class="n">paired_record</span> <span class="ow">in</span> <span class="n">found_matches</span><span class="p">[</span><span class="n">root_rec</span><span class="p">]:</span>
</span><span id="score_linkage_vs_truth-959"><a href="#score_linkage_vs_truth-959"><span class="linenos"> 959</span></a>                <span class="k">if</span> <span class="n">paired_record</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_found_matches</span><span class="p">:</span>
</span><span id="score_linkage_vs_truth-960"><a href="#score_linkage_vs_truth-960"><span class="linenos"> 960</span></a>                    <span class="n">new_found_matches</span><span class="p">[</span><span class="n">paired_record</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="score_linkage_vs_truth-961"><a href="#score_linkage_vs_truth-961"><span class="linenos"> 961</span></a>                <span class="k">for</span> <span class="n">other_record</span> <span class="ow">in</span> <span class="n">found_matches</span><span class="p">[</span><span class="n">root_rec</span><span class="p">]:</span>
</span><span id="score_linkage_vs_truth-962"><a href="#score_linkage_vs_truth-962"><span class="linenos"> 962</span></a>                    <span class="k">if</span> <span class="n">other_record</span> <span class="o">&gt;</span> <span class="n">paired_record</span><span class="p">:</span>
</span><span id="score_linkage_vs_truth-963"><a href="#score_linkage_vs_truth-963"><span class="linenos"> 963</span></a>                        <span class="n">new_found_matches</span><span class="p">[</span><span class="n">paired_record</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">other_record</span><span class="p">)</span>
</span><span id="score_linkage_vs_truth-964"><a href="#score_linkage_vs_truth-964"><span class="linenos"> 964</span></a>        <span class="n">found_matches</span> <span class="o">=</span> <span class="n">new_found_matches</span>
</span><span id="score_linkage_vs_truth-965"><a href="#score_linkage_vs_truth-965"><span class="linenos"> 965</span></a>
</span><span id="score_linkage_vs_truth-966"><a href="#score_linkage_vs_truth-966"><span class="linenos"> 966</span></a>    <span class="c1"># Need division by 2 because ordering is irrelevant, matches are symmetric</span>
</span><span id="score_linkage_vs_truth-967"><a href="#score_linkage_vs_truth-967"><span class="linenos"> 967</span></a>    <span class="n">total_possible_matches</span> <span class="o">=</span> <span class="p">(</span><span class="n">records_in_dataset</span> <span class="o">*</span> <span class="p">(</span><span class="n">records_in_dataset</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mf">2.0</span>
</span><span id="score_linkage_vs_truth-968"><a href="#score_linkage_vs_truth-968"><span class="linenos"> 968</span></a>    <span class="n">true_positives</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="score_linkage_vs_truth-969"><a href="#score_linkage_vs_truth-969"><span class="linenos"> 969</span></a>    <span class="n">false_positives</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="score_linkage_vs_truth-970"><a href="#score_linkage_vs_truth-970"><span class="linenos"> 970</span></a>    <span class="n">false_negatives</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="score_linkage_vs_truth-971"><a href="#score_linkage_vs_truth-971"><span class="linenos"> 971</span></a>
</span><span id="score_linkage_vs_truth-972"><a href="#score_linkage_vs_truth-972"><span class="linenos"> 972</span></a>    <span class="k">for</span> <span class="n">root_record</span> <span class="ow">in</span> <span class="n">true_matches</span><span class="p">:</span>
</span><span id="score_linkage_vs_truth-973"><a href="#score_linkage_vs_truth-973"><span class="linenos"> 973</span></a>        <span class="k">if</span> <span class="n">root_record</span> <span class="ow">in</span> <span class="n">found_matches</span><span class="p">:</span>
</span><span id="score_linkage_vs_truth-974"><a href="#score_linkage_vs_truth-974"><span class="linenos"> 974</span></a>            <span class="n">true_positives</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span>
</span><span id="score_linkage_vs_truth-975"><a href="#score_linkage_vs_truth-975"><span class="linenos"> 975</span></a>                <span class="n">true_matches</span><span class="p">[</span><span class="n">root_record</span><span class="p">]</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">found_matches</span><span class="p">[</span><span class="n">root_record</span><span class="p">])</span>
</span><span id="score_linkage_vs_truth-976"><a href="#score_linkage_vs_truth-976"><span class="linenos"> 976</span></a>            <span class="p">)</span>
</span><span id="score_linkage_vs_truth-977"><a href="#score_linkage_vs_truth-977"><span class="linenos"> 977</span></a>            <span class="n">false_positives</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span>
</span><span id="score_linkage_vs_truth-978"><a href="#score_linkage_vs_truth-978"><span class="linenos"> 978</span></a>                <span class="n">found_matches</span><span class="p">[</span><span class="n">root_record</span><span class="p">]</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">true_matches</span><span class="p">[</span><span class="n">root_record</span><span class="p">])</span>
</span><span id="score_linkage_vs_truth-979"><a href="#score_linkage_vs_truth-979"><span class="linenos"> 979</span></a>            <span class="p">)</span>
</span><span id="score_linkage_vs_truth-980"><a href="#score_linkage_vs_truth-980"><span class="linenos"> 980</span></a>            <span class="n">false_negatives</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span>
</span><span id="score_linkage_vs_truth-981"><a href="#score_linkage_vs_truth-981"><span class="linenos"> 981</span></a>                <span class="n">true_matches</span><span class="p">[</span><span class="n">root_record</span><span class="p">]</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">found_matches</span><span class="p">[</span><span class="n">root_record</span><span class="p">])</span>
</span><span id="score_linkage_vs_truth-982"><a href="#score_linkage_vs_truth-982"><span class="linenos"> 982</span></a>            <span class="p">)</span>
</span><span id="score_linkage_vs_truth-983"><a href="#score_linkage_vs_truth-983"><span class="linenos"> 983</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="score_linkage_vs_truth-984"><a href="#score_linkage_vs_truth-984"><span class="linenos"> 984</span></a>            <span class="n">false_negatives</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">true_matches</span><span class="p">[</span><span class="n">root_record</span><span class="p">])</span>
</span><span id="score_linkage_vs_truth-985"><a href="#score_linkage_vs_truth-985"><span class="linenos"> 985</span></a>    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">found_matches</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">true_matches</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
</span><span id="score_linkage_vs_truth-986"><a href="#score_linkage_vs_truth-986"><span class="linenos"> 986</span></a>        <span class="n">false_positives</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">found_matches</span><span class="p">[</span><span class="n">record</span><span class="p">])</span>
</span><span id="score_linkage_vs_truth-987"><a href="#score_linkage_vs_truth-987"><span class="linenos"> 987</span></a>
</span><span id="score_linkage_vs_truth-988"><a href="#score_linkage_vs_truth-988"><span class="linenos"> 988</span></a>    <span class="n">true_negatives</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="score_linkage_vs_truth-989"><a href="#score_linkage_vs_truth-989"><span class="linenos"> 989</span></a>        <span class="n">total_possible_matches</span> <span class="o">-</span> <span class="n">true_positives</span> <span class="o">-</span> <span class="n">false_positives</span> <span class="o">-</span> <span class="n">false_negatives</span>
</span><span id="score_linkage_vs_truth-990"><a href="#score_linkage_vs_truth-990"><span class="linenos"> 990</span></a>    <span class="p">)</span>
</span><span id="score_linkage_vs_truth-991"><a href="#score_linkage_vs_truth-991"><span class="linenos"> 991</span></a>
</span><span id="score_linkage_vs_truth-992"><a href="#score_linkage_vs_truth-992"><span class="linenos"> 992</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;True Positives Found:&quot;</span><span class="p">,</span> <span class="n">true_positives</span><span class="p">)</span>
</span><span id="score_linkage_vs_truth-993"><a href="#score_linkage_vs_truth-993"><span class="linenos"> 993</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;False Positives Misidentified:&quot;</span><span class="p">,</span> <span class="n">false_positives</span><span class="p">)</span>
</span><span id="score_linkage_vs_truth-994"><a href="#score_linkage_vs_truth-994"><span class="linenos"> 994</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;False Negatives Missed:&quot;</span><span class="p">,</span> <span class="n">false_negatives</span><span class="p">)</span>
</span><span id="score_linkage_vs_truth-995"><a href="#score_linkage_vs_truth-995"><span class="linenos"> 995</span></a>
</span><span id="score_linkage_vs_truth-996"><a href="#score_linkage_vs_truth-996"><span class="linenos"> 996</span></a>    <span class="n">sensitivity</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">true_positives</span> <span class="o">/</span> <span class="p">(</span><span class="n">true_positives</span> <span class="o">+</span> <span class="n">false_negatives</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="score_linkage_vs_truth-997"><a href="#score_linkage_vs_truth-997"><span class="linenos"> 997</span></a>    <span class="n">specificity</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">true_negatives</span> <span class="o">/</span> <span class="p">(</span><span class="n">true_negatives</span> <span class="o">+</span> <span class="n">false_positives</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="score_linkage_vs_truth-998"><a href="#score_linkage_vs_truth-998"><span class="linenos"> 998</span></a>    <span class="n">ppv</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">true_positives</span> <span class="o">/</span> <span class="p">(</span><span class="n">true_positives</span> <span class="o">+</span> <span class="n">false_positives</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="score_linkage_vs_truth-999"><a href="#score_linkage_vs_truth-999"><span class="linenos"> 999</span></a>    <span class="n">f1</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
</span><span id="score_linkage_vs_truth-1000"><a href="#score_linkage_vs_truth-1000"><span class="linenos">1000</span></a>        <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">true_positives</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">true_positives</span> <span class="o">+</span> <span class="n">false_negatives</span> <span class="o">+</span> <span class="n">false_positives</span><span class="p">),</span>
</span><span id="score_linkage_vs_truth-1001"><a href="#score_linkage_vs_truth-1001"><span class="linenos">1001</span></a>        <span class="mi">3</span><span class="p">,</span>
</span><span id="score_linkage_vs_truth-1002"><a href="#score_linkage_vs_truth-1002"><span class="linenos">1002</span></a>    <span class="p">)</span>
</span><span id="score_linkage_vs_truth-1003"><a href="#score_linkage_vs_truth-1003"><span class="linenos">1003</span></a>    <span class="k">return</span> <span class="p">(</span><span class="n">sensitivity</span><span class="p">,</span> <span class="n">specificity</span><span class="p">,</span> <span class="n">ppv</span><span class="p">,</span> <span class="n">f1</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Compute the statistical qualities of a run of record linkage against
known true results. This function assumes that matches have already
been determined by the algorithm, and further assumes that true
matches have already been identified in the data.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>found_matches</strong>:  A dictionary mapping IDs of records to sets of
other records which were determined to be a match.</li>
<li><strong>true_matches</strong>:  A dictionary mapping IDs of records to sets of
other records which are _known_ to be a true match.</li>
<li><strong>records_in_dataset</strong>:  The number of records in the original data
set to-link.</li>
<li><strong>expand_clusters_pairwise</strong>:  Optionally, whether we need to take
the cross-product of members within the sets of the match list. This
parameter only needs to be used if the linkage algorithm was run in
cluster mode. Default is False.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>A tuple reporting the sensitivity/precision, specificity/recall,
    positive prediction value, and F1 score of the linkage algorithm.</p>
</blockquote>
</div>


                </section>
                <section id="block_data_from_db">
                            <input id="block_data_from_db-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">block_data_from_db</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">db_name</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">block_data</span><span class="p">:</span> <span class="n">Dict</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="block_data_from_db-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#block_data_from_db"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="block_data_from_db-54"><a href="#block_data_from_db-54"><span class="linenos">54</span></a><span class="k">def</span> <span class="nf">block_data_from_db</span><span class="p">(</span><span class="n">db_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">block_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">list</span><span class="p">]:</span>
</span><span id="block_data_from_db-55"><a href="#block_data_from_db-55"><span class="linenos">55</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="block_data_from_db-56"><a href="#block_data_from_db-56"><span class="linenos">56</span></a><span class="sd">    Returns a list of lists containing records from the database that match on the</span>
</span><span id="block_data_from_db-57"><a href="#block_data_from_db-57"><span class="linenos">57</span></a><span class="sd">    incoming record&#39;s block values. If blocking on &#39;ZIP&#39; and the incoming record&#39;s zip</span>
</span><span id="block_data_from_db-58"><a href="#block_data_from_db-58"><span class="linenos">58</span></a><span class="sd">    code is &#39;90210&#39;, the resulting block of data would contain records that all have the</span>
</span><span id="block_data_from_db-59"><a href="#block_data_from_db-59"><span class="linenos">59</span></a><span class="sd">    same zip code of 90210.</span>
</span><span id="block_data_from_db-60"><a href="#block_data_from_db-60"><span class="linenos">60</span></a>
</span><span id="block_data_from_db-61"><a href="#block_data_from_db-61"><span class="linenos">61</span></a><span class="sd">    :param db_name: Database name.</span>
</span><span id="block_data_from_db-62"><a href="#block_data_from_db-62"><span class="linenos">62</span></a><span class="sd">    :param table_name: Table name.</span>
</span><span id="block_data_from_db-63"><a href="#block_data_from_db-63"><span class="linenos">63</span></a><span class="sd">    :param block_data: Dictionary containing key value pairs for the column name for</span>
</span><span id="block_data_from_db-64"><a href="#block_data_from_db-64"><span class="linenos">64</span></a><span class="sd">      blocking and the data for the incoming record, e.g., [&quot;ZIP&quot;]: &quot;90210&quot;.</span>
</span><span id="block_data_from_db-65"><a href="#block_data_from_db-65"><span class="linenos">65</span></a><span class="sd">    :return: A list of records that are within the block, e.g., records that all have</span>
</span><span id="block_data_from_db-66"><a href="#block_data_from_db-66"><span class="linenos">66</span></a><span class="sd">      90210 as their ZIP.</span>
</span><span id="block_data_from_db-67"><a href="#block_data_from_db-67"><span class="linenos">67</span></a>
</span><span id="block_data_from_db-68"><a href="#block_data_from_db-68"><span class="linenos">68</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="block_data_from_db-69"><a href="#block_data_from_db-69"><span class="linenos">69</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">block_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="block_data_from_db-70"><a href="#block_data_from_db-70"><span class="linenos">70</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`block_data` cannot be empty.&quot;</span><span class="p">)</span>
</span><span id="block_data_from_db-71"><a href="#block_data_from_db-71"><span class="linenos">71</span></a>
</span><span id="block_data_from_db-72"><a href="#block_data_from_db-72"><span class="linenos">72</span></a>    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_name</span><span class="p">)</span>
</span><span id="block_data_from_db-73"><a href="#block_data_from_db-73"><span class="linenos">73</span></a>    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span><span id="block_data_from_db-74"><a href="#block_data_from_db-74"><span class="linenos">74</span></a>    <span class="n">cursor</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">c</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">row</span><span class="p">]</span>
</span><span id="block_data_from_db-75"><a href="#block_data_from_db-75"><span class="linenos">75</span></a>
</span><span id="block_data_from_db-76"><a href="#block_data_from_db-76"><span class="linenos">76</span></a>    <span class="n">query</span> <span class="o">=</span> <span class="n">_generate_block_query</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">block_data</span><span class="p">)</span>  <span class="c1"># Generate SQL query</span>
</span><span id="block_data_from_db-77"><a href="#block_data_from_db-77"><span class="linenos">77</span></a>    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>  <span class="c1"># Execute query</span>
</span><span id="block_data_from_db-78"><a href="#block_data_from_db-78"><span class="linenos">78</span></a>    <span class="n">block</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>  <span class="c1"># Fetch data from query</span>
</span><span id="block_data_from_db-79"><a href="#block_data_from_db-79"><span class="linenos">79</span></a>    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="block_data_from_db-80"><a href="#block_data_from_db-80"><span class="linenos">80</span></a>    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="block_data_from_db-81"><a href="#block_data_from_db-81"><span class="linenos">81</span></a>
</span><span id="block_data_from_db-82"><a href="#block_data_from_db-82"><span class="linenos">82</span></a>    <span class="k">return</span> <span class="n">block</span>
</span></pre></div>


            <div class="docstring"><p>Returns a list of lists containing records from the database that match on the
incoming record's block values. If blocking on 'ZIP' and the incoming record's zip
code is '90210', the resulting block of data would contain records that all have the
same zip code of 90210.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>db_name</strong>:  Database name.</li>
<li><strong>table_name</strong>:  Table name.</li>
<li><strong>block_data</strong>:  Dictionary containing key value pairs for the column name for
blocking and the data for the incoming record, e.g., ["ZIP"]: "90210".</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>A list of records that are within the block, e.g., records that all have
    90210 as their ZIP.</p>
</blockquote>
</div>


                </section>
                <section id="_generate_block_query">
                            <input id="_generate_block_query-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">_generate_block_query</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">block_data</span><span class="p">:</span> <span class="n">Dict</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="_generate_block_query-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#_generate_block_query"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="_generate_block_query-1362"><a href="#_generate_block_query-1362"><span class="linenos">1362</span></a><span class="k">def</span> <span class="nf">_generate_block_query</span><span class="p">(</span><span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">block_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="_generate_block_query-1363"><a href="#_generate_block_query-1363"><span class="linenos">1363</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="_generate_block_query-1364"><a href="#_generate_block_query-1364"><span class="linenos">1364</span></a><span class="sd">    Generates a query for selecting a block of data from `table_name` per the block_data</span>
</span><span id="_generate_block_query-1365"><a href="#_generate_block_query-1365"><span class="linenos">1365</span></a><span class="sd">    parameters.</span>
</span><span id="_generate_block_query-1366"><a href="#_generate_block_query-1366"><span class="linenos">1366</span></a>
</span><span id="_generate_block_query-1367"><a href="#_generate_block_query-1367"><span class="linenos">1367</span></a><span class="sd">    :param table_name: Table name.</span>
</span><span id="_generate_block_query-1368"><a href="#_generate_block_query-1368"><span class="linenos">1368</span></a><span class="sd">    :param block_data: Dictionary containing key value pairs for the column name you for</span>
</span><span id="_generate_block_query-1369"><a href="#_generate_block_query-1369"><span class="linenos">1369</span></a><span class="sd">      blocking and the data for the incoming record, e.g., [&quot;ZIP&quot;]: &quot;90210&quot;.</span>
</span><span id="_generate_block_query-1370"><a href="#_generate_block_query-1370"><span class="linenos">1370</span></a><span class="sd">    :return: Query to select block of data base on `block_data` parameters.</span>
</span><span id="_generate_block_query-1371"><a href="#_generate_block_query-1371"><span class="linenos">1371</span></a>
</span><span id="_generate_block_query-1372"><a href="#_generate_block_query-1372"><span class="linenos">1372</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="_generate_block_query-1373"><a href="#_generate_block_query-1373"><span class="linenos">1373</span></a>    <span class="n">query_stub</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> WHERE &quot;</span>
</span><span id="_generate_block_query-1374"><a href="#_generate_block_query-1374"><span class="linenos">1374</span></a>    <span class="n">block_query</span> <span class="o">=</span> <span class="s2">&quot; AND &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="_generate_block_query-1375"><a href="#_generate_block_query-1375"><span class="linenos">1375</span></a>        <span class="p">[</span>
</span><span id="_generate_block_query-1376"><a href="#_generate_block_query-1376"><span class="linenos">1376</span></a>            <span class="n">key</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; = &#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="k">else</span> <span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; = </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="_generate_block_query-1377"><a href="#_generate_block_query-1377"><span class="linenos">1377</span></a>            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">block_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="_generate_block_query-1378"><a href="#_generate_block_query-1378"><span class="linenos">1378</span></a>        <span class="p">]</span>
</span><span id="_generate_block_query-1379"><a href="#_generate_block_query-1379"><span class="linenos">1379</span></a>    <span class="p">)</span>
</span><span id="_generate_block_query-1380"><a href="#_generate_block_query-1380"><span class="linenos">1380</span></a>    <span class="n">query</span> <span class="o">=</span> <span class="n">query_stub</span> <span class="o">+</span> <span class="n">block_query</span>
</span><span id="_generate_block_query-1381"><a href="#_generate_block_query-1381"><span class="linenos">1381</span></a>    <span class="k">return</span> <span class="n">query</span>
</span></pre></div>


            <div class="docstring"><p>Generates a query for selecting a block of data from <code>table_name</code> per the block_data
parameters.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>table_name</strong>:  Table name.</li>
<li><strong>block_data</strong>:  Dictionary containing key value pairs for the column name you for
blocking and the data for the incoming record, e.g., ["ZIP"]: "90210".</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Query to select block of data base on <code><a href="#block_data">block_data</a></code> parameters.</p>
</blockquote>
</div>


                </section>
                <section id="calculate_m_probs">
                            <input id="calculate_m_probs-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">calculate_m_probs</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">data</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>,</span><span class="param">	<span class="n">true_matches</span><span class="p">:</span> <span class="nb">dict</span>,</span><span class="param">	<span class="n">cols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">file_to_write</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="calculate_m_probs-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#calculate_m_probs"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="calculate_m_probs-139"><a href="#calculate_m_probs-139"><span class="linenos">139</span></a><span class="k">def</span> <span class="nf">calculate_m_probs</span><span class="p">(</span>
</span><span id="calculate_m_probs-140"><a href="#calculate_m_probs-140"><span class="linenos">140</span></a>    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
</span><span id="calculate_m_probs-141"><a href="#calculate_m_probs-141"><span class="linenos">141</span></a>    <span class="n">true_matches</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
</span><span id="calculate_m_probs-142"><a href="#calculate_m_probs-142"><span class="linenos">142</span></a>    <span class="n">cols</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="calculate_m_probs-143"><a href="#calculate_m_probs-143"><span class="linenos">143</span></a>    <span class="n">file_to_write</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="calculate_m_probs-144"><a href="#calculate_m_probs-144"><span class="linenos">144</span></a><span class="p">):</span>
</span><span id="calculate_m_probs-145"><a href="#calculate_m_probs-145"><span class="linenos">145</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="calculate_m_probs-146"><a href="#calculate_m_probs-146"><span class="linenos">146</span></a><span class="sd">    For a given set of patient records, calculate the per-field</span>
</span><span id="calculate_m_probs-147"><a href="#calculate_m_probs-147"><span class="linenos">147</span></a><span class="sd">    m-probability. The m-probability for field X is defined as the</span>
</span><span id="calculate_m_probs-148"><a href="#calculate_m_probs-148"><span class="linenos">148</span></a><span class="sd">    probability that a pair of records A and B have the same value in</span>
</span><span id="calculate_m_probs-149"><a href="#calculate_m_probs-149"><span class="linenos">149</span></a><span class="sd">    X, given that A and B are a true matching pair. This function</span>
</span><span id="calculate_m_probs-150"><a href="#calculate_m_probs-150"><span class="linenos">150</span></a><span class="sd">    incorporates LaPlacian Smoothing to account for unseen data and</span>
</span><span id="calculate_m_probs-151"><a href="#calculate_m_probs-151"><span class="linenos">151</span></a><span class="sd">    to resolve future logarithms against 0.</span>
</span><span id="calculate_m_probs-152"><a href="#calculate_m_probs-152"><span class="linenos">152</span></a>
</span><span id="calculate_m_probs-153"><a href="#calculate_m_probs-153"><span class="linenos">153</span></a><span class="sd">    :param data: A pandas dataframe of patient records to compute</span>
</span><span id="calculate_m_probs-154"><a href="#calculate_m_probs-154"><span class="linenos">154</span></a><span class="sd">      probabilities for.</span>
</span><span id="calculate_m_probs-155"><a href="#calculate_m_probs-155"><span class="linenos">155</span></a><span class="sd">    :param true_matches: A dictionary holding the IDs of record pairs</span>
</span><span id="calculate_m_probs-156"><a href="#calculate_m_probs-156"><span class="linenos">156</span></a><span class="sd">      that are true matches in the data set. The format of the dictionary</span>
</span><span id="calculate_m_probs-157"><a href="#calculate_m_probs-157"><span class="linenos">157</span></a><span class="sd">      should be such that the IDs of the &quot;lower numbered&quot; records in each</span>
</span><span id="calculate_m_probs-158"><a href="#calculate_m_probs-158"><span class="linenos">158</span></a><span class="sd">      match pair are the keys, and the values are sets of the &quot;higher</span>
</span><span id="calculate_m_probs-159"><a href="#calculate_m_probs-159"><span class="linenos">159</span></a><span class="sd">      numbered&quot; records in each pair.</span>
</span><span id="calculate_m_probs-160"><a href="#calculate_m_probs-160"><span class="linenos">160</span></a><span class="sd">    :param cols: Optionally, a list of columns to compute probabilities</span>
</span><span id="calculate_m_probs-161"><a href="#calculate_m_probs-161"><span class="linenos">161</span></a><span class="sd">      for. If not supplied, computes probabilities across all fields.</span>
</span><span id="calculate_m_probs-162"><a href="#calculate_m_probs-162"><span class="linenos">162</span></a><span class="sd">      Default is None.</span>
</span><span id="calculate_m_probs-163"><a href="#calculate_m_probs-163"><span class="linenos">163</span></a><span class="sd">    :param file_to_write: Optionally, a destination filepath at which to</span>
</span><span id="calculate_m_probs-164"><a href="#calculate_m_probs-164"><span class="linenos">164</span></a><span class="sd">      write the probabilities in JSON format. Default is None.</span>
</span><span id="calculate_m_probs-165"><a href="#calculate_m_probs-165"><span class="linenos">165</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="calculate_m_probs-166"><a href="#calculate_m_probs-166"><span class="linenos">166</span></a>    <span class="k">if</span> <span class="n">cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="calculate_m_probs-167"><a href="#calculate_m_probs-167"><span class="linenos">167</span></a>        <span class="n">cols</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="calculate_m_probs-168"><a href="#calculate_m_probs-168"><span class="linenos">168</span></a>    <span class="n">m_probs</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="mf">1.0</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">}</span>
</span><span id="calculate_m_probs-169"><a href="#calculate_m_probs-169"><span class="linenos">169</span></a>    <span class="n">total_pairs</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="calculate_m_probs-170"><a href="#calculate_m_probs-170"><span class="linenos">170</span></a>    <span class="k">for</span> <span class="n">root_record</span><span class="p">,</span> <span class="n">paired_records</span> <span class="ow">in</span> <span class="n">true_matches</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="calculate_m_probs-171"><a href="#calculate_m_probs-171"><span class="linenos">171</span></a>        <span class="n">total_pairs</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paired_records</span><span class="p">)</span>
</span><span id="calculate_m_probs-172"><a href="#calculate_m_probs-172"><span class="linenos">172</span></a>        <span class="k">for</span> <span class="n">pr</span> <span class="ow">in</span> <span class="n">paired_records</span><span class="p">:</span>
</span><span id="calculate_m_probs-173"><a href="#calculate_m_probs-173"><span class="linenos">173</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
</span><span id="calculate_m_probs-174"><a href="#calculate_m_probs-174"><span class="linenos">174</span></a>                <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">root_record</span><span class="p">]</span> <span class="o">==</span> <span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">pr</span><span class="p">]:</span>
</span><span id="calculate_m_probs-175"><a href="#calculate_m_probs-175"><span class="linenos">175</span></a>                    <span class="n">m_probs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="calculate_m_probs-176"><a href="#calculate_m_probs-176"><span class="linenos">176</span></a>    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
</span><span id="calculate_m_probs-177"><a href="#calculate_m_probs-177"><span class="linenos">177</span></a>        <span class="n">m_probs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">/=</span> <span class="n">total_pairs</span>
</span><span id="calculate_m_probs-178"><a href="#calculate_m_probs-178"><span class="linenos">178</span></a>
</span><span id="calculate_m_probs-179"><a href="#calculate_m_probs-179"><span class="linenos">179</span></a>    <span class="n">_write_prob_file</span><span class="p">(</span><span class="n">m_probs</span><span class="p">,</span> <span class="n">file_to_write</span><span class="p">)</span>
</span><span id="calculate_m_probs-180"><a href="#calculate_m_probs-180"><span class="linenos">180</span></a>    <span class="k">return</span> <span class="n">m_probs</span>
</span></pre></div>


            <div class="docstring"><p>For a given set of patient records, calculate the per-field
m-probability. The m-probability for field X is defined as the
probability that a pair of records A and B have the same value in
X, given that A and B are a true matching pair. This function
incorporates LaPlacian Smoothing to account for unseen data and
to resolve future logarithms against 0.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>data</strong>:  A pandas dataframe of patient records to compute
probabilities for.</li>
<li><strong>true_matches</strong>:  A dictionary holding the IDs of record pairs
that are true matches in the data set. The format of the dictionary
should be such that the IDs of the "lower numbered" records in each
match pair are the keys, and the values are sets of the "higher
numbered" records in each pair.</li>
<li><strong>cols</strong>:  Optionally, a list of columns to compute probabilities
for. If not supplied, computes probabilities across all fields.
Default is None.</li>
<li><strong>file_to_write</strong>:  Optionally, a destination filepath at which to
write the probabilities in JSON format. Default is None.</li>
</ul>
</div>


                </section>
                <section id="calculate_u_probs">
                            <input id="calculate_u_probs-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">calculate_u_probs</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">data</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>,</span><span class="param">	<span class="n">true_matches</span><span class="p">:</span> <span class="nb">dict</span>,</span><span class="param">	<span class="n">n_samples</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">cols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">file_to_write</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="calculate_u_probs-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#calculate_u_probs"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="calculate_u_probs-187"><a href="#calculate_u_probs-187"><span class="linenos">187</span></a><span class="k">def</span> <span class="nf">calculate_u_probs</span><span class="p">(</span>
</span><span id="calculate_u_probs-188"><a href="#calculate_u_probs-188"><span class="linenos">188</span></a>    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
</span><span id="calculate_u_probs-189"><a href="#calculate_u_probs-189"><span class="linenos">189</span></a>    <span class="n">true_matches</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
</span><span id="calculate_u_probs-190"><a href="#calculate_u_probs-190"><span class="linenos">190</span></a>    <span class="n">n_samples</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="calculate_u_probs-191"><a href="#calculate_u_probs-191"><span class="linenos">191</span></a>    <span class="n">cols</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="calculate_u_probs-192"><a href="#calculate_u_probs-192"><span class="linenos">192</span></a>    <span class="n">file_to_write</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="calculate_u_probs-193"><a href="#calculate_u_probs-193"><span class="linenos">193</span></a><span class="p">):</span>
</span><span id="calculate_u_probs-194"><a href="#calculate_u_probs-194"><span class="linenos">194</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="calculate_u_probs-195"><a href="#calculate_u_probs-195"><span class="linenos">195</span></a><span class="sd">    For a given set of patient records, calculate the per-field</span>
</span><span id="calculate_u_probs-196"><a href="#calculate_u_probs-196"><span class="linenos">196</span></a><span class="sd">    u-probability. The u-probability for field X is defined as the</span>
</span><span id="calculate_u_probs-197"><a href="#calculate_u_probs-197"><span class="linenos">197</span></a><span class="sd">    probability that a pair of records A and B have the same value in</span>
</span><span id="calculate_u_probs-198"><a href="#calculate_u_probs-198"><span class="linenos">198</span></a><span class="sd">    X, given that A and B are not a true matching pair. This function</span>
</span><span id="calculate_u_probs-199"><a href="#calculate_u_probs-199"><span class="linenos">199</span></a><span class="sd">    incorporates LaPlacian Smoothing to account for unseen data and</span>
</span><span id="calculate_u_probs-200"><a href="#calculate_u_probs-200"><span class="linenos">200</span></a><span class="sd">    to handle future logarithms against 0.</span>
</span><span id="calculate_u_probs-201"><a href="#calculate_u_probs-201"><span class="linenos">201</span></a>
</span><span id="calculate_u_probs-202"><a href="#calculate_u_probs-202"><span class="linenos">202</span></a><span class="sd">    Note: This function can be slow to compute for large data sets.</span>
</span><span id="calculate_u_probs-203"><a href="#calculate_u_probs-203"><span class="linenos">203</span></a><span class="sd">    It is recommended to pass only a representative subsample of the</span>
</span><span id="calculate_u_probs-204"><a href="#calculate_u_probs-204"><span class="linenos">204</span></a><span class="sd">    data to the function (we recommend sampling ~25k candidate pairs</span>
</span><span id="calculate_u_probs-205"><a href="#calculate_u_probs-205"><span class="linenos">205</span></a><span class="sd">    from a sub-sample of ~25k records), even if the sample operation</span>
</span><span id="calculate_u_probs-206"><a href="#calculate_u_probs-206"><span class="linenos">206</span></a><span class="sd">    is used.</span>
</span><span id="calculate_u_probs-207"><a href="#calculate_u_probs-207"><span class="linenos">207</span></a>
</span><span id="calculate_u_probs-208"><a href="#calculate_u_probs-208"><span class="linenos">208</span></a><span class="sd">    :param data: A pandas dataframe of patient records to compute</span>
</span><span id="calculate_u_probs-209"><a href="#calculate_u_probs-209"><span class="linenos">209</span></a><span class="sd">      probabilities for.</span>
</span><span id="calculate_u_probs-210"><a href="#calculate_u_probs-210"><span class="linenos">210</span></a><span class="sd">    :param true_matches: A dictionary holding the IDs of record pairs</span>
</span><span id="calculate_u_probs-211"><a href="#calculate_u_probs-211"><span class="linenos">211</span></a><span class="sd">      that are true matches in the data set. The format of the dictionary</span>
</span><span id="calculate_u_probs-212"><a href="#calculate_u_probs-212"><span class="linenos">212</span></a><span class="sd">      should be such that the IDs of the &quot;lower numbered&quot; records in each</span>
</span><span id="calculate_u_probs-213"><a href="#calculate_u_probs-213"><span class="linenos">213</span></a><span class="sd">      match pair are the keys, and the values are sets of the &quot;higher</span>
</span><span id="calculate_u_probs-214"><a href="#calculate_u_probs-214"><span class="linenos">214</span></a><span class="sd">      numbered&quot; records in each pair.</span>
</span><span id="calculate_u_probs-215"><a href="#calculate_u_probs-215"><span class="linenos">215</span></a><span class="sd">    :param n_samples: Optionally, a number of samples to take from the</span>
</span><span id="calculate_u_probs-216"><a href="#calculate_u_probs-216"><span class="linenos">216</span></a><span class="sd">      list of possible pairs to compute probabilities over.</span>
</span><span id="calculate_u_probs-217"><a href="#calculate_u_probs-217"><span class="linenos">217</span></a><span class="sd">    :param cols: Optionally, a list of columns to compute probabilities</span>
</span><span id="calculate_u_probs-218"><a href="#calculate_u_probs-218"><span class="linenos">218</span></a><span class="sd">      for. If not supplied, computes probabilities across all fields.</span>
</span><span id="calculate_u_probs-219"><a href="#calculate_u_probs-219"><span class="linenos">219</span></a><span class="sd">      Default is None.</span>
</span><span id="calculate_u_probs-220"><a href="#calculate_u_probs-220"><span class="linenos">220</span></a><span class="sd">    :param file_to_write: Optionally, a destination filepath at which to</span>
</span><span id="calculate_u_probs-221"><a href="#calculate_u_probs-221"><span class="linenos">221</span></a><span class="sd">      write the probabilities in JSON format. Default is None.</span>
</span><span id="calculate_u_probs-222"><a href="#calculate_u_probs-222"><span class="linenos">222</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="calculate_u_probs-223"><a href="#calculate_u_probs-223"><span class="linenos">223</span></a>    <span class="k">if</span> <span class="n">cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="calculate_u_probs-224"><a href="#calculate_u_probs-224"><span class="linenos">224</span></a>        <span class="n">cols</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span>
</span><span id="calculate_u_probs-225"><a href="#calculate_u_probs-225"><span class="linenos">225</span></a>
</span><span id="calculate_u_probs-226"><a href="#calculate_u_probs-226"><span class="linenos">226</span></a>    <span class="n">u_probs</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="mf">1.0</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">}</span>
</span><span id="calculate_u_probs-227"><a href="#calculate_u_probs-227"><span class="linenos">227</span></a>
</span><span id="calculate_u_probs-228"><a href="#calculate_u_probs-228"><span class="linenos">228</span></a>    <span class="c1"># Want only the pairs of candidates that aren&#39;t true matches</span>
</span><span id="calculate_u_probs-229"><a href="#calculate_u_probs-229"><span class="linenos">229</span></a>    <span class="n">base_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="calculate_u_probs-230"><a href="#calculate_u_probs-230"><span class="linenos">230</span></a>    <span class="n">neg_pairs</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="calculate_u_probs-231"><a href="#calculate_u_probs-231"><span class="linenos">231</span></a>        <span class="n">x</span>
</span><span id="calculate_u_probs-232"><a href="#calculate_u_probs-232"><span class="linenos">232</span></a>        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">base_pairs</span>
</span><span id="calculate_u_probs-233"><a href="#calculate_u_probs-233"><span class="linenos">233</span></a>        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">true_matches</span> <span class="ow">or</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">true_matches</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="calculate_u_probs-234"><a href="#calculate_u_probs-234"><span class="linenos">234</span></a>    <span class="p">]</span>
</span><span id="calculate_u_probs-235"><a href="#calculate_u_probs-235"><span class="linenos">235</span></a>
</span><span id="calculate_u_probs-236"><a href="#calculate_u_probs-236"><span class="linenos">236</span></a>    <span class="k">if</span> <span class="n">n_samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">n_samples</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_pairs</span><span class="p">):</span>
</span><span id="calculate_u_probs-237"><a href="#calculate_u_probs-237"><span class="linenos">237</span></a>        <span class="n">neg_pairs</span> <span class="o">=</span> <span class="n">sample</span><span class="p">(</span><span class="n">neg_pairs</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
</span><span id="calculate_u_probs-238"><a href="#calculate_u_probs-238"><span class="linenos">238</span></a>    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">neg_pairs</span><span class="p">:</span>
</span><span id="calculate_u_probs-239"><a href="#calculate_u_probs-239"><span class="linenos">239</span></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
</span><span id="calculate_u_probs-240"><a href="#calculate_u_probs-240"><span class="linenos">240</span></a>            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">==</span> <span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">]]:</span>
</span><span id="calculate_u_probs-241"><a href="#calculate_u_probs-241"><span class="linenos">241</span></a>                <span class="n">u_probs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.0</span>
</span><span id="calculate_u_probs-242"><a href="#calculate_u_probs-242"><span class="linenos">242</span></a>
</span><span id="calculate_u_probs-243"><a href="#calculate_u_probs-243"><span class="linenos">243</span></a>    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
</span><span id="calculate_u_probs-244"><a href="#calculate_u_probs-244"><span class="linenos">244</span></a>        <span class="k">if</span> <span class="n">n_samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">n_samples</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_pairs</span><span class="p">):</span>
</span><span id="calculate_u_probs-245"><a href="#calculate_u_probs-245"><span class="linenos">245</span></a>            <span class="n">u_probs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_probs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_samples</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>
</span><span id="calculate_u_probs-246"><a href="#calculate_u_probs-246"><span class="linenos">246</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="calculate_u_probs-247"><a href="#calculate_u_probs-247"><span class="linenos">247</span></a>            <span class="n">u_probs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_probs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">neg_pairs</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>
</span><span id="calculate_u_probs-248"><a href="#calculate_u_probs-248"><span class="linenos">248</span></a>
</span><span id="calculate_u_probs-249"><a href="#calculate_u_probs-249"><span class="linenos">249</span></a>    <span class="n">_write_prob_file</span><span class="p">(</span><span class="n">u_probs</span><span class="p">,</span> <span class="n">file_to_write</span><span class="p">)</span>
</span><span id="calculate_u_probs-250"><a href="#calculate_u_probs-250"><span class="linenos">250</span></a>    <span class="k">return</span> <span class="n">u_probs</span>
</span></pre></div>


            <div class="docstring"><p>For a given set of patient records, calculate the per-field
u-probability. The u-probability for field X is defined as the
probability that a pair of records A and B have the same value in
X, given that A and B are not a true matching pair. This function
incorporates LaPlacian Smoothing to account for unseen data and
to handle future logarithms against 0.</p>

<p>Note: This function can be slow to compute for large data sets.
It is recommended to pass only a representative subsample of the
data to the function (we recommend sampling ~25k candidate pairs
from a sub-sample of ~25k records), even if the sample operation
is used.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>data</strong>:  A pandas dataframe of patient records to compute
probabilities for.</li>
<li><strong>true_matches</strong>:  A dictionary holding the IDs of record pairs
that are true matches in the data set. The format of the dictionary
should be such that the IDs of the "lower numbered" records in each
match pair are the keys, and the values are sets of the "higher
numbered" records in each pair.</li>
<li><strong>n_samples</strong>:  Optionally, a number of samples to take from the
list of possible pairs to compute probabilities over.</li>
<li><strong>cols</strong>:  Optionally, a list of columns to compute probabilities
for. If not supplied, computes probabilities across all fields.
Default is None.</li>
<li><strong>file_to_write</strong>:  Optionally, a destination filepath at which to
write the probabilities in JSON format. Default is None.</li>
</ul>
</div>


                </section>
                <section id="load_json_probs">
                            <input id="load_json_probs-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">load_json_probs</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">path</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="load_json_probs-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#load_json_probs"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="load_json_probs-654"><a href="#load_json_probs-654"><span class="linenos">654</span></a><span class="k">def</span> <span class="nf">load_json_probs</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">):</span>
</span><span id="load_json_probs-655"><a href="#load_json_probs-655"><span class="linenos">655</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="load_json_probs-656"><a href="#load_json_probs-656"><span class="linenos">656</span></a><span class="sd">    Load a dictionary of probabilities from a JSON-formatted file.</span>
</span><span id="load_json_probs-657"><a href="#load_json_probs-657"><span class="linenos">657</span></a><span class="sd">    The probabilities correspond to previously computed m-, u-, or</span>
</span><span id="load_json_probs-658"><a href="#load_json_probs-658"><span class="linenos">658</span></a><span class="sd">    log-odds probabilities derived from patient records, with one</span>
</span><span id="load_json_probs-659"><a href="#load_json_probs-659"><span class="linenos">659</span></a><span class="sd">    score for each field (column) appearing in the data.</span>
</span><span id="load_json_probs-660"><a href="#load_json_probs-660"><span class="linenos">660</span></a>
</span><span id="load_json_probs-661"><a href="#load_json_probs-661"><span class="linenos">661</span></a><span class="sd">    :param path: The file path to load the data from.</span>
</span><span id="load_json_probs-662"><a href="#load_json_probs-662"><span class="linenos">662</span></a><span class="sd">    :return: A dictionary of probability scores, one for each field</span>
</span><span id="load_json_probs-663"><a href="#load_json_probs-663"><span class="linenos">663</span></a><span class="sd">      in the data set on which they were computed.</span>
</span><span id="load_json_probs-664"><a href="#load_json_probs-664"><span class="linenos">664</span></a><span class="sd">    :raises FileNotFoundError: If a file does not exist at the given</span>
</span><span id="load_json_probs-665"><a href="#load_json_probs-665"><span class="linenos">665</span></a><span class="sd">      path.</span>
</span><span id="load_json_probs-666"><a href="#load_json_probs-666"><span class="linenos">666</span></a><span class="sd">    :raises JSONDecodeError: If the file cannot be read as valid JSON.</span>
</span><span id="load_json_probs-667"><a href="#load_json_probs-667"><span class="linenos">667</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="load_json_probs-668"><a href="#load_json_probs-668"><span class="linenos">668</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="load_json_probs-669"><a href="#load_json_probs-669"><span class="linenos">669</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="load_json_probs-670"><a href="#load_json_probs-670"><span class="linenos">670</span></a>            <span class="n">prob_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span id="load_json_probs-671"><a href="#load_json_probs-671"><span class="linenos">671</span></a>        <span class="k">return</span> <span class="n">prob_dict</span>
</span><span id="load_json_probs-672"><a href="#load_json_probs-672"><span class="linenos">672</span></a>    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
</span><span id="load_json_probs-673"><a href="#load_json_probs-673"><span class="linenos">673</span></a>        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The specified file does not exist at </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="load_json_probs-674"><a href="#load_json_probs-674"><span class="linenos">674</span></a>    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="load_json_probs-675"><a href="#load_json_probs-675"><span class="linenos">675</span></a>        <span class="k">raise</span> <span class="n">json</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">(</span>
</span><span id="load_json_probs-676"><a href="#load_json_probs-676"><span class="linenos">676</span></a>            <span class="s2">&quot;The specified file is not valid JSON.&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">doc</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">pos</span>
</span><span id="load_json_probs-677"><a href="#load_json_probs-677"><span class="linenos">677</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Load a dictionary of probabilities from a JSON-formatted file.
The probabilities correspond to previously computed m-, u-, or
log-odds probabilities derived from patient records, with one
score for each field (column) appearing in the data.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>path</strong>:  The file path to load the data from.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>A dictionary of probability scores, one for each field
    in the data set on which they were computed.</p>
</blockquote>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>FileNotFoundError</strong>:  If a file does not exist at the given
path.</li>
<li><strong>JSONDecodeError</strong>:  If the file cannot be read as valid JSON.</li>
</ul>
</div>


                </section>
                <section id="calculate_log_odds">
                            <input id="calculate_log_odds-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">calculate_log_odds</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">m_probs</span><span class="p">:</span> <span class="nb">dict</span>,</span><span class="param">	<span class="n">u_probs</span><span class="p">:</span> <span class="nb">dict</span>,</span><span class="param">	<span class="n">file_to_write</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="calculate_log_odds-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#calculate_log_odds"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="calculate_log_odds-106"><a href="#calculate_log_odds-106"><span class="linenos">106</span></a><span class="k">def</span> <span class="nf">calculate_log_odds</span><span class="p">(</span>
</span><span id="calculate_log_odds-107"><a href="#calculate_log_odds-107"><span class="linenos">107</span></a>    <span class="n">m_probs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
</span><span id="calculate_log_odds-108"><a href="#calculate_log_odds-108"><span class="linenos">108</span></a>    <span class="n">u_probs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
</span><span id="calculate_log_odds-109"><a href="#calculate_log_odds-109"><span class="linenos">109</span></a>    <span class="n">file_to_write</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="calculate_log_odds-110"><a href="#calculate_log_odds-110"><span class="linenos">110</span></a><span class="p">):</span>
</span><span id="calculate_log_odds-111"><a href="#calculate_log_odds-111"><span class="linenos">111</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="calculate_log_odds-112"><a href="#calculate_log_odds-112"><span class="linenos">112</span></a><span class="sd">    Calculate the per-field log odds ratio score that two records will</span>
</span><span id="calculate_log_odds-113"><a href="#calculate_log_odds-113"><span class="linenos">113</span></a><span class="sd">    match in a given field. Measures the likelihood that two records</span>
</span><span id="calculate_log_odds-114"><a href="#calculate_log_odds-114"><span class="linenos">114</span></a><span class="sd">    match on a column due to being a true match as opposed to random</span>
</span><span id="calculate_log_odds-115"><a href="#calculate_log_odds-115"><span class="linenos">115</span></a><span class="sd">    chance.</span>
</span><span id="calculate_log_odds-116"><a href="#calculate_log_odds-116"><span class="linenos">116</span></a>
</span><span id="calculate_log_odds-117"><a href="#calculate_log_odds-117"><span class="linenos">117</span></a><span class="sd">    :param m_probs: A dictionary of m-probabilities computed per field.</span>
</span><span id="calculate_log_odds-118"><a href="#calculate_log_odds-118"><span class="linenos">118</span></a><span class="sd">    :param u_probs: A dictionary of u_probabilities computed per field.</span>
</span><span id="calculate_log_odds-119"><a href="#calculate_log_odds-119"><span class="linenos">119</span></a><span class="sd">    :param file_to_write: Optionally, a destination filepath at which</span>
</span><span id="calculate_log_odds-120"><a href="#calculate_log_odds-120"><span class="linenos">120</span></a><span class="sd">      to write the probabilities in JSON format. Default is None.</span>
</span><span id="calculate_log_odds-121"><a href="#calculate_log_odds-121"><span class="linenos">121</span></a><span class="sd">    :raises ValueError: If the supplied m- and u- probability dictionaries</span>
</span><span id="calculate_log_odds-122"><a href="#calculate_log_odds-122"><span class="linenos">122</span></a><span class="sd">      do not share an equal key set.</span>
</span><span id="calculate_log_odds-123"><a href="#calculate_log_odds-123"><span class="linenos">123</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="calculate_log_odds-124"><a href="#calculate_log_odds-124"><span class="linenos">124</span></a>    <span class="k">if</span> <span class="n">m_probs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">!=</span> <span class="n">u_probs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="calculate_log_odds-125"><a href="#calculate_log_odds-125"><span class="linenos">125</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="calculate_log_odds-126"><a href="#calculate_log_odds-126"><span class="linenos">126</span></a>            <span class="s2">&quot;m- and u- probability dictionaries must contain the same set of keys&quot;</span>
</span><span id="calculate_log_odds-127"><a href="#calculate_log_odds-127"><span class="linenos">127</span></a>        <span class="p">)</span>
</span><span id="calculate_log_odds-128"><a href="#calculate_log_odds-128"><span class="linenos">128</span></a>    <span class="n">log_odds</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="calculate_log_odds-129"><a href="#calculate_log_odds-129"><span class="linenos">129</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">m_probs</span><span class="p">:</span>
</span><span id="calculate_log_odds-130"><a href="#calculate_log_odds-130"><span class="linenos">130</span></a>        <span class="n">log_odds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="n">m_probs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">-</span> <span class="n">log</span><span class="p">(</span><span class="n">u_probs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
</span><span id="calculate_log_odds-131"><a href="#calculate_log_odds-131"><span class="linenos">131</span></a>    <span class="n">_write_prob_file</span><span class="p">(</span><span class="n">log_odds</span><span class="p">,</span> <span class="n">file_to_write</span><span class="p">)</span>
</span><span id="calculate_log_odds-132"><a href="#calculate_log_odds-132"><span class="linenos">132</span></a>    <span class="k">return</span> <span class="n">log_odds</span>
</span></pre></div>


            <div class="docstring"><p>Calculate the per-field log odds ratio score that two records will
match in a given field. Measures the likelihood that two records
match on a column due to being a true match as opposed to random
chance.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>m_probs</strong>:  A dictionary of m-probabilities computed per field.</li>
<li><strong>u_probs</strong>:  A dictionary of u_probabilities computed per field.</li>
<li><strong>file_to_write</strong>:  Optionally, a destination filepath at which
to write the probabilities in JSON format. Default is None.</li>
</ul>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>ValueError</strong>:  If the supplied m- and u- probability dictionaries
do not share an equal key set.</li>
</ul>
</div>


                </section>
                <section id="feature_match_log_odds_exact">
                            <input id="feature_match_log_odds_exact-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">feature_match_log_odds_exact</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">record_i</span><span class="p">:</span> <span class="n">List</span>, </span><span class="param"><span class="n">record_j</span><span class="p">:</span> <span class="n">List</span>, </span><span class="param"><span class="n">feature_x</span><span class="p">:</span> <span class="nb">int</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="feature_match_log_odds_exact-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#feature_match_log_odds_exact"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="feature_match_log_odds_exact-475"><a href="#feature_match_log_odds_exact-475"><span class="linenos">475</span></a><span class="k">def</span> <span class="nf">feature_match_log_odds_exact</span><span class="p">(</span>
</span><span id="feature_match_log_odds_exact-476"><a href="#feature_match_log_odds_exact-476"><span class="linenos">476</span></a>    <span class="n">record_i</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">record_j</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">feature_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span>
</span><span id="feature_match_log_odds_exact-477"><a href="#feature_match_log_odds_exact-477"><span class="linenos">477</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="feature_match_log_odds_exact-478"><a href="#feature_match_log_odds_exact-478"><span class="linenos">478</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="feature_match_log_odds_exact-479"><a href="#feature_match_log_odds_exact-479"><span class="linenos">479</span></a><span class="sd">    Determines whether two feature values in two records should earn the full</span>
</span><span id="feature_match_log_odds_exact-480"><a href="#feature_match_log_odds_exact-480"><span class="linenos">480</span></a><span class="sd">    log-odds similarity score (i.e. they match exactly) or whether they</span>
</span><span id="feature_match_log_odds_exact-481"><a href="#feature_match_log_odds_exact-481"><span class="linenos">481</span></a><span class="sd">    should earn no weight (they differ). Used for fields for which fuzzy</span>
</span><span id="feature_match_log_odds_exact-482"><a href="#feature_match_log_odds_exact-482"><span class="linenos">482</span></a><span class="sd">    comparisons are inappropriate, such as sex.</span>
</span><span id="feature_match_log_odds_exact-483"><a href="#feature_match_log_odds_exact-483"><span class="linenos">483</span></a>
</span><span id="feature_match_log_odds_exact-484"><a href="#feature_match_log_odds_exact-484"><span class="linenos">484</span></a><span class="sd">    :param record_i: One of the records in the candidate pair to evaluate.</span>
</span><span id="feature_match_log_odds_exact-485"><a href="#feature_match_log_odds_exact-485"><span class="linenos">485</span></a><span class="sd">    :param record_j: The second record in the candidate pair.</span>
</span><span id="feature_match_log_odds_exact-486"><a href="#feature_match_log_odds_exact-486"><span class="linenos">486</span></a><span class="sd">    :param feature_x: A number representing the index of the feature to</span>
</span><span id="feature_match_log_odds_exact-487"><a href="#feature_match_log_odds_exact-487"><span class="linenos">487</span></a><span class="sd">      compare for a partial match.</span>
</span><span id="feature_match_log_odds_exact-488"><a href="#feature_match_log_odds_exact-488"><span class="linenos">488</span></a><span class="sd">    :return: A float of the score the feature comparison earned.</span>
</span><span id="feature_match_log_odds_exact-489"><a href="#feature_match_log_odds_exact-489"><span class="linenos">489</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="feature_match_log_odds_exact-490"><a href="#feature_match_log_odds_exact-490"><span class="linenos">490</span></a>    <span class="k">if</span> <span class="s2">&quot;idx_to_col&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="feature_match_log_odds_exact-491"><a href="#feature_match_log_odds_exact-491"><span class="linenos">491</span></a>        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Mapping of indices to column names must be provided.&quot;</span><span class="p">)</span>
</span><span id="feature_match_log_odds_exact-492"><a href="#feature_match_log_odds_exact-492"><span class="linenos">492</span></a>    <span class="k">if</span> <span class="s2">&quot;log_odds&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="feature_match_log_odds_exact-493"><a href="#feature_match_log_odds_exact-493"><span class="linenos">493</span></a>        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Mapping of columns to m/u log-odds must be provided.&quot;</span><span class="p">)</span>
</span><span id="feature_match_log_odds_exact-494"><a href="#feature_match_log_odds_exact-494"><span class="linenos">494</span></a>    <span class="n">col</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;idx_to_col&quot;</span><span class="p">][</span><span class="n">feature_x</span><span class="p">]</span>
</span><span id="feature_match_log_odds_exact-495"><a href="#feature_match_log_odds_exact-495"><span class="linenos">495</span></a>    <span class="n">col_odds</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;log_odds&quot;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
</span><span id="feature_match_log_odds_exact-496"><a href="#feature_match_log_odds_exact-496"><span class="linenos">496</span></a>    <span class="k">if</span> <span class="n">record_i</span><span class="p">[</span><span class="n">feature_x</span><span class="p">]</span> <span class="o">==</span> <span class="n">record_j</span><span class="p">[</span><span class="n">feature_x</span><span class="p">]:</span>
</span><span id="feature_match_log_odds_exact-497"><a href="#feature_match_log_odds_exact-497"><span class="linenos">497</span></a>        <span class="k">return</span> <span class="n">col_odds</span>
</span><span id="feature_match_log_odds_exact-498"><a href="#feature_match_log_odds_exact-498"><span class="linenos">498</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="feature_match_log_odds_exact-499"><a href="#feature_match_log_odds_exact-499"><span class="linenos">499</span></a>        <span class="k">return</span> <span class="mf">0.0</span>
</span></pre></div>


            <div class="docstring"><p>Determines whether two feature values in two records should earn the full
log-odds similarity score (i.e. they match exactly) or whether they
should earn no weight (they differ). Used for fields for which fuzzy
comparisons are inappropriate, such as sex.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>record_i</strong>:  One of the records in the candidate pair to evaluate.</li>
<li><strong>record_j</strong>:  The second record in the candidate pair.</li>
<li><strong>feature_x</strong>:  A number representing the index of the feature to
compare for a partial match.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>A float of the score the feature comparison earned.</p>
</blockquote>
</div>


                </section>
                <section id="feature_match_log_odds_fuzzy_compare">
                            <input id="feature_match_log_odds_fuzzy_compare-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">feature_match_log_odds_fuzzy_compare</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">record_i</span><span class="p">:</span> <span class="n">List</span>, </span><span class="param"><span class="n">record_j</span><span class="p">:</span> <span class="n">List</span>, </span><span class="param"><span class="n">feature_x</span><span class="p">:</span> <span class="nb">int</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="feature_match_log_odds_fuzzy_compare-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#feature_match_log_odds_fuzzy_compare"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="feature_match_log_odds_fuzzy_compare-502"><a href="#feature_match_log_odds_fuzzy_compare-502"><span class="linenos">502</span></a><span class="k">def</span> <span class="nf">feature_match_log_odds_fuzzy_compare</span><span class="p">(</span>
</span><span id="feature_match_log_odds_fuzzy_compare-503"><a href="#feature_match_log_odds_fuzzy_compare-503"><span class="linenos">503</span></a>    <span class="n">record_i</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">record_j</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">feature_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span>
</span><span id="feature_match_log_odds_fuzzy_compare-504"><a href="#feature_match_log_odds_fuzzy_compare-504"><span class="linenos">504</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="feature_match_log_odds_fuzzy_compare-505"><a href="#feature_match_log_odds_fuzzy_compare-505"><span class="linenos">505</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="feature_match_log_odds_fuzzy_compare-506"><a href="#feature_match_log_odds_fuzzy_compare-506"><span class="linenos">506</span></a><span class="sd">    Determines the weighted string-odds similarly score earned by two</span>
</span><span id="feature_match_log_odds_fuzzy_compare-507"><a href="#feature_match_log_odds_fuzzy_compare-507"><span class="linenos">507</span></a><span class="sd">    feature values in two records, as a function of the pre-computed</span>
</span><span id="feature_match_log_odds_fuzzy_compare-508"><a href="#feature_match_log_odds_fuzzy_compare-508"><span class="linenos">508</span></a><span class="sd">    log-odds weights and the string similarity between the two features.</span>
</span><span id="feature_match_log_odds_fuzzy_compare-509"><a href="#feature_match_log_odds_fuzzy_compare-509"><span class="linenos">509</span></a><span class="sd">    This scales the full score that would be earned from a perfect</span>
</span><span id="feature_match_log_odds_fuzzy_compare-510"><a href="#feature_match_log_odds_fuzzy_compare-510"><span class="linenos">510</span></a><span class="sd">    match to a degree of partial weight appropriate to how similar the</span>
</span><span id="feature_match_log_odds_fuzzy_compare-511"><a href="#feature_match_log_odds_fuzzy_compare-511"><span class="linenos">511</span></a><span class="sd">    two strings are.</span>
</span><span id="feature_match_log_odds_fuzzy_compare-512"><a href="#feature_match_log_odds_fuzzy_compare-512"><span class="linenos">512</span></a>
</span><span id="feature_match_log_odds_fuzzy_compare-513"><a href="#feature_match_log_odds_fuzzy_compare-513"><span class="linenos">513</span></a><span class="sd">    :param record_i: One of the records in the candidate pair to evaluate.</span>
</span><span id="feature_match_log_odds_fuzzy_compare-514"><a href="#feature_match_log_odds_fuzzy_compare-514"><span class="linenos">514</span></a><span class="sd">    :param record_j: The second record in the candidate pair.</span>
</span><span id="feature_match_log_odds_fuzzy_compare-515"><a href="#feature_match_log_odds_fuzzy_compare-515"><span class="linenos">515</span></a><span class="sd">    :param feature_x: A number representing the index of the feature to</span>
</span><span id="feature_match_log_odds_fuzzy_compare-516"><a href="#feature_match_log_odds_fuzzy_compare-516"><span class="linenos">516</span></a><span class="sd">      compare for a partial match.</span>
</span><span id="feature_match_log_odds_fuzzy_compare-517"><a href="#feature_match_log_odds_fuzzy_compare-517"><span class="linenos">517</span></a><span class="sd">    :return: A float of the score the feature comparison earned.</span>
</span><span id="feature_match_log_odds_fuzzy_compare-518"><a href="#feature_match_log_odds_fuzzy_compare-518"><span class="linenos">518</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="feature_match_log_odds_fuzzy_compare-519"><a href="#feature_match_log_odds_fuzzy_compare-519"><span class="linenos">519</span></a>    <span class="k">if</span> <span class="s2">&quot;idx_to_col&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="feature_match_log_odds_fuzzy_compare-520"><a href="#feature_match_log_odds_fuzzy_compare-520"><span class="linenos">520</span></a>        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Mapping of indices to column names must be provided.&quot;</span><span class="p">)</span>
</span><span id="feature_match_log_odds_fuzzy_compare-521"><a href="#feature_match_log_odds_fuzzy_compare-521"><span class="linenos">521</span></a>    <span class="k">if</span> <span class="s2">&quot;log_odds&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="feature_match_log_odds_fuzzy_compare-522"><a href="#feature_match_log_odds_fuzzy_compare-522"><span class="linenos">522</span></a>        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Mapping of columns to m/u log-odds must be provided.&quot;</span><span class="p">)</span>
</span><span id="feature_match_log_odds_fuzzy_compare-523"><a href="#feature_match_log_odds_fuzzy_compare-523"><span class="linenos">523</span></a>    <span class="n">col</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;idx_to_col&quot;</span><span class="p">][</span><span class="n">feature_x</span><span class="p">]</span>
</span><span id="feature_match_log_odds_fuzzy_compare-524"><a href="#feature_match_log_odds_fuzzy_compare-524"><span class="linenos">524</span></a>    <span class="n">col_odds</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;log_odds&quot;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
</span><span id="feature_match_log_odds_fuzzy_compare-525"><a href="#feature_match_log_odds_fuzzy_compare-525"><span class="linenos">525</span></a>    <span class="n">score</span> <span class="o">=</span> <span class="n">compare_strings</span><span class="p">(</span><span class="n">record_i</span><span class="p">[</span><span class="n">feature_x</span><span class="p">],</span> <span class="n">record_j</span><span class="p">[</span><span class="n">feature_x</span><span class="p">],</span> <span class="s2">&quot;JaroWinkler&quot;</span><span class="p">)</span>
</span><span id="feature_match_log_odds_fuzzy_compare-526"><a href="#feature_match_log_odds_fuzzy_compare-526"><span class="linenos">526</span></a>    <span class="k">return</span> <span class="n">score</span> <span class="o">*</span> <span class="n">col_odds</span>
</span></pre></div>


            <div class="docstring"><p>Determines the weighted string-odds similarly score earned by two
feature values in two records, as a function of the pre-computed
log-odds weights and the string similarity between the two features.
This scales the full score that would be earned from a perfect
match to a degree of partial weight appropriate to how similar the
two strings are.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>record_i</strong>:  One of the records in the candidate pair to evaluate.</li>
<li><strong>record_j</strong>:  The second record in the candidate pair.</li>
<li><strong>feature_x</strong>:  A number representing the index of the feature to
compare for a partial match.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>A float of the score the feature comparison earned.</p>
</blockquote>
</div>


                </section>
                <section id="profile_log_odds">
                            <input id="profile_log_odds-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">profile_log_odds</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">data</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span>,</span><span class="param">	<span class="n">true_matches</span><span class="p">:</span> <span class="nb">dict</span>,</span><span class="param">	<span class="n">log_odds</span><span class="p">:</span> <span class="nb">dict</span>,</span><span class="param">	<span class="n">exact_cols</span><span class="p">:</span> <span class="n">List</span>,</span><span class="param">	<span class="n">fuzzy_cols</span><span class="p">:</span> <span class="n">List</span>,</span><span class="param">	<span class="n">idx_to_col</span><span class="p">:</span> <span class="nb">dict</span>,</span><span class="param">	<span class="n">neg_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50000</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="profile_log_odds-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#profile_log_odds"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="profile_log_odds-795"><a href="#profile_log_odds-795"><span class="linenos">795</span></a><span class="k">def</span> <span class="nf">profile_log_odds</span><span class="p">(</span>
</span><span id="profile_log_odds-796"><a href="#profile_log_odds-796"><span class="linenos">796</span></a>    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
</span><span id="profile_log_odds-797"><a href="#profile_log_odds-797"><span class="linenos">797</span></a>    <span class="n">true_matches</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
</span><span id="profile_log_odds-798"><a href="#profile_log_odds-798"><span class="linenos">798</span></a>    <span class="n">log_odds</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
</span><span id="profile_log_odds-799"><a href="#profile_log_odds-799"><span class="linenos">799</span></a>    <span class="n">exact_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
</span><span id="profile_log_odds-800"><a href="#profile_log_odds-800"><span class="linenos">800</span></a>    <span class="n">fuzzy_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
</span><span id="profile_log_odds-801"><a href="#profile_log_odds-801"><span class="linenos">801</span></a>    <span class="n">idx_to_col</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
</span><span id="profile_log_odds-802"><a href="#profile_log_odds-802"><span class="linenos">802</span></a>    <span class="n">neg_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50000</span><span class="p">,</span>
</span><span id="profile_log_odds-803"><a href="#profile_log_odds-803"><span class="linenos">803</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
</span><span id="profile_log_odds-804"><a href="#profile_log_odds-804"><span class="linenos">804</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="profile_log_odds-805"><a href="#profile_log_odds-805"><span class="linenos">805</span></a><span class="sd">    Basic graphical profiler for log-odds histogram analysis. Using the</span>
</span><span id="profile_log_odds-806"><a href="#profile_log_odds-806"><span class="linenos">806</span></a><span class="sd">    raw data and previously known true matches, the function computes one</span>
</span><span id="profile_log_odds-807"><a href="#profile_log_odds-807"><span class="linenos">807</span></a><span class="sd">    list of log-odds scores that that would be earned by true matches under</span>
</span><span id="profile_log_odds-808"><a href="#profile_log_odds-808"><span class="linenos">808</span></a><span class="sd">    a given linkage rule, and another list of scores that would be earned</span>
</span><span id="profile_log_odds-809"><a href="#profile_log_odds-809"><span class="linenos">809</span></a><span class="sd">    by a random sampling of non-matches under the same linkage rule. These</span>
</span><span id="profile_log_odds-810"><a href="#profile_log_odds-810"><span class="linenos">810</span></a><span class="sd">    lists are used to plot bimodal histograms so that the cutoff threshold</span>
</span><span id="profile_log_odds-811"><a href="#profile_log_odds-811"><span class="linenos">811</span></a><span class="sd">    between non-matchces and true matches can be visually determined.</span>
</span><span id="profile_log_odds-812"><a href="#profile_log_odds-812"><span class="linenos">812</span></a>
</span><span id="profile_log_odds-813"><a href="#profile_log_odds-813"><span class="linenos">813</span></a><span class="sd">    :param data: A pandas data frame holding the raw patient record data.</span>
</span><span id="profile_log_odds-814"><a href="#profile_log_odds-814"><span class="linenos">814</span></a><span class="sd">    :param true_matches: A dictionary of known true matches in the data.</span>
</span><span id="profile_log_odds-815"><a href="#profile_log_odds-815"><span class="linenos">815</span></a><span class="sd">    :param log_odds: A dictionary whose keys are the column fields of data</span>
</span><span id="profile_log_odds-816"><a href="#profile_log_odds-816"><span class="linenos">816</span></a><span class="sd">      and whose values are the log-odds scores that two values match relative</span>
</span><span id="profile_log_odds-817"><a href="#profile_log_odds-817"><span class="linenos">817</span></a><span class="sd">      to random chance.</span>
</span><span id="profile_log_odds-818"><a href="#profile_log_odds-818"><span class="linenos">818</span></a><span class="sd">    :param exact_cols: A list of columns to be evaluated using equality</span>
</span><span id="profile_log_odds-819"><a href="#profile_log_odds-819"><span class="linenos">819</span></a><span class="sd">      comparisons.</span>
</span><span id="profile_log_odds-820"><a href="#profile_log_odds-820"><span class="linenos">820</span></a><span class="sd">    :param fuzzy_cols: A list of columns to be evaluated using fuzzy weighted</span>
</span><span id="profile_log_odds-821"><a href="#profile_log_odds-821"><span class="linenos">821</span></a><span class="sd">      comparisons.</span>
</span><span id="profile_log_odds-822"><a href="#profile_log_odds-822"><span class="linenos">822</span></a><span class="sd">    :param idx_to_col: A dictionary mapping the number of a column in a list</span>
</span><span id="profile_log_odds-823"><a href="#profile_log_odds-823"><span class="linenos">823</span></a><span class="sd">      representation of the data, to the name of the column in a pandas</span>
</span><span id="profile_log_odds-824"><a href="#profile_log_odds-824"><span class="linenos">824</span></a><span class="sd">      representation.</span>
</span><span id="profile_log_odds-825"><a href="#profile_log_odds-825"><span class="linenos">825</span></a><span class="sd">    :param neg_samples: Optionally, how many non-match samples to compute a</span>
</span><span id="profile_log_odds-826"><a href="#profile_log_odds-826"><span class="linenos">826</span></a><span class="sd">      score for when generating the histogram.</span>
</span><span id="profile_log_odds-827"><a href="#profile_log_odds-827"><span class="linenos">827</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="profile_log_odds-828"><a href="#profile_log_odds-828"><span class="linenos">828</span></a>    <span class="n">base_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="profile_log_odds-829"><a href="#profile_log_odds-829"><span class="linenos">829</span></a>    <span class="n">neg_pairs</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="profile_log_odds-830"><a href="#profile_log_odds-830"><span class="linenos">830</span></a>        <span class="n">x</span>
</span><span id="profile_log_odds-831"><a href="#profile_log_odds-831"><span class="linenos">831</span></a>        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">base_pairs</span>
</span><span id="profile_log_odds-832"><a href="#profile_log_odds-832"><span class="linenos">832</span></a>        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">true_matches</span> <span class="ow">or</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">true_matches</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="profile_log_odds-833"><a href="#profile_log_odds-833"><span class="linenos">833</span></a>    <span class="p">]</span>
</span><span id="profile_log_odds-834"><a href="#profile_log_odds-834"><span class="linenos">834</span></a>    <span class="k">if</span> <span class="n">neg_samples</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_pairs</span><span class="p">):</span>
</span><span id="profile_log_odds-835"><a href="#profile_log_odds-835"><span class="linenos">835</span></a>        <span class="n">neg_pairs</span> <span class="o">=</span> <span class="n">sample</span><span class="p">(</span><span class="n">neg_pairs</span><span class="p">,</span> <span class="n">neg_samples</span><span class="p">)</span>
</span><span id="profile_log_odds-836"><a href="#profile_log_odds-836"><span class="linenos">836</span></a>
</span><span id="profile_log_odds-837"><a href="#profile_log_odds-837"><span class="linenos">837</span></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="profile_log_odds-838"><a href="#profile_log_odds-838"><span class="linenos">838</span></a>    <span class="n">cols_to_idx</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="profile_log_odds-839"><a href="#profile_log_odds-839"><span class="linenos">839</span></a>    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idx_to_col</span><span class="p">:</span>
</span><span id="profile_log_odds-840"><a href="#profile_log_odds-840"><span class="linenos">840</span></a>        <span class="n">cols_to_idx</span><span class="p">[</span><span class="n">idx_to_col</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span> <span class="o">=</span> <span class="n">idx</span>
</span><span id="profile_log_odds-841"><a href="#profile_log_odds-841"><span class="linenos">841</span></a>
</span><span id="profile_log_odds-842"><a href="#profile_log_odds-842"><span class="linenos">842</span></a>    <span class="n">true_match_scores</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="profile_log_odds-843"><a href="#profile_log_odds-843"><span class="linenos">843</span></a>    <span class="k">for</span> <span class="n">root_record</span><span class="p">,</span> <span class="n">paired_records</span> <span class="ow">in</span> <span class="n">true_matches</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="profile_log_odds-844"><a href="#profile_log_odds-844"><span class="linenos">844</span></a>        <span class="k">for</span> <span class="n">pr</span> <span class="ow">in</span> <span class="n">paired_records</span><span class="p">:</span>
</span><span id="profile_log_odds-845"><a href="#profile_log_odds-845"><span class="linenos">845</span></a>            <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="profile_log_odds-846"><a href="#profile_log_odds-846"><span class="linenos">846</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">exact_cols</span><span class="p">:</span>
</span><span id="profile_log_odds-847"><a href="#profile_log_odds-847"><span class="linenos">847</span></a>                <span class="n">score</span> <span class="o">+=</span> <span class="n">feature_match_log_odds_exact</span><span class="p">(</span>
</span><span id="profile_log_odds-848"><a href="#profile_log_odds-848"><span class="linenos">848</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">root_record</span><span class="p">],</span>
</span><span id="profile_log_odds-849"><a href="#profile_log_odds-849"><span class="linenos">849</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">pr</span><span class="p">],</span>
</span><span id="profile_log_odds-850"><a href="#profile_log_odds-850"><span class="linenos">850</span></a>                    <span class="n">cols_to_idx</span><span class="p">[</span><span class="n">c</span><span class="p">],</span>
</span><span id="profile_log_odds-851"><a href="#profile_log_odds-851"><span class="linenos">851</span></a>                    <span class="n">idx_to_col</span><span class="o">=</span><span class="n">idx_to_col</span><span class="p">,</span>
</span><span id="profile_log_odds-852"><a href="#profile_log_odds-852"><span class="linenos">852</span></a>                    <span class="n">log_odds</span><span class="o">=</span><span class="n">log_odds</span><span class="p">,</span>
</span><span id="profile_log_odds-853"><a href="#profile_log_odds-853"><span class="linenos">853</span></a>                <span class="p">)</span>
</span><span id="profile_log_odds-854"><a href="#profile_log_odds-854"><span class="linenos">854</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">fuzzy_cols</span><span class="p">:</span>
</span><span id="profile_log_odds-855"><a href="#profile_log_odds-855"><span class="linenos">855</span></a>                <span class="n">score</span> <span class="o">+=</span> <span class="n">feature_match_log_odds_fuzzy_compare</span><span class="p">(</span>
</span><span id="profile_log_odds-856"><a href="#profile_log_odds-856"><span class="linenos">856</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">root_record</span><span class="p">],</span>
</span><span id="profile_log_odds-857"><a href="#profile_log_odds-857"><span class="linenos">857</span></a>                    <span class="n">data</span><span class="p">[</span><span class="n">pr</span><span class="p">],</span>
</span><span id="profile_log_odds-858"><a href="#profile_log_odds-858"><span class="linenos">858</span></a>                    <span class="n">cols_to_idx</span><span class="p">[</span><span class="n">c</span><span class="p">],</span>
</span><span id="profile_log_odds-859"><a href="#profile_log_odds-859"><span class="linenos">859</span></a>                    <span class="n">idx_to_col</span><span class="o">=</span><span class="n">idx_to_col</span><span class="p">,</span>
</span><span id="profile_log_odds-860"><a href="#profile_log_odds-860"><span class="linenos">860</span></a>                    <span class="n">log_odds</span><span class="o">=</span><span class="n">log_odds</span><span class="p">,</span>
</span><span id="profile_log_odds-861"><a href="#profile_log_odds-861"><span class="linenos">861</span></a>                <span class="p">)</span>
</span><span id="profile_log_odds-862"><a href="#profile_log_odds-862"><span class="linenos">862</span></a>            <span class="n">true_match_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
</span><span id="profile_log_odds-863"><a href="#profile_log_odds-863"><span class="linenos">863</span></a>
</span><span id="profile_log_odds-864"><a href="#profile_log_odds-864"><span class="linenos">864</span></a>    <span class="n">non_match_scores</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="profile_log_odds-865"><a href="#profile_log_odds-865"><span class="linenos">865</span></a>    <span class="k">for</span> <span class="n">record_1</span><span class="p">,</span> <span class="n">record_2</span> <span class="ow">in</span> <span class="n">neg_pairs</span><span class="p">:</span>
</span><span id="profile_log_odds-866"><a href="#profile_log_odds-866"><span class="linenos">866</span></a>        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="profile_log_odds-867"><a href="#profile_log_odds-867"><span class="linenos">867</span></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">exact_cols</span><span class="p">:</span>
</span><span id="profile_log_odds-868"><a href="#profile_log_odds-868"><span class="linenos">868</span></a>            <span class="n">score</span> <span class="o">+=</span> <span class="n">feature_match_log_odds_exact</span><span class="p">(</span>
</span><span id="profile_log_odds-869"><a href="#profile_log_odds-869"><span class="linenos">869</span></a>                <span class="n">data</span><span class="p">[</span><span class="n">record_1</span><span class="p">],</span>
</span><span id="profile_log_odds-870"><a href="#profile_log_odds-870"><span class="linenos">870</span></a>                <span class="n">data</span><span class="p">[</span><span class="n">record_2</span><span class="p">],</span>
</span><span id="profile_log_odds-871"><a href="#profile_log_odds-871"><span class="linenos">871</span></a>                <span class="n">cols_to_idx</span><span class="p">[</span><span class="n">c</span><span class="p">],</span>
</span><span id="profile_log_odds-872"><a href="#profile_log_odds-872"><span class="linenos">872</span></a>                <span class="n">idx_to_col</span><span class="o">=</span><span class="n">idx_to_col</span><span class="p">,</span>
</span><span id="profile_log_odds-873"><a href="#profile_log_odds-873"><span class="linenos">873</span></a>                <span class="n">log_odds</span><span class="o">=</span><span class="n">log_odds</span><span class="p">,</span>
</span><span id="profile_log_odds-874"><a href="#profile_log_odds-874"><span class="linenos">874</span></a>            <span class="p">)</span>
</span><span id="profile_log_odds-875"><a href="#profile_log_odds-875"><span class="linenos">875</span></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">fuzzy_cols</span><span class="p">:</span>
</span><span id="profile_log_odds-876"><a href="#profile_log_odds-876"><span class="linenos">876</span></a>            <span class="n">score</span> <span class="o">+=</span> <span class="n">feature_match_log_odds_fuzzy_compare</span><span class="p">(</span>
</span><span id="profile_log_odds-877"><a href="#profile_log_odds-877"><span class="linenos">877</span></a>                <span class="n">data</span><span class="p">[</span><span class="n">record_1</span><span class="p">],</span>
</span><span id="profile_log_odds-878"><a href="#profile_log_odds-878"><span class="linenos">878</span></a>                <span class="n">data</span><span class="p">[</span><span class="n">record_2</span><span class="p">],</span>
</span><span id="profile_log_odds-879"><a href="#profile_log_odds-879"><span class="linenos">879</span></a>                <span class="n">cols_to_idx</span><span class="p">[</span><span class="n">c</span><span class="p">],</span>
</span><span id="profile_log_odds-880"><a href="#profile_log_odds-880"><span class="linenos">880</span></a>                <span class="n">idx_to_col</span><span class="o">=</span><span class="n">idx_to_col</span><span class="p">,</span>
</span><span id="profile_log_odds-881"><a href="#profile_log_odds-881"><span class="linenos">881</span></a>                <span class="n">log_odds</span><span class="o">=</span><span class="n">log_odds</span><span class="p">,</span>
</span><span id="profile_log_odds-882"><a href="#profile_log_odds-882"><span class="linenos">882</span></a>            <span class="p">)</span>
</span><span id="profile_log_odds-883"><a href="#profile_log_odds-883"><span class="linenos">883</span></a>            <span class="n">non_match_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
</span><span id="profile_log_odds-884"><a href="#profile_log_odds-884"><span class="linenos">884</span></a>
</span><span id="profile_log_odds-885"><a href="#profile_log_odds-885"><span class="linenos">885</span></a>    <span class="n">min_length</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">true_match_scores</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_match_scores</span><span class="p">))</span>
</span><span id="profile_log_odds-886"><a href="#profile_log_odds-886"><span class="linenos">886</span></a>    <span class="n">true_match_scores</span> <span class="o">=</span> <span class="n">true_match_scores</span><span class="p">[:</span><span class="n">min_length</span><span class="p">]</span>
</span><span id="profile_log_odds-887"><a href="#profile_log_odds-887"><span class="linenos">887</span></a>    <span class="n">non_match_scores</span> <span class="o">=</span> <span class="n">non_match_scores</span><span class="p">[:</span><span class="n">min_length</span><span class="p">]</span>
</span><span id="profile_log_odds-888"><a href="#profile_log_odds-888"><span class="linenos">888</span></a>
</span><span id="profile_log_odds-889"><a href="#profile_log_odds-889"><span class="linenos">889</span></a>    <span class="n">_</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">true_match_scores</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">75</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">])</span>
</span><span id="profile_log_odds-890"><a href="#profile_log_odds-890"><span class="linenos">890</span></a>    <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">non_match_scores</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span><span id="profile_log_odds-891"><a href="#profile_log_odds-891"><span class="linenos">891</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Basic graphical profiler for log-odds histogram analysis. Using the
raw data and previously known true matches, the function computes one
list of log-odds scores that that would be earned by true matches under
a given linkage rule, and another list of scores that would be earned
by a random sampling of non-matches under the same linkage rule. These
lists are used to plot bimodal histograms so that the cutoff threshold
between non-matchces and true matches can be visually determined.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>data</strong>:  A pandas data frame holding the raw patient record data.</li>
<li><strong>true_matches</strong>:  A dictionary of known true matches in the data.</li>
<li><strong>log_odds</strong>:  A dictionary whose keys are the column fields of data
and whose values are the log-odds scores that two values match relative
to random chance.</li>
<li><strong>exact_cols</strong>:  A list of columns to be evaluated using equality
comparisons.</li>
<li><strong>fuzzy_cols</strong>:  A list of columns to be evaluated using fuzzy weighted
comparisons.</li>
<li><strong>idx_to_col</strong>:  A dictionary mapping the number of a column in a list
representation of the data, to the name of the column in a pandas
representation.</li>
<li><strong>neg_samples</strong>:  Optionally, how many non-match samples to compute a
score for when generating the histogram.</li>
</ul>
</div>


                </section>
                <section id="eval_log_odds_cutoff">
                            <input id="eval_log_odds_cutoff-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">eval_log_odds_cutoff</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">feature_comparisons</span><span class="p">:</span> <span class="n">List</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="eval_log_odds_cutoff-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#eval_log_odds_cutoff"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="eval_log_odds_cutoff-304"><a href="#eval_log_odds_cutoff-304"><span class="linenos">304</span></a><span class="k">def</span> <span class="nf">eval_log_odds_cutoff</span><span class="p">(</span><span class="n">feature_comparisons</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="eval_log_odds_cutoff-305"><a href="#eval_log_odds_cutoff-305"><span class="linenos">305</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="eval_log_odds_cutoff-306"><a href="#eval_log_odds_cutoff-306"><span class="linenos">306</span></a><span class="sd">    Determines whether a given set of feature comparisons matches enough</span>
</span><span id="eval_log_odds_cutoff-307"><a href="#eval_log_odds_cutoff-307"><span class="linenos">307</span></a><span class="sd">    to be the result of a true patient link instead of just random chance.</span>
</span><span id="eval_log_odds_cutoff-308"><a href="#eval_log_odds_cutoff-308"><span class="linenos">308</span></a><span class="sd">    This is represented using previously computed log-odds ratios.</span>
</span><span id="eval_log_odds_cutoff-309"><a href="#eval_log_odds_cutoff-309"><span class="linenos">309</span></a>
</span><span id="eval_log_odds_cutoff-310"><a href="#eval_log_odds_cutoff-310"><span class="linenos">310</span></a><span class="sd">    :param feature_comparisons: A list of floats representing the log-odds</span>
</span><span id="eval_log_odds_cutoff-311"><a href="#eval_log_odds_cutoff-311"><span class="linenos">311</span></a><span class="sd">      score of each field computed on.</span>
</span><span id="eval_log_odds_cutoff-312"><a href="#eval_log_odds_cutoff-312"><span class="linenos">312</span></a><span class="sd">    :return: Whether the feature comparisons score well enough to be</span>
</span><span id="eval_log_odds_cutoff-313"><a href="#eval_log_odds_cutoff-313"><span class="linenos">313</span></a><span class="sd">      considered a match.</span>
</span><span id="eval_log_odds_cutoff-314"><a href="#eval_log_odds_cutoff-314"><span class="linenos">314</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="eval_log_odds_cutoff-315"><a href="#eval_log_odds_cutoff-315"><span class="linenos">315</span></a>    <span class="k">if</span> <span class="s2">&quot;true_match_threshold&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="eval_log_odds_cutoff-316"><a href="#eval_log_odds_cutoff-316"><span class="linenos">316</span></a>        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Cutoff threshold for true matches must be passed.&quot;</span><span class="p">)</span>
</span><span id="eval_log_odds_cutoff-317"><a href="#eval_log_odds_cutoff-317"><span class="linenos">317</span></a>    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">feature_comparisons</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;true_match_threshold&quot;</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Determines whether a given set of feature comparisons matches enough
to be the result of a true patient link instead of just random chance.
This is represented using previously computed log-odds ratios.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>feature_comparisons</strong>:  A list of floats representing the log-odds
score of each field computed on.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Whether the feature comparisons score well enough to be
    considered a match.</p>
</blockquote>
</div>


                </section>
                <section id="BaseMPIConnectorClient">
                            <input id="BaseMPIConnectorClient-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">BaseMPIConnectorClient</span><wbr>(<span class="base">abc.ABC</span>):

                <label class="view-source-button" for="BaseMPIConnectorClient-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseMPIConnectorClient"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseMPIConnectorClient-6"><a href="#BaseMPIConnectorClient-6"><span class="linenos"> 6</span></a><span class="k">class</span> <span class="nc">BaseMPIConnectorClient</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span><span id="BaseMPIConnectorClient-7"><a href="#BaseMPIConnectorClient-7"><span class="linenos"> 7</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseMPIConnectorClient-8"><a href="#BaseMPIConnectorClient-8"><span class="linenos"> 8</span></a><span class="sd">    Represents a vendor-agnostic Master Patient Index (MPI) connector client. Requires</span>
</span><span id="BaseMPIConnectorClient-9"><a href="#BaseMPIConnectorClient-9"><span class="linenos"> 9</span></a><span class="sd">    implementing classes to define methods to retrive blocks of data from the MPI.</span>
</span><span id="BaseMPIConnectorClient-10"><a href="#BaseMPIConnectorClient-10"><span class="linenos">10</span></a><span class="sd">    Callers should use the provided interface functions (e.g., block_data)</span>
</span><span id="BaseMPIConnectorClient-11"><a href="#BaseMPIConnectorClient-11"><span class="linenos">11</span></a><span class="sd">    to interact with the underlying vendor-specific client property.</span>
</span><span id="BaseMPIConnectorClient-12"><a href="#BaseMPIConnectorClient-12"><span class="linenos">12</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="BaseMPIConnectorClient-13"><a href="#BaseMPIConnectorClient-13"><span class="linenos">13</span></a>
</span><span id="BaseMPIConnectorClient-14"><a href="#BaseMPIConnectorClient-14"><span class="linenos">14</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="BaseMPIConnectorClient-15"><a href="#BaseMPIConnectorClient-15"><span class="linenos">15</span></a>    <span class="k">def</span> <span class="nf">block_data</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">list</span><span class="p">]:</span>
</span><span id="BaseMPIConnectorClient-16"><a href="#BaseMPIConnectorClient-16"><span class="linenos">16</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseMPIConnectorClient-17"><a href="#BaseMPIConnectorClient-17"><span class="linenos">17</span></a><span class="sd">        Returns a list of lists containing records from the database that match on the</span>
</span><span id="BaseMPIConnectorClient-18"><a href="#BaseMPIConnectorClient-18"><span class="linenos">18</span></a><span class="sd">        incoming record&#39;s block values. If blocking on &#39;ZIP&#39; and the incoming record&#39;s</span>
</span><span id="BaseMPIConnectorClient-19"><a href="#BaseMPIConnectorClient-19"><span class="linenos">19</span></a><span class="sd">        zip code is &#39;90210&#39;, the resulting block of data would contain records that all</span>
</span><span id="BaseMPIConnectorClient-20"><a href="#BaseMPIConnectorClient-20"><span class="linenos">20</span></a><span class="sd">        have the same zip code of 90210.</span>
</span><span id="BaseMPIConnectorClient-21"><a href="#BaseMPIConnectorClient-21"><span class="linenos">21</span></a>
</span><span id="BaseMPIConnectorClient-22"><a href="#BaseMPIConnectorClient-22"><span class="linenos">22</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseMPIConnectorClient-23"><a href="#BaseMPIConnectorClient-23"><span class="linenos">23</span></a>        <span class="k">pass</span>  <span class="c1"># pragma: no cover</span>
</span><span id="BaseMPIConnectorClient-24"><a href="#BaseMPIConnectorClient-24"><span class="linenos">24</span></a>
</span><span id="BaseMPIConnectorClient-25"><a href="#BaseMPIConnectorClient-25"><span class="linenos">25</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="BaseMPIConnectorClient-26"><a href="#BaseMPIConnectorClient-26"><span class="linenos">26</span></a>    <span class="k">def</span> <span class="nf">get_connection</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
</span><span id="BaseMPIConnectorClient-27"><a href="#BaseMPIConnectorClient-27"><span class="linenos">27</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseMPIConnectorClient-28"><a href="#BaseMPIConnectorClient-28"><span class="linenos">28</span></a><span class="sd">        Creates a connection to the database associated with the connector class.</span>
</span><span id="BaseMPIConnectorClient-29"><a href="#BaseMPIConnectorClient-29"><span class="linenos">29</span></a><span class="sd">        The connection is returned for use in other class methods as a context</span>
</span><span id="BaseMPIConnectorClient-30"><a href="#BaseMPIConnectorClient-30"><span class="linenos">30</span></a><span class="sd">        manager, and should generally not be called externally to the client.</span>
</span><span id="BaseMPIConnectorClient-31"><a href="#BaseMPIConnectorClient-31"><span class="linenos">31</span></a><span class="sd">        Also used for testing the validity of a connection when the client</span>
</span><span id="BaseMPIConnectorClient-32"><a href="#BaseMPIConnectorClient-32"><span class="linenos">32</span></a><span class="sd">        connector is instantiated. The return type is set to any here since the</span>
</span><span id="BaseMPIConnectorClient-33"><a href="#BaseMPIConnectorClient-33"><span class="linenos">33</span></a><span class="sd">        exact &quot;class&quot; of the client&#39;s connection is unknown in the abstract.</span>
</span><span id="BaseMPIConnectorClient-34"><a href="#BaseMPIConnectorClient-34"><span class="linenos">34</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseMPIConnectorClient-35"><a href="#BaseMPIConnectorClient-35"><span class="linenos">35</span></a>        <span class="k">pass</span>  <span class="c1"># pragma: no cover</span>
</span><span id="BaseMPIConnectorClient-36"><a href="#BaseMPIConnectorClient-36"><span class="linenos">36</span></a>
</span><span id="BaseMPIConnectorClient-37"><a href="#BaseMPIConnectorClient-37"><span class="linenos">37</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="BaseMPIConnectorClient-38"><a href="#BaseMPIConnectorClient-38"><span class="linenos">38</span></a>    <span class="k">def</span> <span class="nf">insert_match_patient</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseMPIConnectorClient-39"><a href="#BaseMPIConnectorClient-39"><span class="linenos">39</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseMPIConnectorClient-40"><a href="#BaseMPIConnectorClient-40"><span class="linenos">40</span></a><span class="sd">        If a matching person ID has been found in the MPI, inserts a new patient into</span>
</span><span id="BaseMPIConnectorClient-41"><a href="#BaseMPIConnectorClient-41"><span class="linenos">41</span></a><span class="sd">        the patient table and updates the person table to link to the new patient; else</span>
</span><span id="BaseMPIConnectorClient-42"><a href="#BaseMPIConnectorClient-42"><span class="linenos">42</span></a><span class="sd">        inserts a new patient into the patient table and inserts a new person into the</span>
</span><span id="BaseMPIConnectorClient-43"><a href="#BaseMPIConnectorClient-43"><span class="linenos">43</span></a><span class="sd">        person table with a new personID, linking the new personID to the new patient.</span>
</span><span id="BaseMPIConnectorClient-44"><a href="#BaseMPIConnectorClient-44"><span class="linenos">44</span></a>
</span><span id="BaseMPIConnectorClient-45"><a href="#BaseMPIConnectorClient-45"><span class="linenos">45</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseMPIConnectorClient-46"><a href="#BaseMPIConnectorClient-46"><span class="linenos">46</span></a>        <span class="k">pass</span>  <span class="c1"># pragma: no cover</span>
</span><span id="BaseMPIConnectorClient-47"><a href="#BaseMPIConnectorClient-47"><span class="linenos">47</span></a>
</span><span id="BaseMPIConnectorClient-48"><a href="#BaseMPIConnectorClient-48"><span class="linenos">48</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="BaseMPIConnectorClient-49"><a href="#BaseMPIConnectorClient-49"><span class="linenos">49</span></a>    <span class="k">def</span> <span class="nf">_generate_block_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block_vals</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="BaseMPIConnectorClient-50"><a href="#BaseMPIConnectorClient-50"><span class="linenos">50</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseMPIConnectorClient-51"><a href="#BaseMPIConnectorClient-51"><span class="linenos">51</span></a><span class="sd">        Generates a query for selecting a block of data from the patient table per the</span>
</span><span id="BaseMPIConnectorClient-52"><a href="#BaseMPIConnectorClient-52"><span class="linenos">52</span></a><span class="sd">        block_vals parameters. Accepted blocking fields include: first_name, last_name,</span>
</span><span id="BaseMPIConnectorClient-53"><a href="#BaseMPIConnectorClient-53"><span class="linenos">53</span></a><span class="sd">        birthdate, addess, city, state, zip, mrn, and sex.</span>
</span><span id="BaseMPIConnectorClient-54"><a href="#BaseMPIConnectorClient-54"><span class="linenos">54</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseMPIConnectorClient-55"><a href="#BaseMPIConnectorClient-55"><span class="linenos">55</span></a>        <span class="k">pass</span>  <span class="c1"># pragma: no cover</span>
</span></pre></div>


            <div class="docstring"><p>Represents a vendor-agnostic Master Patient Index (MPI) connector client. Requires
implementing classes to define methods to retrive blocks of data from the MPI.
Callers should use the provided interface functions (e.g., block_data)
to interact with the underlying vendor-specific client property.</p>
</div>


                            <div id="BaseMPIConnectorClient.block_data" class="classattr">
                                        <input id="BaseMPIConnectorClient.block_data-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@abstractmethod</div>

        <span class="def">def</span>
        <span class="name">block_data</span><span class="signature pdoc-code condensed">(<span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="BaseMPIConnectorClient.block_data-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseMPIConnectorClient.block_data"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseMPIConnectorClient.block_data-14"><a href="#BaseMPIConnectorClient.block_data-14"><span class="linenos">14</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="BaseMPIConnectorClient.block_data-15"><a href="#BaseMPIConnectorClient.block_data-15"><span class="linenos">15</span></a>    <span class="k">def</span> <span class="nf">block_data</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">list</span><span class="p">]:</span>
</span><span id="BaseMPIConnectorClient.block_data-16"><a href="#BaseMPIConnectorClient.block_data-16"><span class="linenos">16</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseMPIConnectorClient.block_data-17"><a href="#BaseMPIConnectorClient.block_data-17"><span class="linenos">17</span></a><span class="sd">        Returns a list of lists containing records from the database that match on the</span>
</span><span id="BaseMPIConnectorClient.block_data-18"><a href="#BaseMPIConnectorClient.block_data-18"><span class="linenos">18</span></a><span class="sd">        incoming record&#39;s block values. If blocking on &#39;ZIP&#39; and the incoming record&#39;s</span>
</span><span id="BaseMPIConnectorClient.block_data-19"><a href="#BaseMPIConnectorClient.block_data-19"><span class="linenos">19</span></a><span class="sd">        zip code is &#39;90210&#39;, the resulting block of data would contain records that all</span>
</span><span id="BaseMPIConnectorClient.block_data-20"><a href="#BaseMPIConnectorClient.block_data-20"><span class="linenos">20</span></a><span class="sd">        have the same zip code of 90210.</span>
</span><span id="BaseMPIConnectorClient.block_data-21"><a href="#BaseMPIConnectorClient.block_data-21"><span class="linenos">21</span></a>
</span><span id="BaseMPIConnectorClient.block_data-22"><a href="#BaseMPIConnectorClient.block_data-22"><span class="linenos">22</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseMPIConnectorClient.block_data-23"><a href="#BaseMPIConnectorClient.block_data-23"><span class="linenos">23</span></a>        <span class="k">pass</span>  <span class="c1"># pragma: no cover</span>
</span></pre></div>


            <div class="docstring"><p>Returns a list of lists containing records from the database that match on the
incoming record's block values. If blocking on 'ZIP' and the incoming record's
zip code is '90210', the resulting block of data would contain records that all
have the same zip code of 90210.</p>
</div>


                            </div>
                            <div id="BaseMPIConnectorClient.get_connection" class="classattr">
                                        <input id="BaseMPIConnectorClient.get_connection-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@abstractmethod</div>

        <span class="def">def</span>
        <span class="name">get_connection</span><span class="signature pdoc-code condensed">(<span class="return-annotation">) -> <span class="n">Optional</span><span class="p">[</span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">function</span> <span class="nb">any</span><span class="o">&gt;</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="BaseMPIConnectorClient.get_connection-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseMPIConnectorClient.get_connection"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseMPIConnectorClient.get_connection-25"><a href="#BaseMPIConnectorClient.get_connection-25"><span class="linenos">25</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="BaseMPIConnectorClient.get_connection-26"><a href="#BaseMPIConnectorClient.get_connection-26"><span class="linenos">26</span></a>    <span class="k">def</span> <span class="nf">get_connection</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
</span><span id="BaseMPIConnectorClient.get_connection-27"><a href="#BaseMPIConnectorClient.get_connection-27"><span class="linenos">27</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseMPIConnectorClient.get_connection-28"><a href="#BaseMPIConnectorClient.get_connection-28"><span class="linenos">28</span></a><span class="sd">        Creates a connection to the database associated with the connector class.</span>
</span><span id="BaseMPIConnectorClient.get_connection-29"><a href="#BaseMPIConnectorClient.get_connection-29"><span class="linenos">29</span></a><span class="sd">        The connection is returned for use in other class methods as a context</span>
</span><span id="BaseMPIConnectorClient.get_connection-30"><a href="#BaseMPIConnectorClient.get_connection-30"><span class="linenos">30</span></a><span class="sd">        manager, and should generally not be called externally to the client.</span>
</span><span id="BaseMPIConnectorClient.get_connection-31"><a href="#BaseMPIConnectorClient.get_connection-31"><span class="linenos">31</span></a><span class="sd">        Also used for testing the validity of a connection when the client</span>
</span><span id="BaseMPIConnectorClient.get_connection-32"><a href="#BaseMPIConnectorClient.get_connection-32"><span class="linenos">32</span></a><span class="sd">        connector is instantiated. The return type is set to any here since the</span>
</span><span id="BaseMPIConnectorClient.get_connection-33"><a href="#BaseMPIConnectorClient.get_connection-33"><span class="linenos">33</span></a><span class="sd">        exact &quot;class&quot; of the client&#39;s connection is unknown in the abstract.</span>
</span><span id="BaseMPIConnectorClient.get_connection-34"><a href="#BaseMPIConnectorClient.get_connection-34"><span class="linenos">34</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseMPIConnectorClient.get_connection-35"><a href="#BaseMPIConnectorClient.get_connection-35"><span class="linenos">35</span></a>        <span class="k">pass</span>  <span class="c1"># pragma: no cover</span>
</span></pre></div>


            <div class="docstring"><p>Creates a connection to the database associated with the connector class.
The connection is returned for use in other class methods as a context
manager, and should generally not be called externally to the client.
Also used for testing the validity of a connection when the client
connector is instantiated. The return type is set to any here since the
exact "class" of the client's connection is unknown in the abstract.</p>
</div>


                            </div>
                            <div id="BaseMPIConnectorClient.insert_match_patient" class="classattr">
                                        <input id="BaseMPIConnectorClient.insert_match_patient-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@abstractmethod</div>

        <span class="def">def</span>
        <span class="name">insert_match_patient</span><span class="signature pdoc-code condensed">(<span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="BaseMPIConnectorClient.insert_match_patient-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseMPIConnectorClient.insert_match_patient"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseMPIConnectorClient.insert_match_patient-37"><a href="#BaseMPIConnectorClient.insert_match_patient-37"><span class="linenos">37</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="BaseMPIConnectorClient.insert_match_patient-38"><a href="#BaseMPIConnectorClient.insert_match_patient-38"><span class="linenos">38</span></a>    <span class="k">def</span> <span class="nf">insert_match_patient</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseMPIConnectorClient.insert_match_patient-39"><a href="#BaseMPIConnectorClient.insert_match_patient-39"><span class="linenos">39</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="BaseMPIConnectorClient.insert_match_patient-40"><a href="#BaseMPIConnectorClient.insert_match_patient-40"><span class="linenos">40</span></a><span class="sd">        If a matching person ID has been found in the MPI, inserts a new patient into</span>
</span><span id="BaseMPIConnectorClient.insert_match_patient-41"><a href="#BaseMPIConnectorClient.insert_match_patient-41"><span class="linenos">41</span></a><span class="sd">        the patient table and updates the person table to link to the new patient; else</span>
</span><span id="BaseMPIConnectorClient.insert_match_patient-42"><a href="#BaseMPIConnectorClient.insert_match_patient-42"><span class="linenos">42</span></a><span class="sd">        inserts a new patient into the patient table and inserts a new person into the</span>
</span><span id="BaseMPIConnectorClient.insert_match_patient-43"><a href="#BaseMPIConnectorClient.insert_match_patient-43"><span class="linenos">43</span></a><span class="sd">        person table with a new personID, linking the new personID to the new patient.</span>
</span><span id="BaseMPIConnectorClient.insert_match_patient-44"><a href="#BaseMPIConnectorClient.insert_match_patient-44"><span class="linenos">44</span></a>
</span><span id="BaseMPIConnectorClient.insert_match_patient-45"><a href="#BaseMPIConnectorClient.insert_match_patient-45"><span class="linenos">45</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseMPIConnectorClient.insert_match_patient-46"><a href="#BaseMPIConnectorClient.insert_match_patient-46"><span class="linenos">46</span></a>        <span class="k">pass</span>  <span class="c1"># pragma: no cover</span>
</span></pre></div>


            <div class="docstring"><p>If a matching person ID has been found in the MPI, inserts a new patient into
the patient table and updates the person table to link to the new patient; else
inserts a new patient into the patient table and inserts a new person into the
person table with a new personID, linking the new personID to the new patient.</p>
</div>


                            </div>
                </section>
                <section id="extract_blocking_values_from_record">
                            <input id="extract_blocking_values_from_record-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">extract_blocking_values_from_record</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">record</span><span class="p">:</span> <span class="nb">dict</span>, </span><span class="param"><span class="n">blocking_fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="extract_blocking_values_from_record-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#extract_blocking_values_from_record"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="extract_blocking_values_from_record-320"><a href="#extract_blocking_values_from_record-320"><span class="linenos">320</span></a><span class="k">def</span> <span class="nf">extract_blocking_values_from_record</span><span class="p">(</span>
</span><span id="extract_blocking_values_from_record-321"><a href="#extract_blocking_values_from_record-321"><span class="linenos">321</span></a>    <span class="n">record</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">blocking_fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>
</span><span id="extract_blocking_values_from_record-322"><a href="#extract_blocking_values_from_record-322"><span class="linenos">322</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="extract_blocking_values_from_record-323"><a href="#extract_blocking_values_from_record-323"><span class="linenos">323</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="extract_blocking_values_from_record-324"><a href="#extract_blocking_values_from_record-324"><span class="linenos">324</span></a><span class="sd">    Extracts values from a given patient record for eventual use in database</span>
</span><span id="extract_blocking_values_from_record-325"><a href="#extract_blocking_values_from_record-325"><span class="linenos">325</span></a><span class="sd">    record linkage blocking. A list of fields to block on, as well as a mapping</span>
</span><span id="extract_blocking_values_from_record-326"><a href="#extract_blocking_values_from_record-326"><span class="linenos">326</span></a><span class="sd">    of those fields to any desired transformations of their extracted values,</span>
</span><span id="extract_blocking_values_from_record-327"><a href="#extract_blocking_values_from_record-327"><span class="linenos">327</span></a><span class="sd">    is used to fhir-path parse the value out of the incoming patient record.</span>
</span><span id="extract_blocking_values_from_record-328"><a href="#extract_blocking_values_from_record-328"><span class="linenos">328</span></a>
</span><span id="extract_blocking_values_from_record-329"><a href="#extract_blocking_values_from_record-329"><span class="linenos">329</span></a><span class="sd">    Currently supported blocking fields:</span>
</span><span id="extract_blocking_values_from_record-330"><a href="#extract_blocking_values_from_record-330"><span class="linenos">330</span></a><span class="sd">    - first_name</span>
</span><span id="extract_blocking_values_from_record-331"><a href="#extract_blocking_values_from_record-331"><span class="linenos">331</span></a><span class="sd">    - last_name</span>
</span><span id="extract_blocking_values_from_record-332"><a href="#extract_blocking_values_from_record-332"><span class="linenos">332</span></a><span class="sd">    - birthdate</span>
</span><span id="extract_blocking_values_from_record-333"><a href="#extract_blocking_values_from_record-333"><span class="linenos">333</span></a><span class="sd">    - address</span>
</span><span id="extract_blocking_values_from_record-334"><a href="#extract_blocking_values_from_record-334"><span class="linenos">334</span></a><span class="sd">    - city</span>
</span><span id="extract_blocking_values_from_record-335"><a href="#extract_blocking_values_from_record-335"><span class="linenos">335</span></a><span class="sd">    - state</span>
</span><span id="extract_blocking_values_from_record-336"><a href="#extract_blocking_values_from_record-336"><span class="linenos">336</span></a><span class="sd">    - zip</span>
</span><span id="extract_blocking_values_from_record-337"><a href="#extract_blocking_values_from_record-337"><span class="linenos">337</span></a><span class="sd">    - sex</span>
</span><span id="extract_blocking_values_from_record-338"><a href="#extract_blocking_values_from_record-338"><span class="linenos">338</span></a><span class="sd">    - mrn</span>
</span><span id="extract_blocking_values_from_record-339"><a href="#extract_blocking_values_from_record-339"><span class="linenos">339</span></a>
</span><span id="extract_blocking_values_from_record-340"><a href="#extract_blocking_values_from_record-340"><span class="linenos">340</span></a><span class="sd">    Currently supported transformations on extracted fields:</span>
</span><span id="extract_blocking_values_from_record-341"><a href="#extract_blocking_values_from_record-341"><span class="linenos">341</span></a><span class="sd">    - first4: the first four characters of the value</span>
</span><span id="extract_blocking_values_from_record-342"><a href="#extract_blocking_values_from_record-342"><span class="linenos">342</span></a><span class="sd">    - last4: the last four characters of the value</span>
</span><span id="extract_blocking_values_from_record-343"><a href="#extract_blocking_values_from_record-343"><span class="linenos">343</span></a>
</span><span id="extract_blocking_values_from_record-344"><a href="#extract_blocking_values_from_record-344"><span class="linenos">344</span></a><span class="sd">    :param record: A FHIR-formatted Patient record.</span>
</span><span id="extract_blocking_values_from_record-345"><a href="#extract_blocking_values_from_record-345"><span class="linenos">345</span></a><span class="sd">    :param blocking_fields: A List of dictionaries giving the blocking</span>
</span><span id="extract_blocking_values_from_record-346"><a href="#extract_blocking_values_from_record-346"><span class="linenos">346</span></a><span class="sd">      fields and any transformations that should be applied to them. Each</span>
</span><span id="extract_blocking_values_from_record-347"><a href="#extract_blocking_values_from_record-347"><span class="linenos">347</span></a><span class="sd">      dictionary in the list should include a &quot;value&quot; key with one of the</span>
</span><span id="extract_blocking_values_from_record-348"><a href="#extract_blocking_values_from_record-348"><span class="linenos">348</span></a><span class="sd">      supported blocking fields above, and may also optionally contain a</span>
</span><span id="extract_blocking_values_from_record-349"><a href="#extract_blocking_values_from_record-349"><span class="linenos">349</span></a><span class="sd">      &quot;transformation&quot; key whose value is one of our supported transforms.</span>
</span><span id="extract_blocking_values_from_record-350"><a href="#extract_blocking_values_from_record-350"><span class="linenos">350</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="extract_blocking_values_from_record-351"><a href="#extract_blocking_values_from_record-351"><span class="linenos">351</span></a>
</span><span id="extract_blocking_values_from_record-352"><a href="#extract_blocking_values_from_record-352"><span class="linenos">352</span></a>    <span class="n">transform_funcs</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="extract_blocking_values_from_record-353"><a href="#extract_blocking_values_from_record-353"><span class="linenos">353</span></a>        <span class="s2">&quot;first4&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="k">else</span> <span class="n">x</span><span class="p">,</span>
</span><span id="extract_blocking_values_from_record-354"><a href="#extract_blocking_values_from_record-354"><span class="linenos">354</span></a>        <span class="s2">&quot;last4&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="k">else</span> <span class="n">x</span><span class="p">,</span>
</span><span id="extract_blocking_values_from_record-355"><a href="#extract_blocking_values_from_record-355"><span class="linenos">355</span></a>    <span class="p">}</span>
</span><span id="extract_blocking_values_from_record-356"><a href="#extract_blocking_values_from_record-356"><span class="linenos">356</span></a>
</span><span id="extract_blocking_values_from_record-357"><a href="#extract_blocking_values_from_record-357"><span class="linenos">357</span></a>    <span class="k">for</span> <span class="n">block_dict</span> <span class="ow">in</span> <span class="n">blocking_fields</span><span class="p">:</span>
</span><span id="extract_blocking_values_from_record-358"><a href="#extract_blocking_values_from_record-358"><span class="linenos">358</span></a>        <span class="k">if</span> <span class="s2">&quot;value&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">block_dict</span><span class="p">:</span>
</span><span id="extract_blocking_values_from_record-359"><a href="#extract_blocking_values_from_record-359"><span class="linenos">359</span></a>            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
</span><span id="extract_blocking_values_from_record-360"><a href="#extract_blocking_values_from_record-360"><span class="linenos">360</span></a>                <span class="sa">f</span><span class="s2">&quot;Input dictionary for block </span><span class="si">{</span><span class="n">block_dict</span><span class="si">}</span><span class="s2"> must contain a &#39;value&#39; key.&quot;</span>
</span><span id="extract_blocking_values_from_record-361"><a href="#extract_blocking_values_from_record-361"><span class="linenos">361</span></a>            <span class="p">)</span>
</span><span id="extract_blocking_values_from_record-362"><a href="#extract_blocking_values_from_record-362"><span class="linenos">362</span></a>
</span><span id="extract_blocking_values_from_record-363"><a href="#extract_blocking_values_from_record-363"><span class="linenos">363</span></a>    <span class="n">block_vals</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">([</span><span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">blocking_fields</span><span class="p">],</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="extract_blocking_values_from_record-364"><a href="#extract_blocking_values_from_record-364"><span class="linenos">364</span></a>    <span class="n">transform_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">blocking_fields</span> <span class="k">if</span> <span class="s2">&quot;transformation&quot;</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]</span>
</span><span id="extract_blocking_values_from_record-365"><a href="#extract_blocking_values_from_record-365"><span class="linenos">365</span></a>    <span class="n">transformations</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="extract_blocking_values_from_record-366"><a href="#extract_blocking_values_from_record-366"><span class="linenos">366</span></a>        <span class="nb">zip</span><span class="p">(</span>
</span><span id="extract_blocking_values_from_record-367"><a href="#extract_blocking_values_from_record-367"><span class="linenos">367</span></a>            <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">transform_blocks</span><span class="p">],</span>
</span><span id="extract_blocking_values_from_record-368"><a href="#extract_blocking_values_from_record-368"><span class="linenos">368</span></a>            <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;transformation&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">transform_blocks</span><span class="p">],</span>
</span><span id="extract_blocking_values_from_record-369"><a href="#extract_blocking_values_from_record-369"><span class="linenos">369</span></a>        <span class="p">)</span>
</span><span id="extract_blocking_values_from_record-370"><a href="#extract_blocking_values_from_record-370"><span class="linenos">370</span></a>    <span class="p">)</span>
</span><span id="extract_blocking_values_from_record-371"><a href="#extract_blocking_values_from_record-371"><span class="linenos">371</span></a>    <span class="k">for</span> <span class="n">block_dict</span> <span class="ow">in</span> <span class="n">blocking_fields</span><span class="p">:</span>
</span><span id="extract_blocking_values_from_record-372"><a href="#extract_blocking_values_from_record-372"><span class="linenos">372</span></a>        <span class="n">block</span> <span class="o">=</span> <span class="n">block_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
</span><span id="extract_blocking_values_from_record-373"><a href="#extract_blocking_values_from_record-373"><span class="linenos">373</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="extract_blocking_values_from_record-374"><a href="#extract_blocking_values_from_record-374"><span class="linenos">374</span></a>            <span class="c1"># Apply utility extractor for safe parsing</span>
</span><span id="extract_blocking_values_from_record-375"><a href="#extract_blocking_values_from_record-375"><span class="linenos">375</span></a>            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="extract_blocking_values_from_record-376"><a href="#extract_blocking_values_from_record-376"><span class="linenos">376</span></a>                <span class="n">extract_value_with_resource_path</span><span class="p">(</span>
</span><span id="extract_blocking_values_from_record-377"><a href="#extract_blocking_values_from_record-377"><span class="linenos">377</span></a>                    <span class="n">record</span><span class="p">,</span>
</span><span id="extract_blocking_values_from_record-378"><a href="#extract_blocking_values_from_record-378"><span class="linenos">378</span></a>                    <span class="n">LINKING_FIELDS_TO_FHIRPATHS</span><span class="p">[</span><span class="n">block</span><span class="p">],</span>
</span><span id="extract_blocking_values_from_record-379"><a href="#extract_blocking_values_from_record-379"><span class="linenos">379</span></a>                    <span class="n">selection_criteria</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">,</span>
</span><span id="extract_blocking_values_from_record-380"><a href="#extract_blocking_values_from_record-380"><span class="linenos">380</span></a>                <span class="p">)</span>
</span><span id="extract_blocking_values_from_record-381"><a href="#extract_blocking_values_from_record-381"><span class="linenos">381</span></a>            <span class="p">)</span>
</span><span id="extract_blocking_values_from_record-382"><a href="#extract_blocking_values_from_record-382"><span class="linenos">382</span></a>            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
</span><span id="extract_blocking_values_from_record-383"><a href="#extract_blocking_values_from_record-383"><span class="linenos">383</span></a>                <span class="k">if</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">transformations</span><span class="p">:</span>
</span><span id="extract_blocking_values_from_record-384"><a href="#extract_blocking_values_from_record-384"><span class="linenos">384</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="extract_blocking_values_from_record-385"><a href="#extract_blocking_values_from_record-385"><span class="linenos">385</span></a>                        <span class="n">value</span> <span class="o">=</span> <span class="n">transform_funcs</span><span class="p">[</span><span class="n">transformations</span><span class="p">[</span><span class="n">block</span><span class="p">]](</span><span class="n">value</span><span class="p">)</span>
</span><span id="extract_blocking_values_from_record-386"><a href="#extract_blocking_values_from_record-386"><span class="linenos">386</span></a>                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span id="extract_blocking_values_from_record-387"><a href="#extract_blocking_values_from_record-387"><span class="linenos">387</span></a>                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="extract_blocking_values_from_record-388"><a href="#extract_blocking_values_from_record-388"><span class="linenos">388</span></a>                            <span class="sa">f</span><span class="s2">&quot;Transformation </span><span class="si">{</span><span class="n">transformations</span><span class="p">[</span><span class="n">block</span><span class="p">]</span><span class="si">}</span><span class="s2"> is not valid.&quot;</span>
</span><span id="extract_blocking_values_from_record-389"><a href="#extract_blocking_values_from_record-389"><span class="linenos">389</span></a>                        <span class="p">)</span>
</span><span id="extract_blocking_values_from_record-390"><a href="#extract_blocking_values_from_record-390"><span class="linenos">390</span></a>                    <span class="n">block_vals</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="extract_blocking_values_from_record-391"><a href="#extract_blocking_values_from_record-391"><span class="linenos">391</span></a>                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
</span><span id="extract_blocking_values_from_record-392"><a href="#extract_blocking_values_from_record-392"><span class="linenos">392</span></a>                        <span class="s2">&quot;transformation&quot;</span><span class="p">:</span> <span class="n">transformations</span><span class="p">[</span><span class="n">block</span><span class="p">],</span>
</span><span id="extract_blocking_values_from_record-393"><a href="#extract_blocking_values_from_record-393"><span class="linenos">393</span></a>                    <span class="p">}</span>
</span><span id="extract_blocking_values_from_record-394"><a href="#extract_blocking_values_from_record-394"><span class="linenos">394</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="extract_blocking_values_from_record-395"><a href="#extract_blocking_values_from_record-395"><span class="linenos">395</span></a>                    <span class="n">block_vals</span><span class="p">[</span><span class="n">block</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span>
</span><span id="extract_blocking_values_from_record-396"><a href="#extract_blocking_values_from_record-396"><span class="linenos">396</span></a>
</span><span id="extract_blocking_values_from_record-397"><a href="#extract_blocking_values_from_record-397"><span class="linenos">397</span></a>        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span id="extract_blocking_values_from_record-398"><a href="#extract_blocking_values_from_record-398"><span class="linenos">398</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field </span><span class="si">{</span><span class="n">block</span><span class="si">}</span><span class="s2"> is not a supported extraction field.&quot;</span><span class="p">)</span>
</span><span id="extract_blocking_values_from_record-399"><a href="#extract_blocking_values_from_record-399"><span class="linenos">399</span></a>
</span><span id="extract_blocking_values_from_record-400"><a href="#extract_blocking_values_from_record-400"><span class="linenos">400</span></a>    <span class="k">return</span> <span class="n">block_vals</span>
</span></pre></div>


            <div class="docstring"><p>Extracts values from a given patient record for eventual use in database
record linkage blocking. A list of fields to block on, as well as a mapping
of those fields to any desired transformations of their extracted values,
is used to fhir-path parse the value out of the incoming patient record.</p>

<p>Currently supported blocking fields:</p>

<ul>
<li>first_name</li>
<li>last_name</li>
<li>birthdate</li>
<li>address</li>
<li>city</li>
<li>state</li>
<li>zip</li>
<li>sex</li>
<li>mrn</li>
</ul>

<p>Currently supported transformations on extracted fields:</p>

<ul>
<li>first4: the first four characters of the value</li>
<li>last4: the last four characters of the value</li>
</ul>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>record</strong>:  A FHIR-formatted Patient record.</li>
<li><strong>blocking_fields</strong>:  A List of dictionaries giving the blocking
fields and any transformations that should be applied to them. Each
dictionary in the list should include a "value" key with one of the
supported blocking fields above, and may also optionally contain a
"transformation" key whose value is one of our supported transforms.</li>
</ul>
</div>


                </section>
                <section id="write_linkage_config">
                            <input id="write_linkage_config-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">write_linkage_config</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">linkage_algo</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>, </span><span class="param"><span class="n">file_to_write</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="write_linkage_config-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#write_linkage_config"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="write_linkage_config-1006"><a href="#write_linkage_config-1006"><span class="linenos">1006</span></a><span class="k">def</span> <span class="nf">write_linkage_config</span><span class="p">(</span><span class="n">linkage_algo</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">file_to_write</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="write_linkage_config-1007"><a href="#write_linkage_config-1007"><span class="linenos">1007</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="write_linkage_config-1008"><a href="#write_linkage_config-1008"><span class="linenos">1008</span></a><span class="sd">    Save a provided algorithm description as a JSON dictionary at the provided</span>
</span><span id="write_linkage_config-1009"><a href="#write_linkage_config-1009"><span class="linenos">1009</span></a><span class="sd">    filepath location. Algorithm descriptions are lists of dictionaries, one</span>
</span><span id="write_linkage_config-1010"><a href="#write_linkage_config-1010"><span class="linenos">1010</span></a><span class="sd">    for each pass of the algorithm, whose keys are parameter values for a</span>
</span><span id="write_linkage_config-1011"><a href="#write_linkage_config-1011"><span class="linenos">1011</span></a><span class="sd">    linkage pass (drawn from the list `&quot;funcs&quot;`, `&quot;blocks&quot;`, `&quot;matching_rule&quot;`,</span>
</span><span id="write_linkage_config-1012"><a href="#write_linkage_config-1012"><span class="linenos">1012</span></a><span class="sd">    and optionally `&quot;cluster_ratio&quot;` and `&quot;kwargs&quot;`) and whose values are</span>
</span><span id="write_linkage_config-1013"><a href="#write_linkage_config-1013"><span class="linenos">1013</span></a><span class="sd">    as follows:</span>
</span><span id="write_linkage_config-1014"><a href="#write_linkage_config-1014"><span class="linenos">1014</span></a>
</span><span id="write_linkage_config-1015"><a href="#write_linkage_config-1015"><span class="linenos">1015</span></a><span class="sd">    - `&quot;funcs&quot;` should map to a dictionary mapping column index to the</span>
</span><span id="write_linkage_config-1016"><a href="#write_linkage_config-1016"><span class="linenos">1016</span></a><span class="sd">    name of a function in the DIBBS linkage module (such as</span>
</span><span id="write_linkage_config-1017"><a href="#write_linkage_config-1017"><span class="linenos">1017</span></a><span class="sd">    `feature_match_fuzzy_string`)--note that these are the actual</span>
</span><span id="write_linkage_config-1018"><a href="#write_linkage_config-1018"><span class="linenos">1018</span></a><span class="sd">    functions, not string names of the functions</span>
</span><span id="write_linkage_config-1019"><a href="#write_linkage_config-1019"><span class="linenos">1019</span></a><span class="sd">    - `&quot;blocks&quot;` should map to a list of columns to block on (e.g.</span>
</span><span id="write_linkage_config-1020"><a href="#write_linkage_config-1020"><span class="linenos">1020</span></a><span class="sd">    [&quot;MRN4&quot;, &quot;ADDRESS4&quot;])</span>
</span><span id="write_linkage_config-1021"><a href="#write_linkage_config-1021"><span class="linenos">1021</span></a><span class="sd">    - `&quot;matching_rule&quot;` should map to one of the evaluation rule functions</span>
</span><span id="write_linkage_config-1022"><a href="#write_linkage_config-1022"><span class="linenos">1022</span></a><span class="sd">    in the DIBBS linkage module (i.e. `eval_perfect_match`)</span>
</span><span id="write_linkage_config-1023"><a href="#write_linkage_config-1023"><span class="linenos">1023</span></a><span class="sd">    - `&quot;cluster_ratio&quot;` should map to a float, if provided</span>
</span><span id="write_linkage_config-1024"><a href="#write_linkage_config-1024"><span class="linenos">1024</span></a><span class="sd">    - `&quot;kwargs&quot;` should map to a dictionary of keyword arguments and their</span>
</span><span id="write_linkage_config-1025"><a href="#write_linkage_config-1025"><span class="linenos">1025</span></a><span class="sd">    associated values, if provided</span>
</span><span id="write_linkage_config-1026"><a href="#write_linkage_config-1026"><span class="linenos">1026</span></a>
</span><span id="write_linkage_config-1027"><a href="#write_linkage_config-1027"><span class="linenos">1027</span></a><span class="sd">    Here&#39;s an example of a simple single-pass linkage algorithm that blocks</span>
</span><span id="write_linkage_config-1028"><a href="#write_linkage_config-1028"><span class="linenos">1028</span></a><span class="sd">    on zip code, then matches on exact first name, exact last name, and</span>
</span><span id="write_linkage_config-1029"><a href="#write_linkage_config-1029"><span class="linenos">1029</span></a><span class="sd">    fuzzy date of birth (using, say, Levenshtein similarity with a score</span>
</span><span id="write_linkage_config-1030"><a href="#write_linkage_config-1030"><span class="linenos">1030</span></a><span class="sd">    threshold of 0.8) in dictionary descriptor form (for the sake of the</span>
</span><span id="write_linkage_config-1031"><a href="#write_linkage_config-1031"><span class="linenos">1031</span></a><span class="sd">    example, let&#39;s assume the data has the column order first, last, DOB):</span>
</span><span id="write_linkage_config-1032"><a href="#write_linkage_config-1032"><span class="linenos">1032</span></a>
</span><span id="write_linkage_config-1033"><a href="#write_linkage_config-1033"><span class="linenos">1033</span></a><span class="sd">    [{</span>
</span><span id="write_linkage_config-1034"><a href="#write_linkage_config-1034"><span class="linenos">1034</span></a><span class="sd">        &quot;funcs&quot;: {</span>
</span><span id="write_linkage_config-1035"><a href="#write_linkage_config-1035"><span class="linenos">1035</span></a><span class="sd">            0: feature_match_exact,</span>
</span><span id="write_linkage_config-1036"><a href="#write_linkage_config-1036"><span class="linenos">1036</span></a><span class="sd">            1: feature_match_exact,</span>
</span><span id="write_linkage_config-1037"><a href="#write_linkage_config-1037"><span class="linenos">1037</span></a><span class="sd">            2: feature_match_fuzzy_string,</span>
</span><span id="write_linkage_config-1038"><a href="#write_linkage_config-1038"><span class="linenos">1038</span></a><span class="sd">            3: feature_match_fuzzy_string,</span>
</span><span id="write_linkage_config-1039"><a href="#write_linkage_config-1039"><span class="linenos">1039</span></a><span class="sd">        },</span>
</span><span id="write_linkage_config-1040"><a href="#write_linkage_config-1040"><span class="linenos">1040</span></a><span class="sd">        &quot;blocks&quot;: [&quot;ZIP&quot;],</span>
</span><span id="write_linkage_config-1041"><a href="#write_linkage_config-1041"><span class="linenos">1041</span></a><span class="sd">        &quot;matching_rule&quot;: eval_perfect_match,</span>
</span><span id="write_linkage_config-1042"><a href="#write_linkage_config-1042"><span class="linenos">1042</span></a><span class="sd">        &quot;kwargs&quot;: {</span>
</span><span id="write_linkage_config-1043"><a href="#write_linkage_config-1043"><span class="linenos">1043</span></a><span class="sd">            &quot;similarity-measure&quot;: &quot;Levenshtein&quot;,</span>
</span><span id="write_linkage_config-1044"><a href="#write_linkage_config-1044"><span class="linenos">1044</span></a><span class="sd">            &quot;threshold&quot;: 0.8</span>
</span><span id="write_linkage_config-1045"><a href="#write_linkage_config-1045"><span class="linenos">1045</span></a><span class="sd">        }</span>
</span><span id="write_linkage_config-1046"><a href="#write_linkage_config-1046"><span class="linenos">1046</span></a><span class="sd">    }]</span>
</span><span id="write_linkage_config-1047"><a href="#write_linkage_config-1047"><span class="linenos">1047</span></a>
</span><span id="write_linkage_config-1048"><a href="#write_linkage_config-1048"><span class="linenos">1048</span></a><span class="sd">    :param linkage_algo: A list of dictionaries whose key-value pairs correspond</span>
</span><span id="write_linkage_config-1049"><a href="#write_linkage_config-1049"><span class="linenos">1049</span></a><span class="sd">      to the rules above.</span>
</span><span id="write_linkage_config-1050"><a href="#write_linkage_config-1050"><span class="linenos">1050</span></a><span class="sd">    :param file_to_write: The path to the destination JSON file to write.</span>
</span><span id="write_linkage_config-1051"><a href="#write_linkage_config-1051"><span class="linenos">1051</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="write_linkage_config-1052"><a href="#write_linkage_config-1052"><span class="linenos">1052</span></a>    <span class="n">algo_json</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="write_linkage_config-1053"><a href="#write_linkage_config-1053"><span class="linenos">1053</span></a>    <span class="k">for</span> <span class="n">rl_pass</span> <span class="ow">in</span> <span class="n">linkage_algo</span><span class="p">:</span>
</span><span id="write_linkage_config-1054"><a href="#write_linkage_config-1054"><span class="linenos">1054</span></a>        <span class="n">pass_json</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="write_linkage_config-1055"><a href="#write_linkage_config-1055"><span class="linenos">1055</span></a>        <span class="n">pass_json</span><span class="p">[</span><span class="s2">&quot;funcs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="ow">in</span> <span class="n">rl_pass</span><span class="p">[</span><span class="s2">&quot;funcs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="write_linkage_config-1056"><a href="#write_linkage_config-1056"><span class="linenos">1056</span></a>        <span class="n">pass_json</span><span class="p">[</span><span class="s2">&quot;blocks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rl_pass</span><span class="p">[</span><span class="s2">&quot;blocks&quot;</span><span class="p">]</span>
</span><span id="write_linkage_config-1057"><a href="#write_linkage_config-1057"><span class="linenos">1057</span></a>        <span class="n">pass_json</span><span class="p">[</span><span class="s2">&quot;matching_rule&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rl_pass</span><span class="p">[</span><span class="s2">&quot;matching_rule&quot;</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="write_linkage_config-1058"><a href="#write_linkage_config-1058"><span class="linenos">1058</span></a>        <span class="k">if</span> <span class="n">rl_pass</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cluster_ratio&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="write_linkage_config-1059"><a href="#write_linkage_config-1059"><span class="linenos">1059</span></a>            <span class="n">pass_json</span><span class="p">[</span><span class="s2">&quot;cluster_ratio&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rl_pass</span><span class="p">[</span><span class="s2">&quot;cluster_ratio&quot;</span><span class="p">]</span>
</span><span id="write_linkage_config-1060"><a href="#write_linkage_config-1060"><span class="linenos">1060</span></a>        <span class="k">if</span> <span class="n">rl_pass</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kwargs&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="write_linkage_config-1061"><a href="#write_linkage_config-1061"><span class="linenos">1061</span></a>            <span class="n">pass_json</span><span class="p">[</span><span class="s2">&quot;kwargs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="write_linkage_config-1062"><a href="#write_linkage_config-1062"><span class="linenos">1062</span></a>                <span class="n">kwarg</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="p">(</span><span class="n">kwarg</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="n">rl_pass</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kwargs&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="write_linkage_config-1063"><a href="#write_linkage_config-1063"><span class="linenos">1063</span></a>            <span class="p">}</span>
</span><span id="write_linkage_config-1064"><a href="#write_linkage_config-1064"><span class="linenos">1064</span></a>        <span class="n">algo_json</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pass_json</span><span class="p">)</span>
</span><span id="write_linkage_config-1065"><a href="#write_linkage_config-1065"><span class="linenos">1065</span></a>    <span class="n">linkage_json</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;algorithm&quot;</span><span class="p">:</span> <span class="n">algo_json</span><span class="p">}</span>
</span><span id="write_linkage_config-1066"><a href="#write_linkage_config-1066"><span class="linenos">1066</span></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_to_write</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
</span><span id="write_linkage_config-1067"><a href="#write_linkage_config-1067"><span class="linenos">1067</span></a>        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">linkage_json</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Save a provided algorithm description as a JSON dictionary at the provided
filepath location. Algorithm descriptions are lists of dictionaries, one
for each pass of the algorithm, whose keys are parameter values for a
linkage pass (drawn from the list <code>"funcs"</code>, <code>"blocks"</code>, <code>"matching_rule"</code>,
and optionally <code>"cluster_ratio"</code> and <code>"kwargs"</code>) and whose values are
as follows:</p>

<ul>
<li><code>"funcs"</code> should map to a dictionary mapping column index to the
name of a function in the DIBBS linkage module (such as
<code><a href="#feature_match_fuzzy_string">feature_match_fuzzy_string</a></code>)--note that these are the actual
functions, not string names of the functions</li>
<li><code>"blocks"</code> should map to a list of columns to block on (e.g.
["MRN4", "ADDRESS4"])</li>
<li><code>"matching_rule"</code> should map to one of the evaluation rule functions
in the DIBBS linkage module (i.e. <code><a href="#eval_perfect_match">eval_perfect_match</a></code>)</li>
<li><code>"cluster_ratio"</code> should map to a float, if provided</li>
<li><code>"kwargs"</code> should map to a dictionary of keyword arguments and their
associated values, if provided</li>
</ul>

<p>Here's an example of a simple single-pass linkage algorithm that blocks
on zip code, then matches on exact first name, exact last name, and
fuzzy date of birth (using, say, Levenshtein similarity with a score
threshold of 0.8) in dictionary descriptor form (for the sake of the
example, let's assume the data has the column order first, last, DOB):</p>

<p>[{
    "funcs": {
        0: feature_match_exact,
        1: feature_match_exact,
        2: feature_match_fuzzy_string,
        3: feature_match_fuzzy_string,
    },
    "blocks": ["ZIP"],
    "matching_rule": eval_perfect_match,
    "kwargs": {
        "similarity-measure": "Levenshtein",
        "threshold": 0.8
    }
}]</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>linkage_algo</strong>:  A list of dictionaries whose key-value pairs correspond
to the rules above.</li>
<li><strong>file_to_write</strong>:  The path to the destination JSON file to write.</li>
</ul>
</div>


                </section>
                <section id="read_linkage_config">
                            <input id="read_linkage_config-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">read_linkage_config</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">config_file</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="read_linkage_config-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#read_linkage_config"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="read_linkage_config-894"><a href="#read_linkage_config-894"><span class="linenos">894</span></a><span class="k">def</span> <span class="nf">read_linkage_config</span><span class="p">(</span><span class="n">config_file</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
</span><span id="read_linkage_config-895"><a href="#read_linkage_config-895"><span class="linenos">895</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="read_linkage_config-896"><a href="#read_linkage_config-896"><span class="linenos">896</span></a><span class="sd">    Reads and generates a record linkage algorithm configuration list from</span>
</span><span id="read_linkage_config-897"><a href="#read_linkage_config-897"><span class="linenos">897</span></a><span class="sd">    the provided filepath, which should point to a JSON file. A record</span>
</span><span id="read_linkage_config-898"><a href="#read_linkage_config-898"><span class="linenos">898</span></a><span class="sd">    linkage configuration list is a list of dictionaries--one for each</span>
</span><span id="read_linkage_config-899"><a href="#read_linkage_config-899"><span class="linenos">899</span></a><span class="sd">    pass in the algorithm it describes--containing information on the</span>
</span><span id="read_linkage_config-900"><a href="#read_linkage_config-900"><span class="linenos">900</span></a><span class="sd">    blocking fields, functions, cluster thresholds, and keyword arguments</span>
</span><span id="read_linkage_config-901"><a href="#read_linkage_config-901"><span class="linenos">901</span></a><span class="sd">    for that pass of the linkage algorithm. For a full example of all the</span>
</span><span id="read_linkage_config-902"><a href="#read_linkage_config-902"><span class="linenos">902</span></a><span class="sd">    components involved in a linkage description structure, see the doc</span>
</span><span id="read_linkage_config-903"><a href="#read_linkage_config-903"><span class="linenos">903</span></a><span class="sd">    string for `write_linkage_config`.</span>
</span><span id="read_linkage_config-904"><a href="#read_linkage_config-904"><span class="linenos">904</span></a>
</span><span id="read_linkage_config-905"><a href="#read_linkage_config-905"><span class="linenos">905</span></a><span class="sd">    :param config_file: A `pathlib.Path` string pointing to a JSON file</span>
</span><span id="read_linkage_config-906"><a href="#read_linkage_config-906"><span class="linenos">906</span></a><span class="sd">      that describes the algorithm to decode.</span>
</span><span id="read_linkage_config-907"><a href="#read_linkage_config-907"><span class="linenos">907</span></a><span class="sd">    :return: A list of dictionaries whose values can be passed to the</span>
</span><span id="read_linkage_config-908"><a href="#read_linkage_config-908"><span class="linenos">908</span></a><span class="sd">      various parts of linkage pass function.</span>
</span><span id="read_linkage_config-909"><a href="#read_linkage_config-909"><span class="linenos">909</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="read_linkage_config-910"><a href="#read_linkage_config-910"><span class="linenos">910</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="read_linkage_config-911"><a href="#read_linkage_config-911"><span class="linenos">911</span></a>        <span class="n">algo_config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">))</span>
</span><span id="read_linkage_config-912"><a href="#read_linkage_config-912"><span class="linenos">912</span></a>        <span class="c1"># Need to convert function keys back to column indices, since</span>
</span><span id="read_linkage_config-913"><a href="#read_linkage_config-913"><span class="linenos">913</span></a>        <span class="c1"># JSON serializes dict keys as strings</span>
</span><span id="read_linkage_config-914"><a href="#read_linkage_config-914"><span class="linenos">914</span></a>        <span class="k">for</span> <span class="n">rl_pass</span> <span class="ow">in</span> <span class="n">algo_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;algorithm&quot;</span><span class="p">):</span>
</span><span id="read_linkage_config-915"><a href="#read_linkage_config-915"><span class="linenos">915</span></a>            <span class="n">rl_pass</span><span class="p">[</span><span class="s2">&quot;funcs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="p">):</span> <span class="n">f</span> <span class="k">for</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="ow">in</span> <span class="n">rl_pass</span><span class="p">[</span><span class="s2">&quot;funcs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="read_linkage_config-916"><a href="#read_linkage_config-916"><span class="linenos">916</span></a>        <span class="k">return</span> <span class="n">algo_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;algorithm&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="read_linkage_config-917"><a href="#read_linkage_config-917"><span class="linenos">917</span></a>    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
</span><span id="read_linkage_config-918"><a href="#read_linkage_config-918"><span class="linenos">918</span></a>        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No file exists at path </span><span class="si">{</span><span class="n">config_file</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="read_linkage_config-919"><a href="#read_linkage_config-919"><span class="linenos">919</span></a>    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="read_linkage_config-920"><a href="#read_linkage_config-920"><span class="linenos">920</span></a>        <span class="k">raise</span> <span class="n">json</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">(</span>
</span><span id="read_linkage_config-921"><a href="#read_linkage_config-921"><span class="linenos">921</span></a>            <span class="s2">&quot;The specified file is not valid JSON.&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">doc</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">pos</span>
</span><span id="read_linkage_config-922"><a href="#read_linkage_config-922"><span class="linenos">922</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Reads and generates a record linkage algorithm configuration list from
the provided filepath, which should point to a JSON file. A record
linkage configuration list is a list of dictionaries--one for each
pass in the algorithm it describes--containing information on the
blocking fields, functions, cluster thresholds, and keyword arguments
for that pass of the linkage algorithm. For a full example of all the
components involved in a linkage description structure, see the doc
string for <code><a href="#write_linkage_config">write_linkage_config</a></code>.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>config_file</strong>:  A <code>pathlib.Path</code> string pointing to a JSON file
that describes the algorithm to decode.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>A list of dictionaries whose values can be passed to the
    various parts of linkage pass function.</p>
</blockquote>
</div>


                </section>
                <section id="DIBBsConnectorClient">
                            <input id="DIBBsConnectorClient-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">DIBBsConnectorClient</span><wbr>(<span class="base"><a href="#BaseMPIConnectorClient">phdi.linkage.BaseMPIConnectorClient</a></span>):

                <label class="view-source-button" for="DIBBsConnectorClient-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DIBBsConnectorClient"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DIBBsConnectorClient-11"><a href="#DIBBsConnectorClient-11"><span class="linenos"> 11</span></a><span class="k">class</span> <span class="nc">DIBBsConnectorClient</span><span class="p">(</span><span class="n">BaseMPIConnectorClient</span><span class="p">):</span>
</span><span id="DIBBsConnectorClient-12"><a href="#DIBBsConnectorClient-12"><span class="linenos"> 12</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DIBBsConnectorClient-13"><a href="#DIBBsConnectorClient-13"><span class="linenos"> 13</span></a><span class="sd">    Represents a Postgres-specific Master Patient Index (MPI) connector</span>
</span><span id="DIBBsConnectorClient-14"><a href="#DIBBsConnectorClient-14"><span class="linenos"> 14</span></a><span class="sd">    client for the DIBBs implementation of the record linkage building</span>
</span><span id="DIBBsConnectorClient-15"><a href="#DIBBsConnectorClient-15"><span class="linenos"> 15</span></a><span class="sd">    block. Callers should use the provided interface functions (e.g.,</span>
</span><span id="DIBBsConnectorClient-16"><a href="#DIBBsConnectorClient-16"><span class="linenos"> 16</span></a><span class="sd">    block_vals) to interact with the underlying vendor-specific client</span>
</span><span id="DIBBsConnectorClient-17"><a href="#DIBBsConnectorClient-17"><span class="linenos"> 17</span></a><span class="sd">    property.</span>
</span><span id="DIBBsConnectorClient-18"><a href="#DIBBsConnectorClient-18"><span class="linenos"> 18</span></a>
</span><span id="DIBBsConnectorClient-19"><a href="#DIBBsConnectorClient-19"><span class="linenos"> 19</span></a><span class="sd">    When instantiating a DIBBSConnectorClient, the connection to the</span>
</span><span id="DIBBsConnectorClient-20"><a href="#DIBBsConnectorClient-20"><span class="linenos"> 20</span></a><span class="sd">    database is automatically tested using the provided parameters.</span>
</span><span id="DIBBsConnectorClient-21"><a href="#DIBBsConnectorClient-21"><span class="linenos"> 21</span></a><span class="sd">    A refused, timed-out, or otherwise error-ed connection will raise</span>
</span><span id="DIBBsConnectorClient-22"><a href="#DIBBsConnectorClient-22"><span class="linenos"> 22</span></a><span class="sd">    an immediate exception.</span>
</span><span id="DIBBsConnectorClient-23"><a href="#DIBBsConnectorClient-23"><span class="linenos"> 23</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="DIBBsConnectorClient-24"><a href="#DIBBsConnectorClient-24"><span class="linenos"> 24</span></a>
</span><span id="DIBBsConnectorClient-25"><a href="#DIBBsConnectorClient-25"><span class="linenos"> 25</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="DIBBsConnectorClient-26"><a href="#DIBBsConnectorClient-26"><span class="linenos"> 26</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-27"><a href="#DIBBsConnectorClient-27"><span class="linenos"> 27</span></a>        <span class="n">database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-28"><a href="#DIBBsConnectorClient-28"><span class="linenos"> 28</span></a>        <span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-29"><a href="#DIBBsConnectorClient-29"><span class="linenos"> 29</span></a>        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-30"><a href="#DIBBsConnectorClient-30"><span class="linenos"> 30</span></a>        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-31"><a href="#DIBBsConnectorClient-31"><span class="linenos"> 31</span></a>        <span class="n">port</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-32"><a href="#DIBBsConnectorClient-32"><span class="linenos"> 32</span></a>        <span class="n">patient_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-33"><a href="#DIBBsConnectorClient-33"><span class="linenos"> 33</span></a>        <span class="n">person_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-34"><a href="#DIBBsConnectorClient-34"><span class="linenos"> 34</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient-35"><a href="#DIBBsConnectorClient-35"><span class="linenos"> 35</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
</span><span id="DIBBsConnectorClient-36"><a href="#DIBBsConnectorClient-36"><span class="linenos"> 36</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
</span><span id="DIBBsConnectorClient-37"><a href="#DIBBsConnectorClient-37"><span class="linenos"> 37</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
</span><span id="DIBBsConnectorClient-38"><a href="#DIBBsConnectorClient-38"><span class="linenos"> 38</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
</span><span id="DIBBsConnectorClient-39"><a href="#DIBBsConnectorClient-39"><span class="linenos"> 39</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
</span><span id="DIBBsConnectorClient-40"><a href="#DIBBsConnectorClient-40"><span class="linenos"> 40</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">patient_table</span> <span class="o">=</span> <span class="n">patient_table</span>
</span><span id="DIBBsConnectorClient-41"><a href="#DIBBsConnectorClient-41"><span class="linenos"> 41</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">person_table</span> <span class="o">=</span> <span class="n">person_table</span>
</span><span id="DIBBsConnectorClient-42"><a href="#DIBBsConnectorClient-42"><span class="linenos"> 42</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fields_to_jsonpaths</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="DIBBsConnectorClient-43"><a href="#DIBBsConnectorClient-43"><span class="linenos"> 43</span></a>            <span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;$.address[*].line&quot;&quot;&quot;</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-44"><a href="#DIBBsConnectorClient-44"><span class="linenos"> 44</span></a>            <span class="s2">&quot;birthdate&quot;</span><span class="p">:</span> <span class="s2">&quot;$.birthDate&quot;</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-45"><a href="#DIBBsConnectorClient-45"><span class="linenos"> 45</span></a>            <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;$.address[*].city&quot;&quot;&quot;</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-46"><a href="#DIBBsConnectorClient-46"><span class="linenos"> 46</span></a>            <span class="s2">&quot;first_name&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;$.name[*].given&quot;&quot;&quot;</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-47"><a href="#DIBBsConnectorClient-47"><span class="linenos"> 47</span></a>            <span class="s2">&quot;last_name&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;$.name[*].family&quot;&quot;&quot;</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-48"><a href="#DIBBsConnectorClient-48"><span class="linenos"> 48</span></a>            <span class="s2">&quot;mrn&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;$.identifier ?(@.type.coding[0].code==&quot;MR&quot;).value&quot;&quot;&quot;</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-49"><a href="#DIBBsConnectorClient-49"><span class="linenos"> 49</span></a>            <span class="s2">&quot;sex&quot;</span><span class="p">:</span> <span class="s2">&quot;$.gender&quot;</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-50"><a href="#DIBBsConnectorClient-50"><span class="linenos"> 50</span></a>            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;$.address[*].state&quot;&quot;&quot;</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-51"><a href="#DIBBsConnectorClient-51"><span class="linenos"> 51</span></a>            <span class="s2">&quot;zip&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;$.address[*].postalCode&quot;&quot;&quot;</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-52"><a href="#DIBBsConnectorClient-52"><span class="linenos"> 52</span></a>        <span class="p">}</span>
</span><span id="DIBBsConnectorClient-53"><a href="#DIBBsConnectorClient-53"><span class="linenos"> 53</span></a>        <span class="n">db_conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span>
</span><span id="DIBBsConnectorClient-54"><a href="#DIBBsConnectorClient-54"><span class="linenos"> 54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_close_connections</span><span class="p">(</span><span class="n">db_conn</span><span class="o">=</span><span class="n">db_conn</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient-55"><a href="#DIBBsConnectorClient-55"><span class="linenos"> 55</span></a>
</span><span id="DIBBsConnectorClient-56"><a href="#DIBBsConnectorClient-56"><span class="linenos"> 56</span></a>    <span class="k">def</span> <span class="nf">get_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">connection</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
</span><span id="DIBBsConnectorClient-57"><a href="#DIBBsConnectorClient-57"><span class="linenos"> 57</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DIBBsConnectorClient-58"><a href="#DIBBsConnectorClient-58"><span class="linenos"> 58</span></a><span class="sd">        Simple method for initiating a connection to the database specified</span>
</span><span id="DIBBsConnectorClient-59"><a href="#DIBBsConnectorClient-59"><span class="linenos"> 59</span></a><span class="sd">        by the parameters given to the class&#39; instantiation.</span>
</span><span id="DIBBsConnectorClient-60"><a href="#DIBBsConnectorClient-60"><span class="linenos"> 60</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DIBBsConnectorClient-61"><a href="#DIBBsConnectorClient-61"><span class="linenos"> 61</span></a>        <span class="n">db_conn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DIBBsConnectorClient-62"><a href="#DIBBsConnectorClient-62"><span class="linenos"> 62</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient-63"><a href="#DIBBsConnectorClient-63"><span class="linenos"> 63</span></a>            <span class="n">db_conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
</span><span id="DIBBsConnectorClient-64"><a href="#DIBBsConnectorClient-64"><span class="linenos"> 64</span></a>                <span class="n">database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-65"><a href="#DIBBsConnectorClient-65"><span class="linenos"> 65</span></a>                <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-66"><a href="#DIBBsConnectorClient-66"><span class="linenos"> 66</span></a>                <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-67"><a href="#DIBBsConnectorClient-67"><span class="linenos"> 67</span></a>                <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-68"><a href="#DIBBsConnectorClient-68"><span class="linenos"> 68</span></a>                <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-69"><a href="#DIBBsConnectorClient-69"><span class="linenos"> 69</span></a>            <span class="p">)</span>
</span><span id="DIBBsConnectorClient-70"><a href="#DIBBsConnectorClient-70"><span class="linenos"> 70</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
</span><span id="DIBBsConnectorClient-71"><a href="#DIBBsConnectorClient-71"><span class="linenos"> 71</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient-72"><a href="#DIBBsConnectorClient-72"><span class="linenos"> 72</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient-73"><a href="#DIBBsConnectorClient-73"><span class="linenos"> 73</span></a>            <span class="k">return</span> <span class="n">db_conn</span>
</span><span id="DIBBsConnectorClient-74"><a href="#DIBBsConnectorClient-74"><span class="linenos"> 74</span></a>
</span><span id="DIBBsConnectorClient-75"><a href="#DIBBsConnectorClient-75"><span class="linenos"> 75</span></a>    <span class="k">def</span> <span class="nf">block_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block_vals</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">list</span><span class="p">]:</span>
</span><span id="DIBBsConnectorClient-76"><a href="#DIBBsConnectorClient-76"><span class="linenos"> 76</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DIBBsConnectorClient-77"><a href="#DIBBsConnectorClient-77"><span class="linenos"> 77</span></a><span class="sd">        Returns a list of lists containing records from the database that match on the</span>
</span><span id="DIBBsConnectorClient-78"><a href="#DIBBsConnectorClient-78"><span class="linenos"> 78</span></a><span class="sd">        incoming record&#39;s block values. If blocking on &#39;ZIP&#39; and the incoming record&#39;s</span>
</span><span id="DIBBsConnectorClient-79"><a href="#DIBBsConnectorClient-79"><span class="linenos"> 79</span></a><span class="sd">        zip code is &#39;90210&#39;, the resulting block of data would contain records that all</span>
</span><span id="DIBBsConnectorClient-80"><a href="#DIBBsConnectorClient-80"><span class="linenos"> 80</span></a><span class="sd">        have the same zip code of 90210.</span>
</span><span id="DIBBsConnectorClient-81"><a href="#DIBBsConnectorClient-81"><span class="linenos"> 81</span></a>
</span><span id="DIBBsConnectorClient-82"><a href="#DIBBsConnectorClient-82"><span class="linenos"> 82</span></a><span class="sd">        :param block_vals: Dictionary containing key value pairs for the column name for</span>
</span><span id="DIBBsConnectorClient-83"><a href="#DIBBsConnectorClient-83"><span class="linenos"> 83</span></a><span class="sd">          blocking and the data for the incoming record as well as any transformations,</span>
</span><span id="DIBBsConnectorClient-84"><a href="#DIBBsConnectorClient-84"><span class="linenos"> 84</span></a><span class="sd">          e.g., {&quot;ZIP&quot;: {&quot;value&quot;: &quot;90210&quot;}} or</span>
</span><span id="DIBBsConnectorClient-85"><a href="#DIBBsConnectorClient-85"><span class="linenos"> 85</span></a><span class="sd">          {&quot;ZIP&quot;: {&quot;value&quot;: &quot;90210&quot;,}, &quot;transformation&quot;:&quot;first4&quot;}.</span>
</span><span id="DIBBsConnectorClient-86"><a href="#DIBBsConnectorClient-86"><span class="linenos"> 86</span></a><span class="sd">        :return: A list of records that are within the block, e.g., records that all</span>
</span><span id="DIBBsConnectorClient-87"><a href="#DIBBsConnectorClient-87"><span class="linenos"> 87</span></a><span class="sd">          have 90210 as their ZIP.</span>
</span><span id="DIBBsConnectorClient-88"><a href="#DIBBsConnectorClient-88"><span class="linenos"> 88</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DIBBsConnectorClient-89"><a href="#DIBBsConnectorClient-89"><span class="linenos"> 89</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">block_vals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient-90"><a href="#DIBBsConnectorClient-90"><span class="linenos"> 90</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`block_vals` cannot be empty.&quot;</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient-91"><a href="#DIBBsConnectorClient-91"><span class="linenos"> 91</span></a>
</span><span id="DIBBsConnectorClient-92"><a href="#DIBBsConnectorClient-92"><span class="linenos"> 92</span></a>        <span class="n">db_cursor</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DIBBsConnectorClient-93"><a href="#DIBBsConnectorClient-93"><span class="linenos"> 93</span></a>        <span class="n">db_conn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DIBBsConnectorClient-94"><a href="#DIBBsConnectorClient-94"><span class="linenos"> 94</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient-95"><a href="#DIBBsConnectorClient-95"><span class="linenos"> 95</span></a>            <span class="c1"># Use context manager to handle commits and transactions</span>
</span><span id="DIBBsConnectorClient-96"><a href="#DIBBsConnectorClient-96"><span class="linenos"> 96</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">db_conn</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient-97"><a href="#DIBBsConnectorClient-97"><span class="linenos"> 97</span></a>                <span class="k">with</span> <span class="n">db_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">db_cursor</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient-98"><a href="#DIBBsConnectorClient-98"><span class="linenos"> 98</span></a>                    <span class="c1"># Generate raw SQL query</span>
</span><span id="DIBBsConnectorClient-99"><a href="#DIBBsConnectorClient-99"><span class="linenos"> 99</span></a>
</span><span id="DIBBsConnectorClient-100"><a href="#DIBBsConnectorClient-100"><span class="linenos">100</span></a>                    <span class="n">query</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_block_query</span><span class="p">(</span><span class="n">block_vals</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient-101"><a href="#DIBBsConnectorClient-101"><span class="linenos">101</span></a>                    <span class="c1"># Execute query</span>
</span><span id="DIBBsConnectorClient-102"><a href="#DIBBsConnectorClient-102"><span class="linenos">102</span></a>                    <span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient-103"><a href="#DIBBsConnectorClient-103"><span class="linenos">103</span></a>                    <span class="n">blocked_data</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db_cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
</span><span id="DIBBsConnectorClient-104"><a href="#DIBBsConnectorClient-104"><span class="linenos">104</span></a>
</span><span id="DIBBsConnectorClient-105"><a href="#DIBBsConnectorClient-105"><span class="linenos">105</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
</span><span id="DIBBsConnectorClient-106"><a href="#DIBBsConnectorClient-106"><span class="linenos">106</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient-107"><a href="#DIBBsConnectorClient-107"><span class="linenos">107</span></a>
</span><span id="DIBBsConnectorClient-108"><a href="#DIBBsConnectorClient-108"><span class="linenos">108</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient-109"><a href="#DIBBsConnectorClient-109"><span class="linenos">109</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_close_connections</span><span class="p">(</span><span class="n">db_conn</span><span class="o">=</span><span class="n">db_conn</span><span class="p">,</span> <span class="n">db_cursor</span><span class="o">=</span><span class="n">db_cursor</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient-110"><a href="#DIBBsConnectorClient-110"><span class="linenos">110</span></a>
</span><span id="DIBBsConnectorClient-111"><a href="#DIBBsConnectorClient-111"><span class="linenos">111</span></a>        <span class="c1"># Set up blocked data by adding column headers as 1st row of LoL</span>
</span><span id="DIBBsConnectorClient-112"><a href="#DIBBsConnectorClient-112"><span class="linenos">112</span></a>        <span class="c1"># TODO: Replace indices with column names for reability</span>
</span><span id="DIBBsConnectorClient-113"><a href="#DIBBsConnectorClient-113"><span class="linenos">113</span></a>        <span class="n">blocked_data_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;patient_id&quot;</span><span class="p">,</span> <span class="s2">&quot;person_id&quot;</span><span class="p">]</span>
</span><span id="DIBBsConnectorClient-114"><a href="#DIBBsConnectorClient-114"><span class="linenos">114</span></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_to_jsonpaths</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
</span><span id="DIBBsConnectorClient-115"><a href="#DIBBsConnectorClient-115"><span class="linenos">115</span></a>            <span class="n">blocked_data_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient-116"><a href="#DIBBsConnectorClient-116"><span class="linenos">116</span></a>        <span class="n">blocked_data</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">blocked_data_cols</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient-117"><a href="#DIBBsConnectorClient-117"><span class="linenos">117</span></a>
</span><span id="DIBBsConnectorClient-118"><a href="#DIBBsConnectorClient-118"><span class="linenos">118</span></a>        <span class="k">return</span> <span class="n">blocked_data</span>
</span><span id="DIBBsConnectorClient-119"><a href="#DIBBsConnectorClient-119"><span class="linenos">119</span></a>
</span><span id="DIBBsConnectorClient-120"><a href="#DIBBsConnectorClient-120"><span class="linenos">120</span></a>    <span class="k">def</span> <span class="nf">insert_match_patient</span><span class="p">(</span>
</span><span id="DIBBsConnectorClient-121"><a href="#DIBBsConnectorClient-121"><span class="linenos">121</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-122"><a href="#DIBBsConnectorClient-122"><span class="linenos">122</span></a>        <span class="n">patient_resource</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-123"><a href="#DIBBsConnectorClient-123"><span class="linenos">123</span></a>        <span class="n">person_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-124"><a href="#DIBBsConnectorClient-124"><span class="linenos">124</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="DIBBsConnectorClient-125"><a href="#DIBBsConnectorClient-125"><span class="linenos">125</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DIBBsConnectorClient-126"><a href="#DIBBsConnectorClient-126"><span class="linenos">126</span></a><span class="sd">        If a matching person ID has been found in the MPI, inserts a new patient into</span>
</span><span id="DIBBsConnectorClient-127"><a href="#DIBBsConnectorClient-127"><span class="linenos">127</span></a><span class="sd">        the patient table and updates the person table to link to the new patient; else</span>
</span><span id="DIBBsConnectorClient-128"><a href="#DIBBsConnectorClient-128"><span class="linenos">128</span></a><span class="sd">        inserts a new patient into the patient table and inserts a new person into the</span>
</span><span id="DIBBsConnectorClient-129"><a href="#DIBBsConnectorClient-129"><span class="linenos">129</span></a><span class="sd">        person table with a new personID, linking the new personID to the new patient.</span>
</span><span id="DIBBsConnectorClient-130"><a href="#DIBBsConnectorClient-130"><span class="linenos">130</span></a>
</span><span id="DIBBsConnectorClient-131"><a href="#DIBBsConnectorClient-131"><span class="linenos">131</span></a><span class="sd">        :param patient_resource: A FHIR patient resource.</span>
</span><span id="DIBBsConnectorClient-132"><a href="#DIBBsConnectorClient-132"><span class="linenos">132</span></a><span class="sd">        :param person_id: The personID matching the patient record if a match has been</span>
</span><span id="DIBBsConnectorClient-133"><a href="#DIBBsConnectorClient-133"><span class="linenos">133</span></a><span class="sd">          found in the MPI, defaults to None.</span>
</span><span id="DIBBsConnectorClient-134"><a href="#DIBBsConnectorClient-134"><span class="linenos">134</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DIBBsConnectorClient-135"><a href="#DIBBsConnectorClient-135"><span class="linenos">135</span></a>        <span class="n">db_cursor</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DIBBsConnectorClient-136"><a href="#DIBBsConnectorClient-136"><span class="linenos">136</span></a>        <span class="n">db_conn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DIBBsConnectorClient-137"><a href="#DIBBsConnectorClient-137"><span class="linenos">137</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient-138"><a href="#DIBBsConnectorClient-138"><span class="linenos">138</span></a>            <span class="c1"># Use context manager to handle commits and transactions</span>
</span><span id="DIBBsConnectorClient-139"><a href="#DIBBsConnectorClient-139"><span class="linenos">139</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">db_conn</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient-140"><a href="#DIBBsConnectorClient-140"><span class="linenos">140</span></a>                <span class="k">with</span> <span class="n">db_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">db_cursor</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient-141"><a href="#DIBBsConnectorClient-141"><span class="linenos">141</span></a>                    <span class="c1"># Match has not been found</span>
</span><span id="DIBBsConnectorClient-142"><a href="#DIBBsConnectorClient-142"><span class="linenos">142</span></a>                    <span class="k">if</span> <span class="n">person_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient-143"><a href="#DIBBsConnectorClient-143"><span class="linenos">143</span></a>                        <span class="c1"># Insert a new record into person table to generate new</span>
</span><span id="DIBBsConnectorClient-144"><a href="#DIBBsConnectorClient-144"><span class="linenos">144</span></a>                        <span class="c1"># person_id</span>
</span><span id="DIBBsConnectorClient-145"><a href="#DIBBsConnectorClient-145"><span class="linenos">145</span></a>                        <span class="n">insert_new_person</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span>
</span><span id="DIBBsConnectorClient-146"><a href="#DIBBsConnectorClient-146"><span class="linenos">146</span></a>                            <span class="s2">&quot;INSERT INTO </span><span class="si">{person_table}</span><span class="s2"> (external_person_id) VALUES &quot;</span>
</span><span id="DIBBsConnectorClient-147"><a href="#DIBBsConnectorClient-147"><span class="linenos">147</span></a>                            <span class="s2">&quot;(&#39;NULL&#39;) RETURNING person_id;&quot;</span>
</span><span id="DIBBsConnectorClient-148"><a href="#DIBBsConnectorClient-148"><span class="linenos">148</span></a>                        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">person_table</span><span class="o">=</span><span class="n">Identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">person_table</span><span class="p">))</span>
</span><span id="DIBBsConnectorClient-149"><a href="#DIBBsConnectorClient-149"><span class="linenos">149</span></a>
</span><span id="DIBBsConnectorClient-150"><a href="#DIBBsConnectorClient-150"><span class="linenos">150</span></a>                        <span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert_new_person</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient-151"><a href="#DIBBsConnectorClient-151"><span class="linenos">151</span></a>
</span><span id="DIBBsConnectorClient-152"><a href="#DIBBsConnectorClient-152"><span class="linenos">152</span></a>                        <span class="c1"># Retrieve newly generated person_id</span>
</span><span id="DIBBsConnectorClient-153"><a href="#DIBBsConnectorClient-153"><span class="linenos">153</span></a>                        <span class="n">person_id</span> <span class="o">=</span> <span class="n">db_cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="DIBBsConnectorClient-154"><a href="#DIBBsConnectorClient-154"><span class="linenos">154</span></a>
</span><span id="DIBBsConnectorClient-155"><a href="#DIBBsConnectorClient-155"><span class="linenos">155</span></a>                    <span class="c1"># Insert into patient table</span>
</span><span id="DIBBsConnectorClient-156"><a href="#DIBBsConnectorClient-156"><span class="linenos">156</span></a>                    <span class="n">insert_new_patient</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span>
</span><span id="DIBBsConnectorClient-157"><a href="#DIBBsConnectorClient-157"><span class="linenos">157</span></a>                        <span class="s2">&quot;INSERT INTO </span><span class="si">{patient_table}</span><span class="s2"> &quot;</span>
</span><span id="DIBBsConnectorClient-158"><a href="#DIBBsConnectorClient-158"><span class="linenos">158</span></a>                        <span class="s2">&quot;(patient_id, person_id, patient_resource) VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">);&quot;</span>
</span><span id="DIBBsConnectorClient-159"><a href="#DIBBsConnectorClient-159"><span class="linenos">159</span></a>                    <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">patient_table</span><span class="o">=</span><span class="n">Identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_table</span><span class="p">))</span>
</span><span id="DIBBsConnectorClient-160"><a href="#DIBBsConnectorClient-160"><span class="linenos">160</span></a>                    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="DIBBsConnectorClient-161"><a href="#DIBBsConnectorClient-161"><span class="linenos">161</span></a>                        <span class="n">patient_resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span>
</span><span id="DIBBsConnectorClient-162"><a href="#DIBBsConnectorClient-162"><span class="linenos">162</span></a>                        <span class="n">person_id</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-163"><a href="#DIBBsConnectorClient-163"><span class="linenos">163</span></a>                        <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">patient_resource</span><span class="p">),</span>
</span><span id="DIBBsConnectorClient-164"><a href="#DIBBsConnectorClient-164"><span class="linenos">164</span></a>                    <span class="p">]</span>
</span><span id="DIBBsConnectorClient-165"><a href="#DIBBsConnectorClient-165"><span class="linenos">165</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient-166"><a href="#DIBBsConnectorClient-166"><span class="linenos">166</span></a>                        <span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert_new_patient</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient-167"><a href="#DIBBsConnectorClient-167"><span class="linenos">167</span></a>                    <span class="k">except</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">UniqueViolation</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient-168"><a href="#DIBBsConnectorClient-168"><span class="linenos">168</span></a>                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="DIBBsConnectorClient-169"><a href="#DIBBsConnectorClient-169"><span class="linenos">169</span></a>                            <span class="sa">f</span><span class="s2">&quot;Patient with ID </span><span class="si">{</span><span class="n">patient_resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> already &quot;</span>
</span><span id="DIBBsConnectorClient-170"><a href="#DIBBsConnectorClient-170"><span class="linenos">170</span></a>                            <span class="s2">&quot;exists in the MPI. The patient table was not updated.&quot;</span>
</span><span id="DIBBsConnectorClient-171"><a href="#DIBBsConnectorClient-171"><span class="linenos">171</span></a>                        <span class="p">)</span>
</span><span id="DIBBsConnectorClient-172"><a href="#DIBBsConnectorClient-172"><span class="linenos">172</span></a>
</span><span id="DIBBsConnectorClient-173"><a href="#DIBBsConnectorClient-173"><span class="linenos">173</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
</span><span id="DIBBsConnectorClient-174"><a href="#DIBBsConnectorClient-174"><span class="linenos">174</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient-175"><a href="#DIBBsConnectorClient-175"><span class="linenos">175</span></a>
</span><span id="DIBBsConnectorClient-176"><a href="#DIBBsConnectorClient-176"><span class="linenos">176</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient-177"><a href="#DIBBsConnectorClient-177"><span class="linenos">177</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_close_connections</span><span class="p">(</span><span class="n">db_conn</span><span class="o">=</span><span class="n">db_conn</span><span class="p">,</span> <span class="n">db_cursor</span><span class="o">=</span><span class="n">db_cursor</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient-178"><a href="#DIBBsConnectorClient-178"><span class="linenos">178</span></a>
</span><span id="DIBBsConnectorClient-179"><a href="#DIBBsConnectorClient-179"><span class="linenos">179</span></a>        <span class="k">return</span> <span class="n">person_id</span>
</span><span id="DIBBsConnectorClient-180"><a href="#DIBBsConnectorClient-180"><span class="linenos">180</span></a>
</span><span id="DIBBsConnectorClient-181"><a href="#DIBBsConnectorClient-181"><span class="linenos">181</span></a>    <span class="k">def</span> <span class="nf">_generate_block_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block_vals</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">SQL</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
</span><span id="DIBBsConnectorClient-182"><a href="#DIBBsConnectorClient-182"><span class="linenos">182</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DIBBsConnectorClient-183"><a href="#DIBBsConnectorClient-183"><span class="linenos">183</span></a><span class="sd">        Generates a query for selecting a block of data from the patient table per the</span>
</span><span id="DIBBsConnectorClient-184"><a href="#DIBBsConnectorClient-184"><span class="linenos">184</span></a><span class="sd">        block_vals parameters. Accepted blocking fields include: first_name, last_name,</span>
</span><span id="DIBBsConnectorClient-185"><a href="#DIBBsConnectorClient-185"><span class="linenos">185</span></a><span class="sd">        birthdate, addess, city, state, zip, mrn, and sex.</span>
</span><span id="DIBBsConnectorClient-186"><a href="#DIBBsConnectorClient-186"><span class="linenos">186</span></a>
</span><span id="DIBBsConnectorClient-187"><a href="#DIBBsConnectorClient-187"><span class="linenos">187</span></a><span class="sd">        :param table_name: Table name.</span>
</span><span id="DIBBsConnectorClient-188"><a href="#DIBBsConnectorClient-188"><span class="linenos">188</span></a><span class="sd">        :param block_vals: Dictionary containing key value pairs for the column name for</span>
</span><span id="DIBBsConnectorClient-189"><a href="#DIBBsConnectorClient-189"><span class="linenos">189</span></a><span class="sd">          blocking and the data for the incoming record as well as any transformations,</span>
</span><span id="DIBBsConnectorClient-190"><a href="#DIBBsConnectorClient-190"><span class="linenos">190</span></a><span class="sd">          e.g., {[&quot;ZIP&quot;]: {&quot;value&quot;: &quot;90210&quot;}} or</span>
</span><span id="DIBBsConnectorClient-191"><a href="#DIBBsConnectorClient-191"><span class="linenos">191</span></a><span class="sd">          {[&quot;ZIP&quot;]: {&quot;value&quot;: &quot;90210&quot;,}, &quot;transformation&quot;:&quot;first4&quot;}.</span>
</span><span id="DIBBsConnectorClient-192"><a href="#DIBBsConnectorClient-192"><span class="linenos">192</span></a><span class="sd">        :raises ValueError: If column key in `block_vals` is not supported.</span>
</span><span id="DIBBsConnectorClient-193"><a href="#DIBBsConnectorClient-193"><span class="linenos">193</span></a><span class="sd">        :return: A tuple containing a psycopg2.sql.SQL object representing the query as</span>
</span><span id="DIBBsConnectorClient-194"><a href="#DIBBsConnectorClient-194"><span class="linenos">194</span></a><span class="sd">            well as list of all data to be inserted into it.</span>
</span><span id="DIBBsConnectorClient-195"><a href="#DIBBsConnectorClient-195"><span class="linenos">195</span></a>
</span><span id="DIBBsConnectorClient-196"><a href="#DIBBsConnectorClient-196"><span class="linenos">196</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DIBBsConnectorClient-197"><a href="#DIBBsConnectorClient-197"><span class="linenos">197</span></a>        <span class="c1"># Check whether `block_vals` contains supported keys</span>
</span><span id="DIBBsConnectorClient-198"><a href="#DIBBsConnectorClient-198"><span class="linenos">198</span></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">block_vals</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient-199"><a href="#DIBBsConnectorClient-199"><span class="linenos">199</span></a>            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_to_jsonpaths</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient-200"><a href="#DIBBsConnectorClient-200"><span class="linenos">200</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="DIBBsConnectorClient-201"><a href="#DIBBsConnectorClient-201"><span class="linenos">201</span></a>                    <span class="sa">f</span><span class="s2">&quot;&quot;&quot;`</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">` not supported for blocking at this time. Supported</span>
</span><span id="DIBBsConnectorClient-202"><a href="#DIBBsConnectorClient-202"><span class="linenos">202</span></a><span class="s2">                    columns include first_name, last_name, birthdate, address, city,</span>
</span><span id="DIBBsConnectorClient-203"><a href="#DIBBsConnectorClient-203"><span class="linenos">203</span></a><span class="s2">                    state, zip, mrn, and sex.&quot;&quot;&quot;</span>
</span><span id="DIBBsConnectorClient-204"><a href="#DIBBsConnectorClient-204"><span class="linenos">204</span></a>                <span class="p">)</span>
</span><span id="DIBBsConnectorClient-205"><a href="#DIBBsConnectorClient-205"><span class="linenos">205</span></a>
</span><span id="DIBBsConnectorClient-206"><a href="#DIBBsConnectorClient-206"><span class="linenos">206</span></a>        <span class="c1"># Generate select query to extract fields_to_jsonpaths keys</span>
</span><span id="DIBBsConnectorClient-207"><a href="#DIBBsConnectorClient-207"><span class="linenos">207</span></a>        <span class="n">select_query_stubs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="DIBBsConnectorClient-208"><a href="#DIBBsConnectorClient-208"><span class="linenos">208</span></a>        <span class="n">select_query_stubs_data</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="DIBBsConnectorClient-209"><a href="#DIBBsConnectorClient-209"><span class="linenos">209</span></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_to_jsonpaths</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient-210"><a href="#DIBBsConnectorClient-210"><span class="linenos">210</span></a>            <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;jsonb_path_query_array(patient_resource,%s) as </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DIBBsConnectorClient-211"><a href="#DIBBsConnectorClient-211"><span class="linenos">211</span></a>            <span class="n">select_query_stubs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient-212"><a href="#DIBBsConnectorClient-212"><span class="linenos">212</span></a>            <span class="n">select_query_stubs_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_to_jsonpaths</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
</span><span id="DIBBsConnectorClient-213"><a href="#DIBBsConnectorClient-213"><span class="linenos">213</span></a>        <span class="n">select_query</span> <span class="o">=</span> <span class="s2">&quot;SELECT patient_id, person_id, &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="DIBBsConnectorClient-214"><a href="#DIBBsConnectorClient-214"><span class="linenos">214</span></a>            <span class="n">stub</span> <span class="k">for</span> <span class="n">stub</span> <span class="ow">in</span> <span class="n">select_query_stubs</span>
</span><span id="DIBBsConnectorClient-215"><a href="#DIBBsConnectorClient-215"><span class="linenos">215</span></a>        <span class="p">)</span>
</span><span id="DIBBsConnectorClient-216"><a href="#DIBBsConnectorClient-216"><span class="linenos">216</span></a>
</span><span id="DIBBsConnectorClient-217"><a href="#DIBBsConnectorClient-217"><span class="linenos">217</span></a>        <span class="c1"># Generate blocking query based on blocking criteria</span>
</span><span id="DIBBsConnectorClient-218"><a href="#DIBBsConnectorClient-218"><span class="linenos">218</span></a>        <span class="n">block_query_stubs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="DIBBsConnectorClient-219"><a href="#DIBBsConnectorClient-219"><span class="linenos">219</span></a>        <span class="n">block_query_stubs_data</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="DIBBsConnectorClient-220"><a href="#DIBBsConnectorClient-220"><span class="linenos">220</span></a>        <span class="k">for</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">block_vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="DIBBsConnectorClient-221"><a href="#DIBBsConnectorClient-221"><span class="linenos">221</span></a>            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="DIBBsConnectorClient-222"><a href="#DIBBsConnectorClient-222"><span class="linenos">222</span></a>                <span class="s2">&quot;CAST(jsonb_path_query_array(patient_resource, </span><span class="si">%s</span><span class="s2">) as VARCHAR)= &quot;</span>
</span><span id="DIBBsConnectorClient-223"><a href="#DIBBsConnectorClient-223"><span class="linenos">223</span></a>                <span class="s2">&quot;&#39;[true]&#39;&quot;</span>
</span><span id="DIBBsConnectorClient-224"><a href="#DIBBsConnectorClient-224"><span class="linenos">224</span></a>            <span class="p">)</span>
</span><span id="DIBBsConnectorClient-225"><a href="#DIBBsConnectorClient-225"><span class="linenos">225</span></a>            <span class="n">block_query_stubs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient-226"><a href="#DIBBsConnectorClient-226"><span class="linenos">226</span></a>            <span class="c1"># Add appropriate transformations</span>
</span><span id="DIBBsConnectorClient-227"><a href="#DIBBsConnectorClient-227"><span class="linenos">227</span></a>            <span class="k">if</span> <span class="s2">&quot;transformation&quot;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient-228"><a href="#DIBBsConnectorClient-228"><span class="linenos">228</span></a>                <span class="c1"># first4 transformations</span>
</span><span id="DIBBsConnectorClient-229"><a href="#DIBBsConnectorClient-229"><span class="linenos">229</span></a>                <span class="k">if</span> <span class="n">block_vals</span><span class="p">[</span><span class="n">col_name</span><span class="p">][</span><span class="s2">&quot;transformation&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;first4&quot;</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient-230"><a href="#DIBBsConnectorClient-230"><span class="linenos">230</span></a>                    <span class="n">block_query_stubs_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="DIBBsConnectorClient-231"><a href="#DIBBsConnectorClient-231"><span class="linenos">231</span></a>                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_to_jsonpaths</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="si">}</span><span class="s2"> starts with &quot;</span>
</span><span id="DIBBsConnectorClient-232"><a href="#DIBBsConnectorClient-232"><span class="linenos">232</span></a>                        <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">block_vals</span><span class="p">[</span><span class="n">col_name</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="DIBBsConnectorClient-233"><a href="#DIBBsConnectorClient-233"><span class="linenos">233</span></a>                    <span class="p">)</span>
</span><span id="DIBBsConnectorClient-234"><a href="#DIBBsConnectorClient-234"><span class="linenos">234</span></a>                <span class="c1"># last4 transformations</span>
</span><span id="DIBBsConnectorClient-235"><a href="#DIBBsConnectorClient-235"><span class="linenos">235</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient-236"><a href="#DIBBsConnectorClient-236"><span class="linenos">236</span></a>                    <span class="n">block_query_stubs_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="DIBBsConnectorClient-237"><a href="#DIBBsConnectorClient-237"><span class="linenos">237</span></a>                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_to_jsonpaths</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="si">}</span><span class="s2"> like_regex &quot;</span>
</span><span id="DIBBsConnectorClient-238"><a href="#DIBBsConnectorClient-238"><span class="linenos">238</span></a>                        <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">block_vals</span><span class="p">[</span><span class="n">col_name</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">$$&quot;&#39;</span>
</span><span id="DIBBsConnectorClient-239"><a href="#DIBBsConnectorClient-239"><span class="linenos">239</span></a>                    <span class="p">)</span>
</span><span id="DIBBsConnectorClient-240"><a href="#DIBBsConnectorClient-240"><span class="linenos">240</span></a>            <span class="c1"># Build query for columns without transformations</span>
</span><span id="DIBBsConnectorClient-241"><a href="#DIBBsConnectorClient-241"><span class="linenos">241</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient-242"><a href="#DIBBsConnectorClient-242"><span class="linenos">242</span></a>                <span class="n">block_query_stubs_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="DIBBsConnectorClient-243"><a href="#DIBBsConnectorClient-243"><span class="linenos">243</span></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_to_jsonpaths</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="si">}</span><span class="s2"> like_regex &quot;</span>
</span><span id="DIBBsConnectorClient-244"><a href="#DIBBsConnectorClient-244"><span class="linenos">244</span></a>                    <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">block_vals</span><span class="p">[</span><span class="n">col_name</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
</span><span id="DIBBsConnectorClient-245"><a href="#DIBBsConnectorClient-245"><span class="linenos">245</span></a>                <span class="p">)</span>
</span><span id="DIBBsConnectorClient-246"><a href="#DIBBsConnectorClient-246"><span class="linenos">246</span></a>
</span><span id="DIBBsConnectorClient-247"><a href="#DIBBsConnectorClient-247"><span class="linenos">247</span></a>        <span class="n">block_query</span> <span class="o">=</span> <span class="s2">&quot; WHERE &quot;</span> <span class="o">+</span> <span class="s2">&quot; AND &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stub</span> <span class="k">for</span> <span class="n">stub</span> <span class="ow">in</span> <span class="n">block_query_stubs</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient-248"><a href="#DIBBsConnectorClient-248"><span class="linenos">248</span></a>
</span><span id="DIBBsConnectorClient-249"><a href="#DIBBsConnectorClient-249"><span class="linenos">249</span></a>        <span class="n">query</span> <span class="o">=</span> <span class="n">select_query</span> <span class="o">+</span> <span class="s2">&quot; FROM </span><span class="si">{patient_table}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">block_query</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span>
</span><span id="DIBBsConnectorClient-250"><a href="#DIBBsConnectorClient-250"><span class="linenos">250</span></a>        <span class="n">query</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">patient_table</span><span class="o">=</span><span class="n">Identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_table</span><span class="p">))</span>
</span><span id="DIBBsConnectorClient-251"><a href="#DIBBsConnectorClient-251"><span class="linenos">251</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">select_query_stubs_data</span> <span class="o">+</span> <span class="n">block_query_stubs_data</span>
</span><span id="DIBBsConnectorClient-252"><a href="#DIBBsConnectorClient-252"><span class="linenos">252</span></a>
</span><span id="DIBBsConnectorClient-253"><a href="#DIBBsConnectorClient-253"><span class="linenos">253</span></a>        <span class="k">return</span> <span class="n">query</span><span class="p">,</span> <span class="n">data</span>
</span><span id="DIBBsConnectorClient-254"><a href="#DIBBsConnectorClient-254"><span class="linenos">254</span></a>
</span><span id="DIBBsConnectorClient-255"><a href="#DIBBsConnectorClient-255"><span class="linenos">255</span></a>    <span class="k">def</span> <span class="nf">_close_connections</span><span class="p">(</span>
</span><span id="DIBBsConnectorClient-256"><a href="#DIBBsConnectorClient-256"><span class="linenos">256</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-257"><a href="#DIBBsConnectorClient-257"><span class="linenos">257</span></a>        <span class="n">db_conn</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">connection</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-258"><a href="#DIBBsConnectorClient-258"><span class="linenos">258</span></a>        <span class="n">db_cursor</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">cursor</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient-259"><a href="#DIBBsConnectorClient-259"><span class="linenos">259</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient-260"><a href="#DIBBsConnectorClient-260"><span class="linenos">260</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DIBBsConnectorClient-261"><a href="#DIBBsConnectorClient-261"><span class="linenos">261</span></a><span class="sd">        Simple helper method to close passed connections. If a context manager&#39;s</span>
</span><span id="DIBBsConnectorClient-262"><a href="#DIBBsConnectorClient-262"><span class="linenos">262</span></a><span class="sd">        `with` block successfully executes, the connection will already be</span>
</span><span id="DIBBsConnectorClient-263"><a href="#DIBBsConnectorClient-263"><span class="linenos">263</span></a><span class="sd">        committed and closed, so the resource will already be released. However,</span>
</span><span id="DIBBsConnectorClient-264"><a href="#DIBBsConnectorClient-264"><span class="linenos">264</span></a><span class="sd">        if the `with` block terminates before safe execution, this function</span>
</span><span id="DIBBsConnectorClient-265"><a href="#DIBBsConnectorClient-265"><span class="linenos">265</span></a><span class="sd">        allows a `finally` clause to succinctly clean up all open connections.</span>
</span><span id="DIBBsConnectorClient-266"><a href="#DIBBsConnectorClient-266"><span class="linenos">266</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DIBBsConnectorClient-267"><a href="#DIBBsConnectorClient-267"><span class="linenos">267</span></a>        <span class="k">if</span> <span class="n">db_cursor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient-268"><a href="#DIBBsConnectorClient-268"><span class="linenos">268</span></a>            <span class="n">db_cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="DIBBsConnectorClient-269"><a href="#DIBBsConnectorClient-269"><span class="linenos">269</span></a>        <span class="k">if</span> <span class="n">db_conn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient-270"><a href="#DIBBsConnectorClient-270"><span class="linenos">270</span></a>            <span class="n">db_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Represents a Postgres-specific Master Patient Index (MPI) connector
client for the DIBBs implementation of the record linkage building
block. Callers should use the provided interface functions (e.g.,
block_vals) to interact with the underlying vendor-specific client
property.</p>

<p>When instantiating a DIBBSConnectorClient, the connection to the
database is automatically tested using the provided parameters.
A refused, timed-out, or otherwise error-ed connection will raise
an immediate exception.</p>
</div>


                            <div id="DIBBsConnectorClient.__init__" class="classattr">
                                        <input id="DIBBsConnectorClient.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">DIBBsConnectorClient</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">database</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">user</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">password</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">host</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">port</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">patient_table</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">person_table</span><span class="p">:</span> <span class="nb">str</span></span>)</span>

                <label class="view-source-button" for="DIBBsConnectorClient.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DIBBsConnectorClient.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DIBBsConnectorClient.__init__-25"><a href="#DIBBsConnectorClient.__init__-25"><span class="linenos">25</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="DIBBsConnectorClient.__init__-26"><a href="#DIBBsConnectorClient.__init__-26"><span class="linenos">26</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient.__init__-27"><a href="#DIBBsConnectorClient.__init__-27"><span class="linenos">27</span></a>        <span class="n">database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient.__init__-28"><a href="#DIBBsConnectorClient.__init__-28"><span class="linenos">28</span></a>        <span class="n">user</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient.__init__-29"><a href="#DIBBsConnectorClient.__init__-29"><span class="linenos">29</span></a>        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient.__init__-30"><a href="#DIBBsConnectorClient.__init__-30"><span class="linenos">30</span></a>        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient.__init__-31"><a href="#DIBBsConnectorClient.__init__-31"><span class="linenos">31</span></a>        <span class="n">port</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient.__init__-32"><a href="#DIBBsConnectorClient.__init__-32"><span class="linenos">32</span></a>        <span class="n">patient_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient.__init__-33"><a href="#DIBBsConnectorClient.__init__-33"><span class="linenos">33</span></a>        <span class="n">person_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient.__init__-34"><a href="#DIBBsConnectorClient.__init__-34"><span class="linenos">34</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient.__init__-35"><a href="#DIBBsConnectorClient.__init__-35"><span class="linenos">35</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
</span><span id="DIBBsConnectorClient.__init__-36"><a href="#DIBBsConnectorClient.__init__-36"><span class="linenos">36</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
</span><span id="DIBBsConnectorClient.__init__-37"><a href="#DIBBsConnectorClient.__init__-37"><span class="linenos">37</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
</span><span id="DIBBsConnectorClient.__init__-38"><a href="#DIBBsConnectorClient.__init__-38"><span class="linenos">38</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
</span><span id="DIBBsConnectorClient.__init__-39"><a href="#DIBBsConnectorClient.__init__-39"><span class="linenos">39</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
</span><span id="DIBBsConnectorClient.__init__-40"><a href="#DIBBsConnectorClient.__init__-40"><span class="linenos">40</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">patient_table</span> <span class="o">=</span> <span class="n">patient_table</span>
</span><span id="DIBBsConnectorClient.__init__-41"><a href="#DIBBsConnectorClient.__init__-41"><span class="linenos">41</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">person_table</span> <span class="o">=</span> <span class="n">person_table</span>
</span><span id="DIBBsConnectorClient.__init__-42"><a href="#DIBBsConnectorClient.__init__-42"><span class="linenos">42</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fields_to_jsonpaths</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="DIBBsConnectorClient.__init__-43"><a href="#DIBBsConnectorClient.__init__-43"><span class="linenos">43</span></a>            <span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;$.address[*].line&quot;&quot;&quot;</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient.__init__-44"><a href="#DIBBsConnectorClient.__init__-44"><span class="linenos">44</span></a>            <span class="s2">&quot;birthdate&quot;</span><span class="p">:</span> <span class="s2">&quot;$.birthDate&quot;</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient.__init__-45"><a href="#DIBBsConnectorClient.__init__-45"><span class="linenos">45</span></a>            <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;$.address[*].city&quot;&quot;&quot;</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient.__init__-46"><a href="#DIBBsConnectorClient.__init__-46"><span class="linenos">46</span></a>            <span class="s2">&quot;first_name&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;$.name[*].given&quot;&quot;&quot;</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient.__init__-47"><a href="#DIBBsConnectorClient.__init__-47"><span class="linenos">47</span></a>            <span class="s2">&quot;last_name&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;$.name[*].family&quot;&quot;&quot;</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient.__init__-48"><a href="#DIBBsConnectorClient.__init__-48"><span class="linenos">48</span></a>            <span class="s2">&quot;mrn&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;$.identifier ?(@.type.coding[0].code==&quot;MR&quot;).value&quot;&quot;&quot;</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient.__init__-49"><a href="#DIBBsConnectorClient.__init__-49"><span class="linenos">49</span></a>            <span class="s2">&quot;sex&quot;</span><span class="p">:</span> <span class="s2">&quot;$.gender&quot;</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient.__init__-50"><a href="#DIBBsConnectorClient.__init__-50"><span class="linenos">50</span></a>            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;$.address[*].state&quot;&quot;&quot;</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient.__init__-51"><a href="#DIBBsConnectorClient.__init__-51"><span class="linenos">51</span></a>            <span class="s2">&quot;zip&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;&quot;$.address[*].postalCode&quot;&quot;&quot;</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient.__init__-52"><a href="#DIBBsConnectorClient.__init__-52"><span class="linenos">52</span></a>        <span class="p">}</span>
</span><span id="DIBBsConnectorClient.__init__-53"><a href="#DIBBsConnectorClient.__init__-53"><span class="linenos">53</span></a>        <span class="n">db_conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span>
</span><span id="DIBBsConnectorClient.__init__-54"><a href="#DIBBsConnectorClient.__init__-54"><span class="linenos">54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_close_connections</span><span class="p">(</span><span class="n">db_conn</span><span class="o">=</span><span class="n">db_conn</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="DIBBsConnectorClient.get_connection" class="classattr">
                                        <input id="DIBBsConnectorClient.get_connection-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_connection</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Optional</span><span class="p">[</span><span class="n">psycopg2</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">connection</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="DIBBsConnectorClient.get_connection-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DIBBsConnectorClient.get_connection"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DIBBsConnectorClient.get_connection-56"><a href="#DIBBsConnectorClient.get_connection-56"><span class="linenos">56</span></a>    <span class="k">def</span> <span class="nf">get_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">connection</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
</span><span id="DIBBsConnectorClient.get_connection-57"><a href="#DIBBsConnectorClient.get_connection-57"><span class="linenos">57</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DIBBsConnectorClient.get_connection-58"><a href="#DIBBsConnectorClient.get_connection-58"><span class="linenos">58</span></a><span class="sd">        Simple method for initiating a connection to the database specified</span>
</span><span id="DIBBsConnectorClient.get_connection-59"><a href="#DIBBsConnectorClient.get_connection-59"><span class="linenos">59</span></a><span class="sd">        by the parameters given to the class&#39; instantiation.</span>
</span><span id="DIBBsConnectorClient.get_connection-60"><a href="#DIBBsConnectorClient.get_connection-60"><span class="linenos">60</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DIBBsConnectorClient.get_connection-61"><a href="#DIBBsConnectorClient.get_connection-61"><span class="linenos">61</span></a>        <span class="n">db_conn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DIBBsConnectorClient.get_connection-62"><a href="#DIBBsConnectorClient.get_connection-62"><span class="linenos">62</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient.get_connection-63"><a href="#DIBBsConnectorClient.get_connection-63"><span class="linenos">63</span></a>            <span class="n">db_conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
</span><span id="DIBBsConnectorClient.get_connection-64"><a href="#DIBBsConnectorClient.get_connection-64"><span class="linenos">64</span></a>                <span class="n">database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient.get_connection-65"><a href="#DIBBsConnectorClient.get_connection-65"><span class="linenos">65</span></a>                <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient.get_connection-66"><a href="#DIBBsConnectorClient.get_connection-66"><span class="linenos">66</span></a>                <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient.get_connection-67"><a href="#DIBBsConnectorClient.get_connection-67"><span class="linenos">67</span></a>                <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient.get_connection-68"><a href="#DIBBsConnectorClient.get_connection-68"><span class="linenos">68</span></a>                <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient.get_connection-69"><a href="#DIBBsConnectorClient.get_connection-69"><span class="linenos">69</span></a>            <span class="p">)</span>
</span><span id="DIBBsConnectorClient.get_connection-70"><a href="#DIBBsConnectorClient.get_connection-70"><span class="linenos">70</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
</span><span id="DIBBsConnectorClient.get_connection-71"><a href="#DIBBsConnectorClient.get_connection-71"><span class="linenos">71</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient.get_connection-72"><a href="#DIBBsConnectorClient.get_connection-72"><span class="linenos">72</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient.get_connection-73"><a href="#DIBBsConnectorClient.get_connection-73"><span class="linenos">73</span></a>            <span class="k">return</span> <span class="n">db_conn</span>
</span></pre></div>


            <div class="docstring"><p>Simple method for initiating a connection to the database specified
by the parameters given to the class' instantiation.</p>
</div>


                            </div>
                            <div id="DIBBsConnectorClient.block_data" class="classattr">
                                        <input id="DIBBsConnectorClient.block_data-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">block_data</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">block_vals</span><span class="p">:</span> <span class="n">Dict</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="DIBBsConnectorClient.block_data-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DIBBsConnectorClient.block_data"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DIBBsConnectorClient.block_data-75"><a href="#DIBBsConnectorClient.block_data-75"><span class="linenos"> 75</span></a>    <span class="k">def</span> <span class="nf">block_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block_vals</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">list</span><span class="p">]:</span>
</span><span id="DIBBsConnectorClient.block_data-76"><a href="#DIBBsConnectorClient.block_data-76"><span class="linenos"> 76</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DIBBsConnectorClient.block_data-77"><a href="#DIBBsConnectorClient.block_data-77"><span class="linenos"> 77</span></a><span class="sd">        Returns a list of lists containing records from the database that match on the</span>
</span><span id="DIBBsConnectorClient.block_data-78"><a href="#DIBBsConnectorClient.block_data-78"><span class="linenos"> 78</span></a><span class="sd">        incoming record&#39;s block values. If blocking on &#39;ZIP&#39; and the incoming record&#39;s</span>
</span><span id="DIBBsConnectorClient.block_data-79"><a href="#DIBBsConnectorClient.block_data-79"><span class="linenos"> 79</span></a><span class="sd">        zip code is &#39;90210&#39;, the resulting block of data would contain records that all</span>
</span><span id="DIBBsConnectorClient.block_data-80"><a href="#DIBBsConnectorClient.block_data-80"><span class="linenos"> 80</span></a><span class="sd">        have the same zip code of 90210.</span>
</span><span id="DIBBsConnectorClient.block_data-81"><a href="#DIBBsConnectorClient.block_data-81"><span class="linenos"> 81</span></a>
</span><span id="DIBBsConnectorClient.block_data-82"><a href="#DIBBsConnectorClient.block_data-82"><span class="linenos"> 82</span></a><span class="sd">        :param block_vals: Dictionary containing key value pairs for the column name for</span>
</span><span id="DIBBsConnectorClient.block_data-83"><a href="#DIBBsConnectorClient.block_data-83"><span class="linenos"> 83</span></a><span class="sd">          blocking and the data for the incoming record as well as any transformations,</span>
</span><span id="DIBBsConnectorClient.block_data-84"><a href="#DIBBsConnectorClient.block_data-84"><span class="linenos"> 84</span></a><span class="sd">          e.g., {&quot;ZIP&quot;: {&quot;value&quot;: &quot;90210&quot;}} or</span>
</span><span id="DIBBsConnectorClient.block_data-85"><a href="#DIBBsConnectorClient.block_data-85"><span class="linenos"> 85</span></a><span class="sd">          {&quot;ZIP&quot;: {&quot;value&quot;: &quot;90210&quot;,}, &quot;transformation&quot;:&quot;first4&quot;}.</span>
</span><span id="DIBBsConnectorClient.block_data-86"><a href="#DIBBsConnectorClient.block_data-86"><span class="linenos"> 86</span></a><span class="sd">        :return: A list of records that are within the block, e.g., records that all</span>
</span><span id="DIBBsConnectorClient.block_data-87"><a href="#DIBBsConnectorClient.block_data-87"><span class="linenos"> 87</span></a><span class="sd">          have 90210 as their ZIP.</span>
</span><span id="DIBBsConnectorClient.block_data-88"><a href="#DIBBsConnectorClient.block_data-88"><span class="linenos"> 88</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DIBBsConnectorClient.block_data-89"><a href="#DIBBsConnectorClient.block_data-89"><span class="linenos"> 89</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">block_vals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient.block_data-90"><a href="#DIBBsConnectorClient.block_data-90"><span class="linenos"> 90</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`block_vals` cannot be empty.&quot;</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient.block_data-91"><a href="#DIBBsConnectorClient.block_data-91"><span class="linenos"> 91</span></a>
</span><span id="DIBBsConnectorClient.block_data-92"><a href="#DIBBsConnectorClient.block_data-92"><span class="linenos"> 92</span></a>        <span class="n">db_cursor</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DIBBsConnectorClient.block_data-93"><a href="#DIBBsConnectorClient.block_data-93"><span class="linenos"> 93</span></a>        <span class="n">db_conn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DIBBsConnectorClient.block_data-94"><a href="#DIBBsConnectorClient.block_data-94"><span class="linenos"> 94</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient.block_data-95"><a href="#DIBBsConnectorClient.block_data-95"><span class="linenos"> 95</span></a>            <span class="c1"># Use context manager to handle commits and transactions</span>
</span><span id="DIBBsConnectorClient.block_data-96"><a href="#DIBBsConnectorClient.block_data-96"><span class="linenos"> 96</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">db_conn</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient.block_data-97"><a href="#DIBBsConnectorClient.block_data-97"><span class="linenos"> 97</span></a>                <span class="k">with</span> <span class="n">db_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">db_cursor</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient.block_data-98"><a href="#DIBBsConnectorClient.block_data-98"><span class="linenos"> 98</span></a>                    <span class="c1"># Generate raw SQL query</span>
</span><span id="DIBBsConnectorClient.block_data-99"><a href="#DIBBsConnectorClient.block_data-99"><span class="linenos"> 99</span></a>
</span><span id="DIBBsConnectorClient.block_data-100"><a href="#DIBBsConnectorClient.block_data-100"><span class="linenos">100</span></a>                    <span class="n">query</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_block_query</span><span class="p">(</span><span class="n">block_vals</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient.block_data-101"><a href="#DIBBsConnectorClient.block_data-101"><span class="linenos">101</span></a>                    <span class="c1"># Execute query</span>
</span><span id="DIBBsConnectorClient.block_data-102"><a href="#DIBBsConnectorClient.block_data-102"><span class="linenos">102</span></a>                    <span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient.block_data-103"><a href="#DIBBsConnectorClient.block_data-103"><span class="linenos">103</span></a>                    <span class="n">blocked_data</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db_cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
</span><span id="DIBBsConnectorClient.block_data-104"><a href="#DIBBsConnectorClient.block_data-104"><span class="linenos">104</span></a>
</span><span id="DIBBsConnectorClient.block_data-105"><a href="#DIBBsConnectorClient.block_data-105"><span class="linenos">105</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
</span><span id="DIBBsConnectorClient.block_data-106"><a href="#DIBBsConnectorClient.block_data-106"><span class="linenos">106</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient.block_data-107"><a href="#DIBBsConnectorClient.block_data-107"><span class="linenos">107</span></a>
</span><span id="DIBBsConnectorClient.block_data-108"><a href="#DIBBsConnectorClient.block_data-108"><span class="linenos">108</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient.block_data-109"><a href="#DIBBsConnectorClient.block_data-109"><span class="linenos">109</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_close_connections</span><span class="p">(</span><span class="n">db_conn</span><span class="o">=</span><span class="n">db_conn</span><span class="p">,</span> <span class="n">db_cursor</span><span class="o">=</span><span class="n">db_cursor</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient.block_data-110"><a href="#DIBBsConnectorClient.block_data-110"><span class="linenos">110</span></a>
</span><span id="DIBBsConnectorClient.block_data-111"><a href="#DIBBsConnectorClient.block_data-111"><span class="linenos">111</span></a>        <span class="c1"># Set up blocked data by adding column headers as 1st row of LoL</span>
</span><span id="DIBBsConnectorClient.block_data-112"><a href="#DIBBsConnectorClient.block_data-112"><span class="linenos">112</span></a>        <span class="c1"># TODO: Replace indices with column names for reability</span>
</span><span id="DIBBsConnectorClient.block_data-113"><a href="#DIBBsConnectorClient.block_data-113"><span class="linenos">113</span></a>        <span class="n">blocked_data_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;patient_id&quot;</span><span class="p">,</span> <span class="s2">&quot;person_id&quot;</span><span class="p">]</span>
</span><span id="DIBBsConnectorClient.block_data-114"><a href="#DIBBsConnectorClient.block_data-114"><span class="linenos">114</span></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_to_jsonpaths</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
</span><span id="DIBBsConnectorClient.block_data-115"><a href="#DIBBsConnectorClient.block_data-115"><span class="linenos">115</span></a>            <span class="n">blocked_data_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient.block_data-116"><a href="#DIBBsConnectorClient.block_data-116"><span class="linenos">116</span></a>        <span class="n">blocked_data</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">blocked_data_cols</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient.block_data-117"><a href="#DIBBsConnectorClient.block_data-117"><span class="linenos">117</span></a>
</span><span id="DIBBsConnectorClient.block_data-118"><a href="#DIBBsConnectorClient.block_data-118"><span class="linenos">118</span></a>        <span class="k">return</span> <span class="n">blocked_data</span>
</span></pre></div>


            <div class="docstring"><p>Returns a list of lists containing records from the database that match on the
incoming record's block values. If blocking on 'ZIP' and the incoming record's
zip code is '90210', the resulting block of data would contain records that all
have the same zip code of 90210.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>block_vals</strong>:  Dictionary containing key value pairs for the column name for
blocking and the data for the incoming record as well as any transformations,
e.g., {"ZIP": {"value": "90210"}} or
{"ZIP": {"value": "90210",}, "transformation":"first4"}.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>A list of records that are within the block, e.g., records that all
    have 90210 as their ZIP.</p>
</blockquote>
</div>


                            </div>
                            <div id="DIBBsConnectorClient.insert_match_patient" class="classattr">
                                        <input id="DIBBsConnectorClient.insert_match_patient-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">insert_match_patient</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">patient_resource</span><span class="p">:</span> <span class="n">Dict</span>, </span><span class="param"><span class="n">person_id</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="DIBBsConnectorClient.insert_match_patient-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DIBBsConnectorClient.insert_match_patient"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DIBBsConnectorClient.insert_match_patient-120"><a href="#DIBBsConnectorClient.insert_match_patient-120"><span class="linenos">120</span></a>    <span class="k">def</span> <span class="nf">insert_match_patient</span><span class="p">(</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-121"><a href="#DIBBsConnectorClient.insert_match_patient-121"><span class="linenos">121</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-122"><a href="#DIBBsConnectorClient.insert_match_patient-122"><span class="linenos">122</span></a>        <span class="n">patient_resource</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-123"><a href="#DIBBsConnectorClient.insert_match_patient-123"><span class="linenos">123</span></a>        <span class="n">person_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-124"><a href="#DIBBsConnectorClient.insert_match_patient-124"><span class="linenos">124</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-125"><a href="#DIBBsConnectorClient.insert_match_patient-125"><span class="linenos">125</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-126"><a href="#DIBBsConnectorClient.insert_match_patient-126"><span class="linenos">126</span></a><span class="sd">        If a matching person ID has been found in the MPI, inserts a new patient into</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-127"><a href="#DIBBsConnectorClient.insert_match_patient-127"><span class="linenos">127</span></a><span class="sd">        the patient table and updates the person table to link to the new patient; else</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-128"><a href="#DIBBsConnectorClient.insert_match_patient-128"><span class="linenos">128</span></a><span class="sd">        inserts a new patient into the patient table and inserts a new person into the</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-129"><a href="#DIBBsConnectorClient.insert_match_patient-129"><span class="linenos">129</span></a><span class="sd">        person table with a new personID, linking the new personID to the new patient.</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-130"><a href="#DIBBsConnectorClient.insert_match_patient-130"><span class="linenos">130</span></a>
</span><span id="DIBBsConnectorClient.insert_match_patient-131"><a href="#DIBBsConnectorClient.insert_match_patient-131"><span class="linenos">131</span></a><span class="sd">        :param patient_resource: A FHIR patient resource.</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-132"><a href="#DIBBsConnectorClient.insert_match_patient-132"><span class="linenos">132</span></a><span class="sd">        :param person_id: The personID matching the patient record if a match has been</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-133"><a href="#DIBBsConnectorClient.insert_match_patient-133"><span class="linenos">133</span></a><span class="sd">          found in the MPI, defaults to None.</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-134"><a href="#DIBBsConnectorClient.insert_match_patient-134"><span class="linenos">134</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-135"><a href="#DIBBsConnectorClient.insert_match_patient-135"><span class="linenos">135</span></a>        <span class="n">db_cursor</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-136"><a href="#DIBBsConnectorClient.insert_match_patient-136"><span class="linenos">136</span></a>        <span class="n">db_conn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-137"><a href="#DIBBsConnectorClient.insert_match_patient-137"><span class="linenos">137</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-138"><a href="#DIBBsConnectorClient.insert_match_patient-138"><span class="linenos">138</span></a>            <span class="c1"># Use context manager to handle commits and transactions</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-139"><a href="#DIBBsConnectorClient.insert_match_patient-139"><span class="linenos">139</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span> <span class="k">as</span> <span class="n">db_conn</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-140"><a href="#DIBBsConnectorClient.insert_match_patient-140"><span class="linenos">140</span></a>                <span class="k">with</span> <span class="n">db_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">db_cursor</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-141"><a href="#DIBBsConnectorClient.insert_match_patient-141"><span class="linenos">141</span></a>                    <span class="c1"># Match has not been found</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-142"><a href="#DIBBsConnectorClient.insert_match_patient-142"><span class="linenos">142</span></a>                    <span class="k">if</span> <span class="n">person_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-143"><a href="#DIBBsConnectorClient.insert_match_patient-143"><span class="linenos">143</span></a>                        <span class="c1"># Insert a new record into person table to generate new</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-144"><a href="#DIBBsConnectorClient.insert_match_patient-144"><span class="linenos">144</span></a>                        <span class="c1"># person_id</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-145"><a href="#DIBBsConnectorClient.insert_match_patient-145"><span class="linenos">145</span></a>                        <span class="n">insert_new_person</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-146"><a href="#DIBBsConnectorClient.insert_match_patient-146"><span class="linenos">146</span></a>                            <span class="s2">&quot;INSERT INTO </span><span class="si">{person_table}</span><span class="s2"> (external_person_id) VALUES &quot;</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-147"><a href="#DIBBsConnectorClient.insert_match_patient-147"><span class="linenos">147</span></a>                            <span class="s2">&quot;(&#39;NULL&#39;) RETURNING person_id;&quot;</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-148"><a href="#DIBBsConnectorClient.insert_match_patient-148"><span class="linenos">148</span></a>                        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">person_table</span><span class="o">=</span><span class="n">Identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">person_table</span><span class="p">))</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-149"><a href="#DIBBsConnectorClient.insert_match_patient-149"><span class="linenos">149</span></a>
</span><span id="DIBBsConnectorClient.insert_match_patient-150"><a href="#DIBBsConnectorClient.insert_match_patient-150"><span class="linenos">150</span></a>                        <span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert_new_person</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-151"><a href="#DIBBsConnectorClient.insert_match_patient-151"><span class="linenos">151</span></a>
</span><span id="DIBBsConnectorClient.insert_match_patient-152"><a href="#DIBBsConnectorClient.insert_match_patient-152"><span class="linenos">152</span></a>                        <span class="c1"># Retrieve newly generated person_id</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-153"><a href="#DIBBsConnectorClient.insert_match_patient-153"><span class="linenos">153</span></a>                        <span class="n">person_id</span> <span class="o">=</span> <span class="n">db_cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-154"><a href="#DIBBsConnectorClient.insert_match_patient-154"><span class="linenos">154</span></a>
</span><span id="DIBBsConnectorClient.insert_match_patient-155"><a href="#DIBBsConnectorClient.insert_match_patient-155"><span class="linenos">155</span></a>                    <span class="c1"># Insert into patient table</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-156"><a href="#DIBBsConnectorClient.insert_match_patient-156"><span class="linenos">156</span></a>                    <span class="n">insert_new_patient</span> <span class="o">=</span> <span class="n">SQL</span><span class="p">(</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-157"><a href="#DIBBsConnectorClient.insert_match_patient-157"><span class="linenos">157</span></a>                        <span class="s2">&quot;INSERT INTO </span><span class="si">{patient_table}</span><span class="s2"> &quot;</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-158"><a href="#DIBBsConnectorClient.insert_match_patient-158"><span class="linenos">158</span></a>                        <span class="s2">&quot;(patient_id, person_id, patient_resource) VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">);&quot;</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-159"><a href="#DIBBsConnectorClient.insert_match_patient-159"><span class="linenos">159</span></a>                    <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">patient_table</span><span class="o">=</span><span class="n">Identifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_table</span><span class="p">))</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-160"><a href="#DIBBsConnectorClient.insert_match_patient-160"><span class="linenos">160</span></a>                    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-161"><a href="#DIBBsConnectorClient.insert_match_patient-161"><span class="linenos">161</span></a>                        <span class="n">patient_resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-162"><a href="#DIBBsConnectorClient.insert_match_patient-162"><span class="linenos">162</span></a>                        <span class="n">person_id</span><span class="p">,</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-163"><a href="#DIBBsConnectorClient.insert_match_patient-163"><span class="linenos">163</span></a>                        <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">patient_resource</span><span class="p">),</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-164"><a href="#DIBBsConnectorClient.insert_match_patient-164"><span class="linenos">164</span></a>                    <span class="p">]</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-165"><a href="#DIBBsConnectorClient.insert_match_patient-165"><span class="linenos">165</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-166"><a href="#DIBBsConnectorClient.insert_match_patient-166"><span class="linenos">166</span></a>                        <span class="n">db_cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert_new_patient</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-167"><a href="#DIBBsConnectorClient.insert_match_patient-167"><span class="linenos">167</span></a>                    <span class="k">except</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">UniqueViolation</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-168"><a href="#DIBBsConnectorClient.insert_match_patient-168"><span class="linenos">168</span></a>                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-169"><a href="#DIBBsConnectorClient.insert_match_patient-169"><span class="linenos">169</span></a>                            <span class="sa">f</span><span class="s2">&quot;Patient with ID </span><span class="si">{</span><span class="n">patient_resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> already &quot;</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-170"><a href="#DIBBsConnectorClient.insert_match_patient-170"><span class="linenos">170</span></a>                            <span class="s2">&quot;exists in the MPI. The patient table was not updated.&quot;</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-171"><a href="#DIBBsConnectorClient.insert_match_patient-171"><span class="linenos">171</span></a>                        <span class="p">)</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-172"><a href="#DIBBsConnectorClient.insert_match_patient-172"><span class="linenos">172</span></a>
</span><span id="DIBBsConnectorClient.insert_match_patient-173"><a href="#DIBBsConnectorClient.insert_match_patient-173"><span class="linenos">173</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-174"><a href="#DIBBsConnectorClient.insert_match_patient-174"><span class="linenos">174</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-175"><a href="#DIBBsConnectorClient.insert_match_patient-175"><span class="linenos">175</span></a>
</span><span id="DIBBsConnectorClient.insert_match_patient-176"><a href="#DIBBsConnectorClient.insert_match_patient-176"><span class="linenos">176</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-177"><a href="#DIBBsConnectorClient.insert_match_patient-177"><span class="linenos">177</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_close_connections</span><span class="p">(</span><span class="n">db_conn</span><span class="o">=</span><span class="n">db_conn</span><span class="p">,</span> <span class="n">db_cursor</span><span class="o">=</span><span class="n">db_cursor</span><span class="p">)</span>
</span><span id="DIBBsConnectorClient.insert_match_patient-178"><a href="#DIBBsConnectorClient.insert_match_patient-178"><span class="linenos">178</span></a>
</span><span id="DIBBsConnectorClient.insert_match_patient-179"><a href="#DIBBsConnectorClient.insert_match_patient-179"><span class="linenos">179</span></a>        <span class="k">return</span> <span class="n">person_id</span>
</span></pre></div>


            <div class="docstring"><p>If a matching person ID has been found in the MPI, inserts a new patient into
the patient table and updates the person table to link to the new patient; else
inserts a new patient into the patient table and inserts a new person into the
person table with a new personID, linking the new personID to the new patient.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>patient_resource</strong>:  A FHIR patient resource.</li>
<li><strong>person_id</strong>:  The personID matching the patient record if a match has been
found in the MPI, defaults to None.</li>
</ul>
</div>


                            </div>
                </section>
                <section id="link_record_against_mpi">
                            <input id="link_record_against_mpi-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">link_record_against_mpi</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">record</span><span class="p">:</span> <span class="nb">dict</span>,</span><span class="param">	<span class="n">algo_config</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>,</span><span class="param">	<span class="n">db_client</span><span class="p">:</span> <span class="n"><a href="#BaseMPIConnectorClient">phdi.linkage.BaseMPIConnectorClient</a></span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="link_record_against_mpi-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#link_record_against_mpi"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="link_record_against_mpi-546"><a href="#link_record_against_mpi-546"><span class="linenos">546</span></a><span class="k">def</span> <span class="nf">link_record_against_mpi</span><span class="p">(</span>
</span><span id="link_record_against_mpi-547"><a href="#link_record_against_mpi-547"><span class="linenos">547</span></a>    <span class="n">record</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
</span><span id="link_record_against_mpi-548"><a href="#link_record_against_mpi-548"><span class="linenos">548</span></a>    <span class="n">algo_config</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
</span><span id="link_record_against_mpi-549"><a href="#link_record_against_mpi-549"><span class="linenos">549</span></a>    <span class="n">db_client</span><span class="p">:</span> <span class="n">BaseMPIConnectorClient</span><span class="p">,</span>
</span><span id="link_record_against_mpi-550"><a href="#link_record_against_mpi-550"><span class="linenos">550</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="link_record_against_mpi-551"><a href="#link_record_against_mpi-551"><span class="linenos">551</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="link_record_against_mpi-552"><a href="#link_record_against_mpi-552"><span class="linenos">552</span></a><span class="sd">    Runs record linkage on a single incoming record (extracted from a FHIR</span>
</span><span id="link_record_against_mpi-553"><a href="#link_record_against_mpi-553"><span class="linenos">553</span></a><span class="sd">    bundle) using an existing database as an MPI. Uses a flexible algorithm</span>
</span><span id="link_record_against_mpi-554"><a href="#link_record_against_mpi-554"><span class="linenos">554</span></a><span class="sd">    configuration to allow customization of the exact kind of linkage to</span>
</span><span id="link_record_against_mpi-555"><a href="#link_record_against_mpi-555"><span class="linenos">555</span></a><span class="sd">    run. Linkage is assumed to run using cluster membership (i.e. the new</span>
</span><span id="link_record_against_mpi-556"><a href="#link_record_against_mpi-556"><span class="linenos">556</span></a><span class="sd">    record must match a certain proportion of existing records all assigned</span>
</span><span id="link_record_against_mpi-557"><a href="#link_record_against_mpi-557"><span class="linenos">557</span></a><span class="sd">    to a person in order to match), and if multiple persons are matched,</span>
</span><span id="link_record_against_mpi-558"><a href="#link_record_against_mpi-558"><span class="linenos">558</span></a><span class="sd">    the new record is linked to the person with the strongest membership</span>
</span><span id="link_record_against_mpi-559"><a href="#link_record_against_mpi-559"><span class="linenos">559</span></a><span class="sd">    percentage.</span>
</span><span id="link_record_against_mpi-560"><a href="#link_record_against_mpi-560"><span class="linenos">560</span></a>
</span><span id="link_record_against_mpi-561"><a href="#link_record_against_mpi-561"><span class="linenos">561</span></a><span class="sd">    :param record: The FHIR-formatted patient resource to try to match to</span>
</span><span id="link_record_against_mpi-562"><a href="#link_record_against_mpi-562"><span class="linenos">562</span></a><span class="sd">      other records in the MPI.</span>
</span><span id="link_record_against_mpi-563"><a href="#link_record_against_mpi-563"><span class="linenos">563</span></a><span class="sd">    :param algo_config: An algorithm configuration consisting of a list</span>
</span><span id="link_record_against_mpi-564"><a href="#link_record_against_mpi-564"><span class="linenos">564</span></a><span class="sd">      of dictionaries describing the algorithm to run. See</span>
</span><span id="link_record_against_mpi-565"><a href="#link_record_against_mpi-565"><span class="linenos">565</span></a><span class="sd">      `read_linkage_config` and `write_linkage_config` for more details.</span>
</span><span id="link_record_against_mpi-566"><a href="#link_record_against_mpi-566"><span class="linenos">566</span></a><span class="sd">    :param db_client: An instantiated connection to an MPI database.</span>
</span><span id="link_record_against_mpi-567"><a href="#link_record_against_mpi-567"><span class="linenos">567</span></a><span class="sd">    :returns: A tuple consisting of a boolean indicating whether a match</span>
</span><span id="link_record_against_mpi-568"><a href="#link_record_against_mpi-568"><span class="linenos">568</span></a><span class="sd">      was found for the new record in the MPI, followed by the ID of the</span>
</span><span id="link_record_against_mpi-569"><a href="#link_record_against_mpi-569"><span class="linenos">569</span></a><span class="sd">      Person entity now associated with the incoming patient (either a</span>
</span><span id="link_record_against_mpi-570"><a href="#link_record_against_mpi-570"><span class="linenos">570</span></a><span class="sd">      new Person ID or the ID of an existing matched Person).</span>
</span><span id="link_record_against_mpi-571"><a href="#link_record_against_mpi-571"><span class="linenos">571</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="link_record_against_mpi-572"><a href="#link_record_against_mpi-572"><span class="linenos">572</span></a>    <span class="n">flattened_record</span> <span class="o">=</span> <span class="n">_flatten_patient_resource</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
</span><span id="link_record_against_mpi-573"><a href="#link_record_against_mpi-573"><span class="linenos">573</span></a>
</span><span id="link_record_against_mpi-574"><a href="#link_record_against_mpi-574"><span class="linenos">574</span></a>    <span class="c1"># Need to bind function names back to their symbolic invocations</span>
</span><span id="link_record_against_mpi-575"><a href="#link_record_against_mpi-575"><span class="linenos">575</span></a>    <span class="c1"># in context of the module--i.e. turn the string of a function</span>
</span><span id="link_record_against_mpi-576"><a href="#link_record_against_mpi-576"><span class="linenos">576</span></a>    <span class="c1"># name back into the callable defined in link.py</span>
</span><span id="link_record_against_mpi-577"><a href="#link_record_against_mpi-577"><span class="linenos">577</span></a>    <span class="n">algo_config</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">algo_config</span><span class="p">)</span>
</span><span id="link_record_against_mpi-578"><a href="#link_record_against_mpi-578"><span class="linenos">578</span></a>    <span class="n">algo_config</span> <span class="o">=</span> <span class="n">_bind_func_names_to_invocations</span><span class="p">(</span><span class="n">algo_config</span><span class="p">)</span>
</span><span id="link_record_against_mpi-579"><a href="#link_record_against_mpi-579"><span class="linenos">579</span></a>
</span><span id="link_record_against_mpi-580"><a href="#link_record_against_mpi-580"><span class="linenos">580</span></a>    <span class="c1"># Membership ratios need to persist across linkage passes so that we can</span>
</span><span id="link_record_against_mpi-581"><a href="#link_record_against_mpi-581"><span class="linenos">581</span></a>    <span class="c1"># find the highest scoring match across all trials</span>
</span><span id="link_record_against_mpi-582"><a href="#link_record_against_mpi-582"><span class="linenos">582</span></a>    <span class="n">linkage_scores</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="link_record_against_mpi-583"><a href="#link_record_against_mpi-583"><span class="linenos">583</span></a>    <span class="k">for</span> <span class="n">linkage_pass</span> <span class="ow">in</span> <span class="n">algo_config</span><span class="p">:</span>
</span><span id="link_record_against_mpi-584"><a href="#link_record_against_mpi-584"><span class="linenos">584</span></a>        <span class="n">blocking_fields</span> <span class="o">=</span> <span class="n">linkage_pass</span><span class="p">[</span><span class="s2">&quot;blocks&quot;</span><span class="p">]</span>
</span><span id="link_record_against_mpi-585"><a href="#link_record_against_mpi-585"><span class="linenos">585</span></a>
</span><span id="link_record_against_mpi-586"><a href="#link_record_against_mpi-586"><span class="linenos">586</span></a>        <span class="c1"># MPI will be able to find patients if *any* of their names or addresses</span>
</span><span id="link_record_against_mpi-587"><a href="#link_record_against_mpi-587"><span class="linenos">587</span></a>        <span class="c1"># contains extracted values, so minimally block on the first line</span>
</span><span id="link_record_against_mpi-588"><a href="#link_record_against_mpi-588"><span class="linenos">588</span></a>        <span class="c1"># if applicable</span>
</span><span id="link_record_against_mpi-589"><a href="#link_record_against_mpi-589"><span class="linenos">589</span></a>        <span class="n">field_blocks</span> <span class="o">=</span> <span class="n">extract_blocking_values_from_record</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">blocking_fields</span><span class="p">)</span>
</span><span id="link_record_against_mpi-590"><a href="#link_record_against_mpi-590"><span class="linenos">590</span></a>        <span class="n">data_block</span> <span class="o">=</span> <span class="n">db_client</span><span class="o">.</span><span class="n">block_data</span><span class="p">(</span><span class="n">field_blocks</span><span class="p">)</span>
</span><span id="link_record_against_mpi-591"><a href="#link_record_against_mpi-591"><span class="linenos">591</span></a>
</span><span id="link_record_against_mpi-592"><a href="#link_record_against_mpi-592"><span class="linenos">592</span></a>        <span class="c1"># First row of returned block is column headers</span>
</span><span id="link_record_against_mpi-593"><a href="#link_record_against_mpi-593"><span class="linenos">593</span></a>        <span class="c1"># Map idx to column name, not including patient/person IDs</span>
</span><span id="link_record_against_mpi-594"><a href="#link_record_against_mpi-594"><span class="linenos">594</span></a>        <span class="n">idx_to_col</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_block</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">:])}</span>
</span><span id="link_record_against_mpi-595"><a href="#link_record_against_mpi-595"><span class="linenos">595</span></a>        <span class="n">data_block</span> <span class="o">=</span> <span class="n">data_block</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="link_record_against_mpi-596"><a href="#link_record_against_mpi-596"><span class="linenos">596</span></a>
</span><span id="link_record_against_mpi-597"><a href="#link_record_against_mpi-597"><span class="linenos">597</span></a>        <span class="c1"># Blocked fields are returned as LoLoL, but only name / address</span>
</span><span id="link_record_against_mpi-598"><a href="#link_record_against_mpi-598"><span class="linenos">598</span></a>        <span class="c1"># need to preserve multiple elements, so flatten other fields</span>
</span><span id="link_record_against_mpi-599"><a href="#link_record_against_mpi-599"><span class="linenos">599</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_block</span><span class="p">)):</span>
</span><span id="link_record_against_mpi-600"><a href="#link_record_against_mpi-600"><span class="linenos">600</span></a>            <span class="n">blocked_record</span> <span class="o">=</span> <span class="n">data_block</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="link_record_against_mpi-601"><a href="#link_record_against_mpi-601"><span class="linenos">601</span></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">blocked_record</span><span class="p">)):</span>
</span><span id="link_record_against_mpi-602"><a href="#link_record_against_mpi-602"><span class="linenos">602</span></a>                <span class="c1"># patient_id, person_id not included in idx-&gt;col mapping</span>
</span><span id="link_record_against_mpi-603"><a href="#link_record_against_mpi-603"><span class="linenos">603</span></a>                <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="link_record_against_mpi-604"><a href="#link_record_against_mpi-604"><span class="linenos">604</span></a>                    <span class="k">continue</span>
</span><span id="link_record_against_mpi-605"><a href="#link_record_against_mpi-605"><span class="linenos">605</span></a>                <span class="k">if</span> <span class="n">idx_to_col</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;first_name&quot;</span> <span class="ow">and</span> <span class="n">idx_to_col</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;address&quot;</span><span class="p">:</span>
</span><span id="link_record_against_mpi-606"><a href="#link_record_against_mpi-606"><span class="linenos">606</span></a>                    <span class="k">while</span> <span class="nb">type</span><span class="p">(</span><span class="n">blocked_record</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
</span><span id="link_record_against_mpi-607"><a href="#link_record_against_mpi-607"><span class="linenos">607</span></a>                        <span class="c1"># Handle empty list edge case.</span>
</span><span id="link_record_against_mpi-608"><a href="#link_record_against_mpi-608"><span class="linenos">608</span></a>                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocked_record</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="link_record_against_mpi-609"><a href="#link_record_against_mpi-609"><span class="linenos">609</span></a>                            <span class="n">blocked_record</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="link_record_against_mpi-610"><a href="#link_record_against_mpi-610"><span class="linenos">610</span></a>                            <span class="k">break</span>
</span><span id="link_record_against_mpi-611"><a href="#link_record_against_mpi-611"><span class="linenos">611</span></a>                        <span class="n">blocked_record</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">blocked_record</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="link_record_against_mpi-612"><a href="#link_record_against_mpi-612"><span class="linenos">612</span></a>
</span><span id="link_record_against_mpi-613"><a href="#link_record_against_mpi-613"><span class="linenos">613</span></a>        <span class="n">clusters</span> <span class="o">=</span> <span class="n">_group_patient_block_by_person</span><span class="p">(</span><span class="n">data_block</span><span class="p">)</span>
</span><span id="link_record_against_mpi-614"><a href="#link_record_against_mpi-614"><span class="linenos">614</span></a>
</span><span id="link_record_against_mpi-615"><a href="#link_record_against_mpi-615"><span class="linenos">615</span></a>        <span class="c1"># Check if incoming record should belong to one of the person clusters</span>
</span><span id="link_record_against_mpi-616"><a href="#link_record_against_mpi-616"><span class="linenos">616</span></a>        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">linkage_pass</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kwargs&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="link_record_against_mpi-617"><a href="#link_record_against_mpi-617"><span class="linenos">617</span></a>        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
</span><span id="link_record_against_mpi-618"><a href="#link_record_against_mpi-618"><span class="linenos">618</span></a>            <span class="n">num_matched_in_cluster</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="link_record_against_mpi-619"><a href="#link_record_against_mpi-619"><span class="linenos">619</span></a>            <span class="k">for</span> <span class="n">linked_patient</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">[</span><span class="n">person</span><span class="p">]:</span>
</span><span id="link_record_against_mpi-620"><a href="#link_record_against_mpi-620"><span class="linenos">620</span></a>                <span class="n">is_match</span> <span class="o">=</span> <span class="n">_compare_records</span><span class="p">(</span>
</span><span id="link_record_against_mpi-621"><a href="#link_record_against_mpi-621"><span class="linenos">621</span></a>                    <span class="n">flattened_record</span><span class="p">,</span>
</span><span id="link_record_against_mpi-622"><a href="#link_record_against_mpi-622"><span class="linenos">622</span></a>                    <span class="n">linked_patient</span><span class="p">,</span>
</span><span id="link_record_against_mpi-623"><a href="#link_record_against_mpi-623"><span class="linenos">623</span></a>                    <span class="n">linkage_pass</span><span class="p">[</span><span class="s2">&quot;funcs&quot;</span><span class="p">],</span>
</span><span id="link_record_against_mpi-624"><a href="#link_record_against_mpi-624"><span class="linenos">624</span></a>                    <span class="n">idx_to_col</span><span class="p">,</span>
</span><span id="link_record_against_mpi-625"><a href="#link_record_against_mpi-625"><span class="linenos">625</span></a>                    <span class="n">linkage_pass</span><span class="p">[</span><span class="s2">&quot;matching_rule&quot;</span><span class="p">],</span>
</span><span id="link_record_against_mpi-626"><a href="#link_record_against_mpi-626"><span class="linenos">626</span></a>                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="link_record_against_mpi-627"><a href="#link_record_against_mpi-627"><span class="linenos">627</span></a>                <span class="p">)</span>
</span><span id="link_record_against_mpi-628"><a href="#link_record_against_mpi-628"><span class="linenos">628</span></a>                <span class="k">if</span> <span class="n">is_match</span><span class="p">:</span>
</span><span id="link_record_against_mpi-629"><a href="#link_record_against_mpi-629"><span class="linenos">629</span></a>                    <span class="n">num_matched_in_cluster</span> <span class="o">+=</span> <span class="mf">1.0</span>
</span><span id="link_record_against_mpi-630"><a href="#link_record_against_mpi-630"><span class="linenos">630</span></a>
</span><span id="link_record_against_mpi-631"><a href="#link_record_against_mpi-631"><span class="linenos">631</span></a>            <span class="c1"># Update membership score for this person cluster so that we can</span>
</span><span id="link_record_against_mpi-632"><a href="#link_record_against_mpi-632"><span class="linenos">632</span></a>            <span class="c1"># track best possible link across multiple passes</span>
</span><span id="link_record_against_mpi-633"><a href="#link_record_against_mpi-633"><span class="linenos">633</span></a>            <span class="n">belongingness_ratio</span> <span class="o">=</span> <span class="n">num_matched_in_cluster</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">[</span><span class="n">person</span><span class="p">])</span>
</span><span id="link_record_against_mpi-634"><a href="#link_record_against_mpi-634"><span class="linenos">634</span></a>            <span class="k">if</span> <span class="n">belongingness_ratio</span> <span class="o">&gt;=</span> <span class="n">linkage_pass</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cluster_ratio&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="link_record_against_mpi-635"><a href="#link_record_against_mpi-635"><span class="linenos">635</span></a>                <span class="k">if</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">linkage_scores</span><span class="p">:</span>
</span><span id="link_record_against_mpi-636"><a href="#link_record_against_mpi-636"><span class="linenos">636</span></a>                    <span class="n">linkage_scores</span><span class="p">[</span><span class="n">person</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
</span><span id="link_record_against_mpi-637"><a href="#link_record_against_mpi-637"><span class="linenos">637</span></a>                        <span class="p">[</span><span class="n">linkage_scores</span><span class="p">[</span><span class="n">person</span><span class="p">],</span> <span class="n">belongingness_ratio</span><span class="p">]</span>
</span><span id="link_record_against_mpi-638"><a href="#link_record_against_mpi-638"><span class="linenos">638</span></a>                    <span class="p">)</span>
</span><span id="link_record_against_mpi-639"><a href="#link_record_against_mpi-639"><span class="linenos">639</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="link_record_against_mpi-640"><a href="#link_record_against_mpi-640"><span class="linenos">640</span></a>                    <span class="n">linkage_scores</span><span class="p">[</span><span class="n">person</span><span class="p">]</span> <span class="o">=</span> <span class="n">belongingness_ratio</span>
</span><span id="link_record_against_mpi-641"><a href="#link_record_against_mpi-641"><span class="linenos">641</span></a>
</span><span id="link_record_against_mpi-642"><a href="#link_record_against_mpi-642"><span class="linenos">642</span></a>    <span class="c1"># Didn&#39;t match any person in our database</span>
</span><span id="link_record_against_mpi-643"><a href="#link_record_against_mpi-643"><span class="linenos">643</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">linkage_scores</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="link_record_against_mpi-644"><a href="#link_record_against_mpi-644"><span class="linenos">644</span></a>        <span class="n">new_person_id</span> <span class="o">=</span> <span class="n">db_client</span><span class="o">.</span><span class="n">insert_match_patient</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="link_record_against_mpi-645"><a href="#link_record_against_mpi-645"><span class="linenos">645</span></a>        <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">new_person_id</span><span class="p">)</span>
</span><span id="link_record_against_mpi-646"><a href="#link_record_against_mpi-646"><span class="linenos">646</span></a>
</span><span id="link_record_against_mpi-647"><a href="#link_record_against_mpi-647"><span class="linenos">647</span></a>    <span class="c1"># Determine strongest match, upsert, then let the caller know</span>
</span><span id="link_record_against_mpi-648"><a href="#link_record_against_mpi-648"><span class="linenos">648</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="link_record_against_mpi-649"><a href="#link_record_against_mpi-649"><span class="linenos">649</span></a>        <span class="n">best_person</span> <span class="o">=</span> <span class="n">_find_strongest_link</span><span class="p">(</span><span class="n">linkage_scores</span><span class="p">)</span>
</span><span id="link_record_against_mpi-650"><a href="#link_record_against_mpi-650"><span class="linenos">650</span></a>        <span class="n">db_client</span><span class="o">.</span><span class="n">insert_match_patient</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">person_id</span><span class="o">=</span><span class="n">best_person</span><span class="p">)</span>
</span><span id="link_record_against_mpi-651"><a href="#link_record_against_mpi-651"><span class="linenos">651</span></a>        <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">best_person</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Runs record linkage on a single incoming record (extracted from a FHIR
bundle) using an existing database as an MPI. Uses a flexible algorithm
configuration to allow customization of the exact kind of linkage to
run. Linkage is assumed to run using cluster membership (i.e. the new
record must match a certain proportion of existing records all assigned
to a person in order to match), and if multiple persons are matched,
the new record is linked to the person with the strongest membership
percentage.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>record</strong>:  The FHIR-formatted patient resource to try to match to
other records in the MPI.</li>
<li><strong>algo_config</strong>:  An algorithm configuration consisting of a list
of dictionaries describing the algorithm to run. See
<code><a href="#read_linkage_config">read_linkage_config</a></code> and <code><a href="#write_linkage_config">write_linkage_config</a></code> for more details.</li>
<li><strong>db_client</strong>:  An instantiated connection to an MPI database.
:returns: A tuple consisting of a boolean indicating whether a match
was found for the new record in the MPI, followed by the ID of the
Person entity now associated with the incoming patient (either a
new Person ID or the ID of an existing matched Person).</li>
</ul>
</div>


                </section>
                <section id="add_person_resource">
                            <input id="add_person_resource-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_person_resource</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">person_id</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">bundle</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">FieldInfo</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">PydanticUndefined</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;A FHIR bundle&#39;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{})</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="add_person_resource-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#add_person_resource"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="add_person_resource-1400"><a href="#add_person_resource-1400"><span class="linenos">1400</span></a><span class="k">def</span> <span class="nf">add_person_resource</span><span class="p">(</span>
</span><span id="add_person_resource-1401"><a href="#add_person_resource-1401"><span class="linenos">1401</span></a>    <span class="n">person_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">patient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">bundle</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;A FHIR bundle&quot;</span><span class="p">)</span>
</span><span id="add_person_resource-1402"><a href="#add_person_resource-1402"><span class="linenos">1402</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="add_person_resource-1403"><a href="#add_person_resource-1403"><span class="linenos">1403</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="add_person_resource-1404"><a href="#add_person_resource-1404"><span class="linenos">1404</span></a><span class="sd">    Adds a simplified person resource to a bundle if the patient resource in the bundle</span>
</span><span id="add_person_resource-1405"><a href="#add_person_resource-1405"><span class="linenos">1405</span></a><span class="sd">    matches an existing record in the Master Patient Index. Returns the bundle with</span>
</span><span id="add_person_resource-1406"><a href="#add_person_resource-1406"><span class="linenos">1406</span></a><span class="sd">    the newly added person resource.</span>
</span><span id="add_person_resource-1407"><a href="#add_person_resource-1407"><span class="linenos">1407</span></a>
</span><span id="add_person_resource-1408"><a href="#add_person_resource-1408"><span class="linenos">1408</span></a><span class="sd">    :param person_id: _description_</span>
</span><span id="add_person_resource-1409"><a href="#add_person_resource-1409"><span class="linenos">1409</span></a><span class="sd">    :param patient_id: _description_</span>
</span><span id="add_person_resource-1410"><a href="#add_person_resource-1410"><span class="linenos">1410</span></a><span class="sd">    :param bundle: _description_, defaults to Field(description=&quot;A FHIR bundle&quot;)</span>
</span><span id="add_person_resource-1411"><a href="#add_person_resource-1411"><span class="linenos">1411</span></a><span class="sd">    :return: _description_</span>
</span><span id="add_person_resource-1412"><a href="#add_person_resource-1412"><span class="linenos">1412</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="add_person_resource-1413"><a href="#add_person_resource-1413"><span class="linenos">1413</span></a>    <span class="n">person_resource</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="add_person_resource-1414"><a href="#add_person_resource-1414"><span class="linenos">1414</span></a>        <span class="s2">&quot;fullUrl&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;urn:uuid:</span><span class="si">{</span><span class="n">person_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="add_person_resource-1415"><a href="#add_person_resource-1415"><span class="linenos">1415</span></a>        <span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="add_person_resource-1416"><a href="#add_person_resource-1416"><span class="linenos">1416</span></a>            <span class="s2">&quot;resourceType&quot;</span><span class="p">:</span> <span class="s2">&quot;Person&quot;</span><span class="p">,</span>
</span><span id="add_person_resource-1417"><a href="#add_person_resource-1417"><span class="linenos">1417</span></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">person_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="add_person_resource-1418"><a href="#add_person_resource-1418"><span class="linenos">1418</span></a>            <span class="s2">&quot;link&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;reference&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Patient/</span><span class="si">{</span><span class="n">patient_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}}],</span>
</span><span id="add_person_resource-1419"><a href="#add_person_resource-1419"><span class="linenos">1419</span></a>        <span class="p">},</span>
</span><span id="add_person_resource-1420"><a href="#add_person_resource-1420"><span class="linenos">1420</span></a>        <span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="add_person_resource-1421"><a href="#add_person_resource-1421"><span class="linenos">1421</span></a>            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;PUT&quot;</span><span class="p">,</span>
</span><span id="add_person_resource-1422"><a href="#add_person_resource-1422"><span class="linenos">1422</span></a>            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Person/</span><span class="si">{</span><span class="n">person_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="add_person_resource-1423"><a href="#add_person_resource-1423"><span class="linenos">1423</span></a>        <span class="p">},</span>
</span><span id="add_person_resource-1424"><a href="#add_person_resource-1424"><span class="linenos">1424</span></a>    <span class="p">}</span>
</span><span id="add_person_resource-1425"><a href="#add_person_resource-1425"><span class="linenos">1425</span></a>
</span><span id="add_person_resource-1426"><a href="#add_person_resource-1426"><span class="linenos">1426</span></a>    <span class="n">bundle</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entry&quot;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">person_resource</span><span class="p">)</span>
</span><span id="add_person_resource-1427"><a href="#add_person_resource-1427"><span class="linenos">1427</span></a>
</span><span id="add_person_resource-1428"><a href="#add_person_resource-1428"><span class="linenos">1428</span></a>    <span class="k">return</span> <span class="n">bundle</span>
</span></pre></div>


            <div class="docstring"><p>Adds a simplified person resource to a bundle if the patient resource in the bundle
matches an existing record in the Master Patient Index. Returns the bundle with
the newly added person resource.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>person_id</strong>:  _description_</li>
<li><strong>patient_id</strong>:  _description_</li>
<li><strong>bundle</strong>:  _description_, defaults to Field(description="A FHIR bundle")</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>_description_</p>
</blockquote>
</div>


                </section>
                <section id="_compare_address_elements">
                    <div class="attr variable">
            <span class="name">_compare_address_elements</span>

        
    </div>
    <a class="headerlink" href="#_compare_address_elements"></a>
    
    

                </section>
                <section id="_compare_name_elements">
                    <div class="attr variable">
            <span class="name">_compare_name_elements</span>

        
    </div>
    <a class="headerlink" href="#_compare_name_elements"></a>
    
    

                </section>
                <section id="convert_to_patient_fhir_resources">
                            <input id="convert_to_patient_fhir_resources-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">convert_to_patient_fhir_resources</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">data</span><span class="p">:</span> <span class="n">Dict</span></span><span class="return-annotation">) -> <span class="n">Tuple</span>:</span></span>

                <label class="view-source-button" for="convert_to_patient_fhir_resources-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#convert_to_patient_fhir_resources"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="convert_to_patient_fhir_resources-7"><a href="#convert_to_patient_fhir_resources-7"><span class="linenos"> 7</span></a><span class="k">def</span> <span class="nf">convert_to_patient_fhir_resources</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">:</span>
</span><span id="convert_to_patient_fhir_resources-8"><a href="#convert_to_patient_fhir_resources-8"><span class="linenos"> 8</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="convert_to_patient_fhir_resources-9"><a href="#convert_to_patient_fhir_resources-9"><span class="linenos"> 9</span></a><span class="sd">    Converts and returns a row of patient data into patient resource in a FHIR bundle</span>
</span><span id="convert_to_patient_fhir_resources-10"><a href="#convert_to_patient_fhir_resources-10"><span class="linenos">10</span></a><span class="sd">    with a newly generated id as well as the `iris_id`.</span>
</span><span id="convert_to_patient_fhir_resources-11"><a href="#convert_to_patient_fhir_resources-11"><span class="linenos">11</span></a>
</span><span id="convert_to_patient_fhir_resources-12"><a href="#convert_to_patient_fhir_resources-12"><span class="linenos">12</span></a><span class="sd">    :param data: Dictionary of patient data that optionionally includes the following</span>
</span><span id="convert_to_patient_fhir_resources-13"><a href="#convert_to_patient_fhir_resources-13"><span class="linenos">13</span></a><span class="sd">      fields: mrn, ssn, first_name, middle_name, last_name, home_phone, cell-phone, sex,</span>
</span><span id="convert_to_patient_fhir_resources-14"><a href="#convert_to_patient_fhir_resources-14"><span class="linenos">14</span></a><span class="sd">      birthdate, address, city, state, zip.</span>
</span><span id="convert_to_patient_fhir_resources-15"><a href="#convert_to_patient_fhir_resources-15"><span class="linenos">15</span></a><span class="sd">    :return: Tuple of the `iris_id` and FHIR bundle.</span>
</span><span id="convert_to_patient_fhir_resources-16"><a href="#convert_to_patient_fhir_resources-16"><span class="linenos">16</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="convert_to_patient_fhir_resources-17"><a href="#convert_to_patient_fhir_resources-17"><span class="linenos">17</span></a>
</span><span id="convert_to_patient_fhir_resources-18"><a href="#convert_to_patient_fhir_resources-18"><span class="linenos">18</span></a>    <span class="c1"># Iterate through each patient and convert patient data to FHIR resource</span>
</span><span id="convert_to_patient_fhir_resources-19"><a href="#convert_to_patient_fhir_resources-19"><span class="linenos">19</span></a>    <span class="n">patient_resource</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="convert_to_patient_fhir_resources-20"><a href="#convert_to_patient_fhir_resources-20"><span class="linenos">20</span></a>        <span class="s2">&quot;resourceType&quot;</span><span class="p">:</span> <span class="s2">&quot;Patient&quot;</span><span class="p">,</span>
</span><span id="convert_to_patient_fhir_resources-21"><a href="#convert_to_patient_fhir_resources-21"><span class="linenos">21</span></a>        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
</span><span id="convert_to_patient_fhir_resources-22"><a href="#convert_to_patient_fhir_resources-22"><span class="linenos">22</span></a>        <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="convert_to_patient_fhir_resources-23"><a href="#convert_to_patient_fhir_resources-23"><span class="linenos">23</span></a>            <span class="p">{</span>
</span><span id="convert_to_patient_fhir_resources-24"><a href="#convert_to_patient_fhir_resources-24"><span class="linenos">24</span></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="convert_to_patient_fhir_resources-25"><a href="#convert_to_patient_fhir_resources-25"><span class="linenos">25</span></a>                    <span class="s2">&quot;coding&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="convert_to_patient_fhir_resources-26"><a href="#convert_to_patient_fhir_resources-26"><span class="linenos">26</span></a>                        <span class="p">{</span>
</span><span id="convert_to_patient_fhir_resources-27"><a href="#convert_to_patient_fhir_resources-27"><span class="linenos">27</span></a>                            <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="s2">&quot;http://terminology.hl7.org/CodeSystem/v2-0203&quot;</span><span class="p">,</span>
</span><span id="convert_to_patient_fhir_resources-28"><a href="#convert_to_patient_fhir_resources-28"><span class="linenos">28</span></a>                            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;MR&quot;</span><span class="p">,</span>
</span><span id="convert_to_patient_fhir_resources-29"><a href="#convert_to_patient_fhir_resources-29"><span class="linenos">29</span></a>                        <span class="p">}</span>
</span><span id="convert_to_patient_fhir_resources-30"><a href="#convert_to_patient_fhir_resources-30"><span class="linenos">30</span></a>                    <span class="p">]</span>
</span><span id="convert_to_patient_fhir_resources-31"><a href="#convert_to_patient_fhir_resources-31"><span class="linenos">31</span></a>                <span class="p">},</span>
</span><span id="convert_to_patient_fhir_resources-32"><a href="#convert_to_patient_fhir_resources-32"><span class="linenos">32</span></a>                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mrn&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="convert_to_patient_fhir_resources-33"><a href="#convert_to_patient_fhir_resources-33"><span class="linenos">33</span></a>            <span class="p">},</span>
</span><span id="convert_to_patient_fhir_resources-34"><a href="#convert_to_patient_fhir_resources-34"><span class="linenos">34</span></a>            <span class="p">{</span>
</span><span id="convert_to_patient_fhir_resources-35"><a href="#convert_to_patient_fhir_resources-35"><span class="linenos">35</span></a>                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="convert_to_patient_fhir_resources-36"><a href="#convert_to_patient_fhir_resources-36"><span class="linenos">36</span></a>                    <span class="s2">&quot;coding&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="convert_to_patient_fhir_resources-37"><a href="#convert_to_patient_fhir_resources-37"><span class="linenos">37</span></a>                        <span class="p">{</span>
</span><span id="convert_to_patient_fhir_resources-38"><a href="#convert_to_patient_fhir_resources-38"><span class="linenos">38</span></a>                            <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="s2">&quot;http://terminology.hl7.org/CodeSystem/v2-0203&quot;</span><span class="p">,</span>
</span><span id="convert_to_patient_fhir_resources-39"><a href="#convert_to_patient_fhir_resources-39"><span class="linenos">39</span></a>                            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;SS&quot;</span><span class="p">,</span>
</span><span id="convert_to_patient_fhir_resources-40"><a href="#convert_to_patient_fhir_resources-40"><span class="linenos">40</span></a>                        <span class="p">}</span>
</span><span id="convert_to_patient_fhir_resources-41"><a href="#convert_to_patient_fhir_resources-41"><span class="linenos">41</span></a>                    <span class="p">]</span>
</span><span id="convert_to_patient_fhir_resources-42"><a href="#convert_to_patient_fhir_resources-42"><span class="linenos">42</span></a>                <span class="p">},</span>
</span><span id="convert_to_patient_fhir_resources-43"><a href="#convert_to_patient_fhir_resources-43"><span class="linenos">43</span></a>                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ssn&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="convert_to_patient_fhir_resources-44"><a href="#convert_to_patient_fhir_resources-44"><span class="linenos">44</span></a>            <span class="p">},</span>
</span><span id="convert_to_patient_fhir_resources-45"><a href="#convert_to_patient_fhir_resources-45"><span class="linenos">45</span></a>        <span class="p">],</span>
</span><span id="convert_to_patient_fhir_resources-46"><a href="#convert_to_patient_fhir_resources-46"><span class="linenos">46</span></a>        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="convert_to_patient_fhir_resources-47"><a href="#convert_to_patient_fhir_resources-47"><span class="linenos">47</span></a>            <span class="s2">&quot;family&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_name&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="convert_to_patient_fhir_resources-48"><a href="#convert_to_patient_fhir_resources-48"><span class="linenos">48</span></a>            <span class="s2">&quot;given&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;first_name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span><span id="convert_to_patient_fhir_resources-49"><a href="#convert_to_patient_fhir_resources-49"><span class="linenos">49</span></a>            <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;middle_name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span>
</span><span id="convert_to_patient_fhir_resources-50"><a href="#convert_to_patient_fhir_resources-50"><span class="linenos">50</span></a>        <span class="p">},</span>
</span><span id="convert_to_patient_fhir_resources-51"><a href="#convert_to_patient_fhir_resources-51"><span class="linenos">51</span></a>        <span class="s2">&quot;telecom&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="convert_to_patient_fhir_resources-52"><a href="#convert_to_patient_fhir_resources-52"><span class="linenos">52</span></a>            <span class="p">{</span>
</span><span id="convert_to_patient_fhir_resources-53"><a href="#convert_to_patient_fhir_resources-53"><span class="linenos">53</span></a>                <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="s2">&quot;phone&quot;</span><span class="p">,</span>
</span><span id="convert_to_patient_fhir_resources-54"><a href="#convert_to_patient_fhir_resources-54"><span class="linenos">54</span></a>                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;home_phone&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="convert_to_patient_fhir_resources-55"><a href="#convert_to_patient_fhir_resources-55"><span class="linenos">55</span></a>                <span class="s2">&quot;use&quot;</span><span class="p">:</span> <span class="s2">&quot;home&quot;</span><span class="p">,</span>
</span><span id="convert_to_patient_fhir_resources-56"><a href="#convert_to_patient_fhir_resources-56"><span class="linenos">56</span></a>            <span class="p">},</span>
</span><span id="convert_to_patient_fhir_resources-57"><a href="#convert_to_patient_fhir_resources-57"><span class="linenos">57</span></a>            <span class="p">{</span>
</span><span id="convert_to_patient_fhir_resources-58"><a href="#convert_to_patient_fhir_resources-58"><span class="linenos">58</span></a>                <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="s2">&quot;phone&quot;</span><span class="p">,</span>
</span><span id="convert_to_patient_fhir_resources-59"><a href="#convert_to_patient_fhir_resources-59"><span class="linenos">59</span></a>                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cell_phone&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="convert_to_patient_fhir_resources-60"><a href="#convert_to_patient_fhir_resources-60"><span class="linenos">60</span></a>                <span class="s2">&quot;use&quot;</span><span class="p">:</span> <span class="s2">&quot;mobile&quot;</span><span class="p">,</span>
</span><span id="convert_to_patient_fhir_resources-61"><a href="#convert_to_patient_fhir_resources-61"><span class="linenos">61</span></a>            <span class="p">},</span>
</span><span id="convert_to_patient_fhir_resources-62"><a href="#convert_to_patient_fhir_resources-62"><span class="linenos">62</span></a>        <span class="p">],</span>
</span><span id="convert_to_patient_fhir_resources-63"><a href="#convert_to_patient_fhir_resources-63"><span class="linenos">63</span></a>        <span class="s2">&quot;gender&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="convert_to_patient_fhir_resources-64"><a href="#convert_to_patient_fhir_resources-64"><span class="linenos">64</span></a>        <span class="s2">&quot;birthDate&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;birthdate&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="convert_to_patient_fhir_resources-65"><a href="#convert_to_patient_fhir_resources-65"><span class="linenos">65</span></a>        <span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="convert_to_patient_fhir_resources-66"><a href="#convert_to_patient_fhir_resources-66"><span class="linenos">66</span></a>            <span class="p">{</span>
</span><span id="convert_to_patient_fhir_resources-67"><a href="#convert_to_patient_fhir_resources-67"><span class="linenos">67</span></a>                <span class="s2">&quot;use&quot;</span><span class="p">:</span> <span class="s2">&quot;home&quot;</span><span class="p">,</span>
</span><span id="convert_to_patient_fhir_resources-68"><a href="#convert_to_patient_fhir_resources-68"><span class="linenos">68</span></a>                <span class="s2">&quot;line&quot;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;address&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
</span><span id="convert_to_patient_fhir_resources-69"><a href="#convert_to_patient_fhir_resources-69"><span class="linenos">69</span></a>                <span class="s2">&quot;city&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;city&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="convert_to_patient_fhir_resources-70"><a href="#convert_to_patient_fhir_resources-70"><span class="linenos">70</span></a>                <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="convert_to_patient_fhir_resources-71"><a href="#convert_to_patient_fhir_resources-71"><span class="linenos">71</span></a>                <span class="s2">&quot;postalCode&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;zip&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="convert_to_patient_fhir_resources-72"><a href="#convert_to_patient_fhir_resources-72"><span class="linenos">72</span></a>            <span class="p">}</span>
</span><span id="convert_to_patient_fhir_resources-73"><a href="#convert_to_patient_fhir_resources-73"><span class="linenos">73</span></a>        <span class="p">],</span>
</span><span id="convert_to_patient_fhir_resources-74"><a href="#convert_to_patient_fhir_resources-74"><span class="linenos">74</span></a>    <span class="p">}</span>
</span><span id="convert_to_patient_fhir_resources-75"><a href="#convert_to_patient_fhir_resources-75"><span class="linenos">75</span></a>
</span><span id="convert_to_patient_fhir_resources-76"><a href="#convert_to_patient_fhir_resources-76"><span class="linenos">76</span></a>    <span class="n">fhir_bundle</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="convert_to_patient_fhir_resources-77"><a href="#convert_to_patient_fhir_resources-77"><span class="linenos">77</span></a>        <span class="s2">&quot;resourceType&quot;</span><span class="p">:</span> <span class="s2">&quot;Bundle&quot;</span><span class="p">,</span>
</span><span id="convert_to_patient_fhir_resources-78"><a href="#convert_to_patient_fhir_resources-78"><span class="linenos">78</span></a>        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
</span><span id="convert_to_patient_fhir_resources-79"><a href="#convert_to_patient_fhir_resources-79"><span class="linenos">79</span></a>        <span class="s2">&quot;entry&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">patient_resource</span><span class="p">],</span>
</span><span id="convert_to_patient_fhir_resources-80"><a href="#convert_to_patient_fhir_resources-80"><span class="linenos">80</span></a>    <span class="p">}</span>
</span><span id="convert_to_patient_fhir_resources-81"><a href="#convert_to_patient_fhir_resources-81"><span class="linenos">81</span></a>
</span><span id="convert_to_patient_fhir_resources-82"><a href="#convert_to_patient_fhir_resources-82"><span class="linenos">82</span></a>    <span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;iris_id&quot;</span><span class="p">],</span> <span class="n">fhir_bundle</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Converts and returns a row of patient data into patient resource in a FHIR bundle
with a newly generated id as well as the <code>iris_id</code>.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>data</strong>:  Dictionary of patient data that optionionally includes the following
fields: mrn, ssn, first_name, middle_name, last_name, home_phone, cell-phone, sex,
birthdate, address, city, state, zip.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Tuple of the <code>iris_id</code> and FHIR bundle.</p>
</blockquote>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>